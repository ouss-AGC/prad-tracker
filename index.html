<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAD | Suivi de Projet Interactif</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* High-Tech Defense Palette (Inspired by stad26.manus.space) */
            --navy-deep: #001f3f;
            --navy-primary: #000f2d;
            --red-accent: #e60000;
            --bg-light: #ffffff;
            --bg-gray: #f8f9fa;
            --border-tech: #d1d5db;
            --text-dark: #001f3f;
            --text-dim: #6b7280;
            --white: #ffffff;

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-tech: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-gray);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
        }

        /* Tactical Background Effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 60%, rgba(0, 31, 63, 0.05) 100%);
            pointer-events: none;
            z-index: 1000;
        }

        /* login Overlay */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--navy-primary);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: var(--transition);
        }

        .auth-card {
            background: var(--white);
            border-top: 5px solid var(--red-accent);
            padding: 3rem;
            border-radius: 0;
            width: 450px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .auth-card h1 {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: var(--navy-deep);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .pin-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .pin-digit {
            width: 42px;
            height: 54px;
            background: var(--bg-gray);
            border: 1px solid var(--border-tech);
            border-radius: 0;
            color: var(--navy-deep);
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            transition: var(--transition);
        }

        .pin-digit:focus {
            border-color: var(--red-accent);
            box-shadow: none;
            background: var(--white);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            border-radius: 0;
            border: none;
            background: var(--red-accent);
            color: var(--white);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .auth-btn:hover {
            background: #cc0000;
            transform: scale(1.02);
        }

        /* Layout */
        #app-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1rem;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        #app-container.visible {
            opacity: 1;
        }

        header {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--navy-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .logo-area h1 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-area h1::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--red-accent);
            display: inline-block;
        }

        .mode-badge {
            padding: 8px 20px;
            border-radius: 0;
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--white);
        }

        .mode-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px currentColor;
            animation: pulse 1.5s infinite;
        }

        .mode-admin {
            border-left: 4px solid var(--red-accent);
            color: var(--red-accent);
        }

        .mode-team {
            border-left: 4px solid #2f81f7;
            color: #2f81f7;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.4;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        .content-panel {
            background: var(--white);
            border: 1px solid var(--border-tech);
            border-radius: 0;
            padding: 2rem;
            position: relative;
            box-shadow: var(--shadow-tech);
        }

        /* Tactical corners */
        .content-panel::after {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 20px;
            height: 20px;
            border-top: 2px solid var(--red-accent);
            border-left: 2px solid var(--red-accent);
            pointer-events: none;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 800;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--navy-deep);
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--bg-gray);
            padding-bottom: 0.75rem;
        }

        .panel-title i {
            color: var(--red-accent);
        }

        /* Form styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        input,
        textarea,
        select {
            width: 100%;
            background: var(--bg-gray);
            border: 1px solid var(--border-tech);
            border-radius: 0;
            padding: 12px 16px;
            color: var(--text-dark);
            outline: none;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        input:focus,
        textarea:focus {
            border-color: var(--red-accent);
            background: var(--white);
            box-shadow: none;
        }

        /* Tables */
        .table-container {
            border: 1px solid var(--border-tech);
            border-radius: 0;
            overflow: hidden;
            background: var(--white);
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 14px 20px;
            color: var(--white);
            font-size: 0.75rem;
            background: var(--navy-deep);
            border-bottom: 2px solid var(--red-accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-tech);
            font-size: 0.9rem;
            background: var(--white);
        }

        tr:last-child td {
            border-bottom: none;
        }

        td:first-child {
            border-left: none;
            border-radius: 0;
        }

        td:last-child {
            border-right: none;
            border-radius: 0;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: var(--transition);
        }

        .btn-icon:hover {
            color: var(--accent-blue);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-icon.delete:hover {
            color: var(--accent-red);
        }

        /* Gantt Viz */
        .gantt-chart {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 1rem;
            background: var(--bg-gray);
        }

        .gantt-row {
            display: flex;
            align-items: center;
            height: 35px;
            gap: 20px;
        }

        .gantt-label {
            width: 180px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--navy-deep);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gantt-bar-bg {
            flex-grow: 1;
            height: 14px;
            background: var(--white);
            border: 1px solid var(--border-tech);
            border-radius: 0;
            position: relative;
        }

        .gantt-bar-fill {
            height: 100%;
            border-radius: 0;
            background: var(--navy-deep);
            border-left: 3px solid var(--red-accent);
            position: absolute;
            top: 0;
            left: 0;
            min-width: 5px;
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            background: var(--white);
            border: 2px solid var(--navy-deep);
            border-radius: 0;
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.1);
            padding: 0;
            z-index: 2000;
            display: none;
            min-width: 200px;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            color: var(--navy-deep);
            border-bottom: 1px solid var(--bg-gray);
        }

        .menu-item:hover {
            background: var(--red-accent);
            color: var(--white);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            width: 700px;
            max-height: 85vh;
            border-radius: 0;
            border-top: 8px solid var(--red-accent);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.4);
        }

        .file-list {
            overflow-y: auto;
            margin-top: 1rem;
            flex-grow: 1;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 14px;
            border-radius: 0;
            margin-bottom: 2px;
            background: var(--bg-gray);
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .file-item:hover {
            background: #eef2f7;
            border-left-color: var(--border-tech);
        }

        .file-item.selected {
            border-left-color: var(--red-accent);
            background: #fff5f5;
        }

        /* Linked Files */
        .linked-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .file-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-tag i {
            cursor: pointer;
            color: var(--accent-red);
        }

        /* Toolbar */
        .toolbar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 500;
        }

        .tool-btn {
            background: var(--navy-deep);
            border: none;
            color: var(--white);
            padding: 14px 24px;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: var(--transition);
            font-size: 0.8rem;
            box-shadow: 10px 10px 30px rgba(0, 0, 0, 0.2);
        }

        .tool-btn:hover {
            background: var(--red-accent);
            transform: translateY(-5px);
        }

        [data-readonly="true"] .admin-only {
            display: none !important;
        }

        [data-readonly="true"] input,
        [data-readonly="true"] textarea,
        [data-readonly="true"] select {
            pointer-events: none;
            border-color: transparent;
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body data-readonly="false">

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-card">
            <h1>Accès Projet PRAD</h1>
            <p style="color: var(--text-dim); margin-bottom: 2rem;">Veuillez entrer votre Code PIN</p>
            <div class="pin-input-group">
                <input type="password" maxlength="1" class="pin-digit" data-index="0">
                <input type="password" maxlength="1" class="pin-digit" data-index="1">
                <input type="password" maxlength="1" class="pin-digit" data-index="2">
                <input type="password" maxlength="1" class="pin-digit" data-index="3">
                <input type="password" maxlength="1" class="pin-digit" data-index="4">
                <input type="password" maxlength="1" class="pin-digit" data-index="5">
            </div>
            <button class="auth-btn" onclick="checkPin()">Se Connecter</button>
            <p id="auth-error"
                style="color: var(--accent-red); margin-top: 1rem; font-size: 0.9rem; visibility: hidden;">Code PIN
                incorrect</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container">
        <header>
            <div class="logo-area">
                <h1>PRAD <span style="font-weight: 300; color: var(--text-dim)">TRACKER</span></h1>
            </div>
            <div id="status-badge" class="mode-badge mode-team">
                <i class="fas fa-lock"></i> Chargement...
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Section 1: Infos Générales -->
            <div class="content-panel" style="grid-column: span 8;">
                <div class="panel-title">Informations Générales <i class="fas fa-info-circle"></i></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label>Titre du Projet</label>
                        <input type="text" id="project-title" placeholder="Ex: Recherche IA Défense"
                            oninput="saveData()">
                    </div>
                    <div class="form-group">
                        <label>Code Projet</label>
                        <input type="text" id="project-code" placeholder="PRAD-2024-001" oninput="saveData()">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label>Date de Début</label>
                        <input type="date" id="start-date" oninput="saveData()">
                    </div>
                    <div class="form-group">
                        <label>Date de Fin</label>
                        <input type="date" id="end-date" oninput="saveData()">
                    </div>
                    <div class="form-group">
                        <label>Durée (mois)</label>
                        <input type="number" id="duration" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Résumé du Projet</label>
                    <textarea id="project-summary" rows="3" oninput="saveData()"></textarea>
                </div>
            </div>

            <!-- Section 2: Chef de Projet -->
            <div class="content-panel" style="grid-column: span 4;">
                <div class="panel-title">Chef de Projet <i class="fas fa-user-tie"></i></div>
                <div class="form-group">
                    <label>Nom Complet</label>
                    <input type="text" id="pm-name" oninput="saveData()">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="pm-email" oninput="saveData()">
                </div>
                <div class="form-group">
                    <label>Organisme</label>
                    <input type="text" id="pm-org" oninput="saveData()">
                </div>
            </div>

            <!-- Section 3: Comité de Pilotage -->
            <div class="content-panel" style="grid-column: span 12;">
                <div class="panel-title">
                    Comité de Pilotage
                    <button class="btn-icon admin-only" onclick="addRow('copil-table')"><i
                            class="fas fa-plus-circle"></i></button>
                </div>
                <div class="table-container">
                    <table id="copil-table">
                        <thead>
                            <tr>
                                <th style="width: 30%">Nom</th>
                                <th style="width: 30%">Rôle / Fonction</th>
                                <th style="width: 30%">E-mail</th>
                                <th class="admin-only" style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Section 4: Work Packages -->
            <div class="content-panel" style="grid-column: span 12;">
                <div class="panel-title">
                    Work Packages & Livrables
                    <button class="btn-icon admin-only" onclick="addRow('wp-table')"><i
                            class="fas fa-plus-circle"></i></button>
                </div>
                <div class="table-container">
                    <table id="wp-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">Titre du WP / Tâche</th>
                                <th style="width: 15%">Dates (Début - Fin)</th>
                                <th style="width: 15%">Avancement</th>
                                <th style="width: 20%">Livrables</th>
                                <th style="width: 20%">Documents de Preuve</th>
                                <th class="admin-only" style="width: 5%">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Section 5: Gantt Visualization -->
            <div class="content-panel" style="grid-column: span 12;">
                <div class="panel-title">Vue d'ensemble Temporelle (Gantt) <i class="fas fa-chart-gantt"></i></div>
                <div id="gantt-container" class="gantt-chart">
                    <!-- Dynamic rendering -->
                </div>
            </div>

            <!-- Section 6: Réunions -->
            <div class="content-panel" style="grid-column: span 12; margin-bottom: 5rem;">
                <div class="panel-title">
                    Réunions d'Évaluation Trimestrielles
                    <button class="btn-icon admin-only" onclick="addRow('meeting-table')"><i
                            class="fas fa-plus-circle"></i></button>
                </div>
                <div class="table-container">
                    <table id="meeting-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">Date</th>
                                <th style="width: 25%">Objet</th>
                                <th style="width: 50%">Décisions Clés / PV</th>
                                <th class="admin-only" style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Cloud Sync Settings (Admin Only) -->
            <div id="cloud-sync-panel" class="content-panel admin-only"
                style="grid-column: span 12; margin-bottom: 8rem; display: none;">
                <div class="panel-title">Configuration Cloud Sync <i class="fas fa-cloud-upload-alt"></i></div>
                <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1.5rem;">Connectez votre repository
                    GitHub pour synchroniser les données avec l'équipe.</p>
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div class="form-group" style="flex-grow: 1;">
                        <label>GitHub Personal Access Token (PAT)</label>
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <button class="auth-btn" onclick="syncToCloud()" id="btn-sync-cloud">
                            <i class="fas fa-sync"></i> Synchroniser maintenant
                        </button>
                    </div>
                </div>
                <p id="sync-status" style="font-size: 0.8rem; margin-top: 0.5rem;"></p>
            </div>
        </div>

        <div class="toolbar">
            <button class="tool-btn admin-only" onclick="toggleCloudPanel()">
                <i class="fas fa-cloud"></i> Cloud Sync
            </button>
            <button class="tool-btn admin-only" onclick="exportData()">
                <i class="fas fa-download"></i> Exporter
            </button>
            <button class="tool-btn admin-only" onclick="document.getElementById('import-file').click()">
                <i class="fas fa-upload"></i> Importer
            </button>
            <input type="file" id="import-file" style="display: none" onchange="importData(event)">
            <button class="tool-btn" onclick="location.reload()">
                <i class="fas fa-sync"></i> Rafraîchir
            </button>
        </div>
    </div>

    <!-- Modal for GitHub Files -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <div class="panel-title" style="margin-bottom: 0.5rem;">
                Documents GitHub
                <button class="btn-icon" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-dim);">Sélectionnez les documents à associer</p>
            <div class="file-list" id="github-file-list">
                <!-- Loaded from API -->
            </div>
            <button class="auth-btn" style="margin-top: 1.5rem;" onclick="confirmSelection()">Associer les fichiers
                sélectionnés</button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="menu-item" onclick="handleContextMenuAction('above')"><i class="fas fa-arrow-up"></i> Insérer dessus
        </div>
        <div class="menu-item" onclick="handleContextMenuAction('below')"><i class="fas fa-arrow-down"></i> Insérer
            dessous</div>
        <div class="menu-item" onclick="handleContextMenuAction('duplicate')"><i class="fas fa-copy"></i> Dupliquer
        </div>
        <hr style="border: 0.5px solid var(--glass-border); margin: 4px 0;">
        <div class="menu-item" style="color: var(--accent-red)" onclick="handleContextMenuAction('delete')"><i
                class="fas fa-trash"></i> Supprimer</div>
    </div>

    <script>
        const PIN_ADMIN = "085301";
        const PIN_TEAM = "0331";
        const GITHUB_REPO = "ouss-AGC/prad-documents";

        let currentState = {
            general: {},
            pm: {},
            committee: [],
            wp: [],
            meetings: []
        };

        const DATA_FILE_PATH = "prad_project_tracking.json";
        let githubSha = null; // Store SHA for updates

        let activeMode = 'team'; // 'admin' or 'team'
        let selectedWpIndex = -1;
        let contextTarget = null;
        let availableFiles = [];
        let tempSelectedFiles = [];

        // --- Auth Logic ---
        const pinDigits = document.querySelectorAll('.pin-digit');
        pinDigits.forEach((digit, idx) => {
            digit.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && idx < 5) {
                    pinDigits[idx + 1].focus();
                }
                if (idx === 5 || (idx === 3 && activeMode === 'team')) {
                    // checkPin() is called by button or auto-checked if filled
                }
            });
            digit.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && idx > 0) {
                    pinDigits[idx - 1].focus();
                }
            });
        });

        function checkPin() {
            const entered = Array.from(pinDigits).map(d => d.value).join('');
            const errorMsg = document.getElementById('auth-error');

            if (entered === PIN_ADMIN) {
                activeMode = 'admin';
                unlockApp();
            } else if (entered.substring(0, 4) === PIN_TEAM) {
                activeMode = 'team';
                unlockApp();
            } else {
                errorMsg.style.visibility = 'visible';
                pinDigits.forEach(d => d.value = '');
                pinDigits[0].focus();
            }
        }

        function unlockApp() {
            document.getElementById('auth-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-container').classList.add('visible');
                setupApp();
            }, 300);
        }

        function setupApp() {
            document.body.setAttribute('data-readonly', activeMode === 'team');
            const badge = document.getElementById('status-badge');
            if (activeMode === 'admin') {
                badge.className = 'mode-badge mode-admin';
                badge.innerHTML = '<i class="fas fa-unlock"></i> Mode Admin';
            } else {
                badge.className = 'mode-badge mode-team';
                badge.innerHTML = '<i class="fas fa-lock"></i> Mode Équipe';
            }
            loadData();
            fetchGitHubFiles();
            fetchDataFromCloud(); // Try to load from shared cloud file
        }

        function toggleCloudPanel() {
            const p = document.getElementById('cloud-sync-panel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
            if (p.style.display === 'block') {
                document.getElementById('github-token').value = localStorage.getItem('github_pat') || '';
            }
        }

        async function fetchDataFromCloud() {
            const badge = document.getElementById('status-badge');
            const originalHtml = badge.innerHTML;
            badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sync Cloud...';

            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_FILE_PATH}`);
                if (response.ok) {
                    const data = await response.json();
                    githubSha = data.sha;
                    // Remove potential newlines from base64 string
                    const content = JSON.parse(atob(data.content.replace(/\n/g, '')));

                    // Merge/Override local with cloud
                    currentState = content;
                    localStorage.setItem('prad_data', JSON.stringify(currentState));
                    loadData(); // Re-render everything
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> Cloud Sync OK';
                } else {
                    badge.innerHTML = originalHtml;
                }
            } catch (err) {
                console.error("Fetch Cloud Error:", err);
                badge.innerHTML = originalHtml;
            }
        }

        async function syncToCloud() {
            const token = document.getElementById('github-token').value;
            if (!token) {
                alert("Veuillez entrer un GitHub Token (PAT)");
                return;
            }
            localStorage.setItem('github_pat', token);

            const status = document.getElementById('sync-status');
            const btn = document.getElementById('btn-sync-cloud');

            status.innerText = "Synchronisation en cours...";
            status.style.color = "var(--text-dim)";
            btn.disabled = true;

            try {
                // Ensure we have the latest SHA before pushing
                const checkResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_FILE_PATH}`);
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    githubSha = checkData.sha;
                }

                const body = {
                    message: "Update project data from PRAD Tracker",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentState, null, 2)))),
                    sha: githubSha || undefined
                };

                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const result = await response.json();
                    githubSha = result.content.sha;
                    status.innerText = "Synchronisation réussie ! Les données sont à jour sur GitHub.";
                    status.style.color = "var(--accent-green)";
                    fetchDataFromCloud(); // Refresh badge
                } else {
                    const errData = await response.json();
                    status.innerText = "Erreur: " + (errData.message || "Échec de synchronisation");
                    status.style.color = "var(--accent-red)";
                }
            } catch (err) {
                status.innerText = "Erreur réseau: " + err.message;
                status.style.color = "var(--accent-red)";
            } finally {
                btn.disabled = false;
            }
        }

        // --- Data Persistence ---
        function saveData() {
            if (activeMode === 'team') return;

            currentState.general = {
                title: document.getElementById('project-title').value,
                code: document.getElementById('project-code').value,
                start: document.getElementById('start-date').value,
                end: document.getElementById('end-date').value,
                summary: document.getElementById('project-summary').value
            };

            currentState.pm = {
                name: document.getElementById('pm-name').value,
                email: document.getElementById('pm-email').value,
                org: document.getElementById('pm-org').value
            };

            // Table data
            currentState.committee = Array.from(document.querySelectorAll('#copil-table tbody tr')).map(tr => ({
                name: tr.cells[0].querySelector('input').value,
                role: tr.cells[1].querySelector('input').value,
                email: tr.cells[2].querySelector('input').value
            }));

            currentState.wp = Array.from(document.querySelectorAll('#wp-table tbody tr')).map(tr => ({
                title: tr.cells[0].querySelector('input').value,
                start: tr.cells[1].querySelectorAll('input')[0].value,
                end: tr.cells[1].querySelectorAll('input')[1].value,
                progress: tr.cells[2].querySelector('input').value,
                deliverables: tr.cells[3].querySelector('textarea').value,
                files: JSON.parse(tr.getAttribute('data-files') || '[]')
            }));

            currentState.meetings = Array.from(document.querySelectorAll('#meeting-table tbody tr')).map(tr => ({
                date: tr.cells[0].querySelector('input').value,
                subject: tr.cells[1].querySelector('input').value,
                decisions: tr.cells[2].querySelector('textarea').value
            }));

            localStorage.setItem('prad_data', JSON.stringify(currentState));
            calculateDuration();
            renderGantt();
        }

        function loadData() {
            const saved = localStorage.getItem('prad_data');
            if (saved) {
                currentState = JSON.parse(saved);

                // General
                document.getElementById('project-title').value = currentState.general.title || '';
                document.getElementById('project-code').value = currentState.general.code || '';
                document.getElementById('start-date').value = currentState.general.start || '';
                document.getElementById('end-date').value = currentState.general.end || '';
                document.getElementById('project-summary').value = currentState.general.summary || '';

                // PM
                document.getElementById('pm-name').value = currentState.pm.name || '';
                document.getElementById('pm-email').value = currentState.pm.email || '';
                document.getElementById('pm-org').value = currentState.pm.org || '';

                // Tables
                document.querySelector('#copil-table tbody').innerHTML = '';
                (currentState.committee || []).forEach(row => addRow('copil-table', row));

                document.querySelector('#wp-table tbody').innerHTML = '';
                (currentState.wp || []).forEach(row => addRow('wp-table', row));

                document.querySelector('#meeting-table tbody').innerHTML = '';
                (currentState.meetings || []).forEach(row => addRow('meeting-table', row));

                if (activeMode === 'admin') {
                    if (!currentState.committee?.length) addRow('copil-table');
                    if (!currentState.wp?.length) addRow('wp-table');
                    if (!currentState.meetings?.length) addRow('meeting-table');
                }
            } else {
                if (activeMode === 'admin') {
                    addRow('copil-table');
                    addRow('wp-table');
                    addRow('meeting-table');
                }
            }
            calculateDuration();
            renderGantt();
        }

        function calculateDuration() {
            const start = new Date(document.getElementById('start-date').value);
            const end = new Date(document.getElementById('end-date').value);
            if (start && end && !isNaN(start) && !isNaN(end)) {
                const diff = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
                document.getElementById('duration').value = diff > 0 ? diff : 0;
            }
        }

        // --- Table Management ---
        function addRow(tableId, data = null) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const tr = document.createElement('tr');

            if (tableId === 'copil-table') {
                tr.innerHTML = `
                    <td><input type="text" value="${data?.name || ''}" oninput="saveData()" placeholder="..."></td>
                    <td><input type="text" value="${data?.role || ''}" oninput="saveData()" placeholder="..."></td>
                    <td><input type="email" value="${data?.email || ''}" oninput="saveData()" placeholder="..."></td>
                    <td class="admin-only"><button class="btn-icon delete" onclick="deleteRow(this)"><i class="fas fa-trash-alt"></i></button></td>
                `;
            } else if (tableId === 'wp-table') {
                tr.setAttribute('data-files', JSON.stringify(data?.files || []));
                tr.innerHTML = `
                    <td><input type="text" value="${data?.title || ''}" oninput="saveData()" placeholder="Titre du WP"></td>
                    <td>
                        <input type="date" value="${data?.start || ''}" oninput="saveData()" style="padding: 5px; font-size: 0.7rem;">
                        <input type="date" value="${data?.end || ''}" oninput="saveData()" style="padding: 5px; font-size: 0.7rem; margin-top: 5px;">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="range" value="${data?.progress || 0}" min="0" max="100" oninput="this.nextElementSibling.innerText = this.value + '%'; saveData()">
                            <span style="font-size: 0.8rem; width: 35px;">${data?.progress || 0}%</span>
                        </div>
                    </td>
                    <td><textarea oninput="saveData()" style="font-size: 0.75rem;">${data?.deliverables || ''}</textarea></td>
                    <td>
                        <div class="linked-files">${renderFileTags(data?.files || [])}</div>
                        <button class="btn-icon admin-only" onclick="openFileModal(this)" title="Joindre"><i class="fas fa-paperclip"></i></button>
                    </td>
                    <td class="admin-only"><button class="btn-icon delete" onclick="deleteRow(this)"><i class="fas fa-trash-alt"></i></button></td>
                `;
            } else if (tableId === 'meeting-table') {
                tr.innerHTML = `
                    <td><input type="date" value="${data?.date || ''}" oninput="saveData()"></td>
                    <td><input type="text" value="${data?.subject || ''}" oninput="saveData()"></td>
                    <td><textarea oninput="saveData()">${data?.decisions || ''}</textarea></td>
                    <td class="admin-only"><button class="btn-icon delete" onclick="deleteRow(this)"><i class="fas fa-trash-alt"></i></button></td>
                `;
            }

            tr.addEventListener('contextmenu', e => {
                if (activeMode === 'admin') {
                    e.preventDefault();
                    showContextMenu(e, tr);
                }
            });

            tbody.appendChild(tr);
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            saveData();
        }

        function renderFileTags(files) {
            return files.map(f => `
                <div class="file-tag">
                    <span onclick="window.open('${f.url}', '_blank')">${f.name}</span>
                    <i class="fas fa-eye" style="color: var(--primary); font-size: 0.6rem;" onclick="window.open('${f.url}', '_blank')"></i>
                    <i class="fas fa-times admin-only" onclick="removeFileAssociation(this, '${f.name}')"></i>
                </div>
            `).join('');
        }

        // --- Context Menu ---
        function showContextMenu(e, tr) {
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            contextTarget = tr;

            document.onclick = () => menu.style.display = 'none';
        }

        function handleContextMenuAction(action) {
            if (!contextTarget) return;
            const tableId = contextTarget.closest('table').id;
            const rowIndex = Array.from(contextTarget.parentElement.children).indexOf(contextTarget);

            if (action === 'delete') {
                contextTarget.remove();
            } else if (action === 'above' || action === 'below') {
                const tr = contextTarget.cloneNode(true);
                // Clear inputs in clone
                tr.querySelectorAll('input, textarea').forEach(i => i.value = '');
                tr.querySelectorAll('.linked-files').forEach(d => d.innerHTML = '');
                tr.setAttribute('data-files', '[]');

                // Re-attach listeners
                tr.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    showContextMenu(e, tr);
                });

                if (action === 'above') contextTarget.parentElement.insertBefore(tr, contextTarget);
                else contextTarget.parentElement.insertBefore(tr, contextTarget.nextSibling);
            } else if (action === 'duplicate') {
                const tr = contextTarget.cloneNode(true);
                // Sync input values (cloneNode doesn't copy current input values)
                const originalInputs = contextTarget.querySelectorAll('input, textarea');
                const clonedInputs = tr.querySelectorAll('input, textarea');
                originalInputs.forEach((oi, idx) => clonedInputs[idx].value = oi.value);

                tr.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    showContextMenu(e, tr);
                });
                contextTarget.parentElement.insertBefore(tr, contextTarget.nextSibling);
            }
            saveData();
            document.getElementById('context-menu').style.display = 'none';
        }

        // --- GitHub Integration ---
        async function fetchGitHubFiles() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    availableFiles = data.filter(f => f.type === 'file').map(f => ({
                        name: f.name,
                        url: f.download_url
                    }));
                }
            } catch (err) {
                console.error("Erreur GitHub API:", err);
            }
        }

        function openFileModal(btn) {
            const tr = btn.closest('tr');
            selectedWpIndex = Array.from(tr.parentElement.children).indexOf(tr);
            const currentFiles = JSON.parse(tr.getAttribute('data-files') || '[]');
            tempSelectedFiles = [...currentFiles];

            renderModalFileList();
            document.getElementById('file-modal').style.display = 'flex';
        }

        function renderModalFileList() {
            const container = document.getElementById('github-file-list');
            container.innerHTML = availableFiles.map(f => {
                const isSelected = tempSelectedFiles.some(tf => tf.name === f.name);
                return `
                    <div class="file-item ${isSelected ? 'selected' : ''}" onclick="toggleFileSelection('${f.name}')">
                        <i class="far ${getFileIcon(f.name)}" style="margin-right: 15px; color: var(--primary)"></i>
                        <span style="flex-grow: 1">${f.name}</span>
                        ${isSelected ? '<i class="fas fa-check-circle" style="color: var(--primary)"></i>' : ''}
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.pdf')) return 'fa-file-pdf';
            if (filename.endsWith('.xlsx')) return 'fa-file-excel';
            if (filename.endsWith('.pptx')) return 'fa-file-powerpoint';
            return 'fa-file-alt';
        }

        function toggleFileSelection(filename) {
            const file = availableFiles.find(f => f.name === filename);
            const idx = tempSelectedFiles.findIndex(f => f.name === filename);
            if (idx > -1) tempSelectedFiles.splice(idx, 1);
            else tempSelectedFiles.push(file);
            renderModalFileList();
        }

        function confirmSelection() {
            const tr = document.querySelectorAll('#wp-table tbody tr')[selectedWpIndex];
            tr.setAttribute('data-files', JSON.stringify(tempSelectedFiles));
            tr.querySelector('.linked-files').innerHTML = renderFileTags(tempSelectedFiles);
            saveData();
            closeModal();
        }

        function removeFileAssociation(icon, filename) {
            const tr = icon.closest('tr');
            let files = JSON.parse(tr.getAttribute('data-files') || '[]');
            files = files.filter(f => f.name !== filename);
            tr.setAttribute('data-files', JSON.stringify(files));
            tr.querySelector('.linked-files').innerHTML = renderFileTags(files);
            saveData();
        }

        function closeModal() {
            document.getElementById('file-modal').style.display = 'none';
        }

        // --- Gantt Rendering ---
        function renderGantt() {
            const container = document.getElementById('gantt-container');
            container.innerHTML = '';

            const pStart = new Date(document.getElementById('start-date').value);
            const pEnd = new Date(document.getElementById('end-date').value);

            if (isNaN(pStart) || isNaN(pEnd)) return;

            const totalWidth = pEnd - pStart;

            currentState.wp.forEach(wp => {
                if (!wp.title) return;
                const wStart = new Date(wp.start);
                const wEnd = new Date(wp.end);

                if (isNaN(wStart) || isNaN(wEnd)) return;

                const left = ((wStart - pStart) / totalWidth) * 100;
                const width = ((wEnd - wStart) / totalWidth) * 100;

                const row = document.createElement('div');
                row.className = 'gantt-row';
                row.innerHTML = `
                    <div class="gantt-label">${wp.title}</div>
                    <div class="gantt-bar-bg">
                        <div class="gantt-bar-fill" style="left: ${left}%; width: ${width}%; opacity: ${0.4 + (wp.progress / 100) * 0.6}"></div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // --- Export / Import ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentState, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const date = new Date().toISOString().split('T')[0];
            downloadAnchorNode.setAttribute("download", `PRAD_Backup_${date}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('prad_data', JSON.stringify(data));
                    location.reload();
                } catch (err) {
                    alert("Erreur lors de l'importation du fichier JSON.");
                }
            };
            reader.readAsText(file);
        }

        // Focus first PIN box
        window.onload = () => pinDigits[0].focus();

    </script>
</body>

</html>