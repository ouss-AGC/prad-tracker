<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Description et de Suivi d'Avancement de Projet PRAD A12P1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Row/Column Selection Modal */
        .row-col-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9000;
        }

        .row-col-modal.show {
            display: flex;
        }

        .row-col-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .row-col-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a3a5c;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .row-col-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .row-col-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .row-col-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .row-col-item:hover {
            background: #f5f5f5;
        }

        .row-col-item:last-child {
            border-bottom: none;
        }

        .row-col-item.selected {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .row-col-item-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .row-col-item-index {
            background: #1a3a5c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .row-col-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .row-col-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .row-col-btn.delete {
            background: #dc3545;
            color: white;
        }

        .row-col-btn.delete:hover {
            background: #c82333;
        }

        .row-col-btn.add {
            background: #28a745;
            color: white;
        }

        .row-col-btn.add:hover {
            background: #218838;
        }

        .row-col-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .row-col-position {
            margin-bottom: 15px;
        }

        .row-col-position label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .row-col-position select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Document Viewer Modal */
        .doc-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9500;
        }

        .doc-viewer-modal.show {
            display: flex;
        }

        .doc-viewer-content {
            background: white;
            width: 95%;
            height: 95%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .doc-viewer-header {
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doc-viewer-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doc-viewer-title .file-icon {
            font-size: 1.5rem;
        }

        .doc-viewer-actions {
            display: flex;
            gap: 10px;
        }

        .doc-viewer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }

        .doc-viewer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .doc-viewer-btn.close-btn {
            background: #dc3545;
        }

        .doc-viewer-btn.close-btn:hover {
            background: #c82333;
        }

        .doc-viewer-body {
            flex: 1;
            overflow: hidden;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .doc-viewer-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .doc-viewer-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .doc-viewer-body .no-preview {
            text-align: center;
            padding: 40px;
        }

        .doc-viewer-body .no-preview .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #666;
        }

        .doc-viewer-sidebar {
            width: 250px;
            background: #f8f9fa;
            border-left: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
        }

        .doc-list-title {
            font-weight: 600;
            color: #1a3a5c;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a3a5c;
        }

        .doc-list-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            background: white;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .doc-list-item:hover {
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .doc-list-item.active {
            border-color: #1a3a5c;
            background: #e8eef4;
        }

        .doc-list-item-name {
            font-size: 0.85rem;
            font-weight: 500;
            word-break: break-all;
        }

        .doc-list-item-size {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }

        /* Admin PIN Modal */
        .admin-pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9800;
        }

        .admin-pin-modal.show {
            display: flex;
        }

        .admin-pin-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .admin-pin-title {
            color: #1a3a5c;
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .admin-pin-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .admin-pin-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            letter-spacing: 10px;
            margin-bottom: 15px;
        }

        .admin-pin-input:focus {
            border-color: #1a3a5c;
            outline: none;
        }

        .admin-pin-error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none;
        }

        .admin-pin-error.show {
            display: block;
        }

        .admin-pin-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .admin-pin-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .admin-pin-btn.confirm {
            background: #1a3a5c;
            color: white;
        }

        .admin-pin-btn.cancel {
            background: #6c757d;
            color: white;
        }

        /* File Storage Export Styles */
        .file-export-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-export-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-doc-btn {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .export-doc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .export-doc-btn.import {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }

        .export-doc-btn.import:hover {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .file-stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .file-stats-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-stats-item:last-child {
            border-bottom: none;
        }

        /* PIN Security Overlay */
        .pin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .pin-container {
            background: white;
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .pin-logo {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .pin-title {
            color: #1a3a5c;
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .pin-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .pin-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .pin-input {
            width: 50px;
            height: 60px;
            font-size: 1.8rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .pin-input:focus {
            border-color: #2d5a87;
            box-shadow: 0 0 10px rgba(45, 90, 135, 0.3);
        }

        .pin-single-input {
            width: 200px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
            letter-spacing: 15px;
            padding-left: 20px;
            background: #fffef5;
        }

        .pin-single-input:focus {
            border-color: #2d5a87;
            box-shadow: 0 0 10px rgba(45, 90, 135, 0.3);
        }

        .pin-single-input.error {
            border-color: #e74c3c;
            animation: shake 0.5s;
        }

        .pin-input.error {
            border-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .pin-error-message {
            color: #dc3545;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none;
        }

        .pin-error-message.show {
            display: block;
        }

        /* Access Mode Tabs */
        .access-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-tab:hover {
            border-color: #1a365d;
            background: #e8f0fe;
        }

        .mode-tab.active {
            border-color: #1a365d;
            background: #1a365d;
            color: white;
        }

        .pin-section {
            display: none;
        }

        .pin-section.active {
            display: block;
        }

        .admin-submit {
            background: linear-gradient(135deg, #8b0000 0%, #dc143c 100%);
        }

        .admin-submit:hover {
            background: linear-gradient(135deg, #6b0000 0%, #b01030 100%);
        }

        /* Read-only mode indicator */
        .readonly-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 8px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 9999;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .readonly-banner.show {
            display: block;
        }

        body.readonly-mode .readonly-banner {
            display: block;
        }

        body.readonly-mode #mainContent {
            padding-top: 50px;
        }

        /* Hide edit controls in readonly mode */
        body.readonly-mode .pin-settings-btn,
        body.readonly-mode .table-controls,
        body.readonly-mode .upload-btn,
        body.readonly-mode .milestone-controls,
        body.readonly-mode .gantt-milestone-controls,
        body.readonly-mode .milestone-list,
        body.readonly-mode .file-storage-section,
        body.readonly-mode .milestone-delete-btn,
        body.readonly-mode .milestone-lock-btn,
        body.readonly-mode .milestone-color,
        body.readonly-mode .milestone-name,
        body.readonly-mode .milestone-date,
        body.readonly-mode #addMilestoneBtn,
        body.readonly-mode .validate-btn,
        body.readonly-mode .validate-button,
        body.readonly-mode .import-label,
        body.readonly-mode .storage-export-btn,
        body.readonly-mode .import-btn,
        body.readonly-mode [onclick*="importData"],
        body.readonly-mode .storage-import-btn,
        body.readonly-mode .export-doc-btn.import,
        body.readonly-mode #importFileInput {
            display: none !important;
        }

        /* Access mode badge */
        .access-mode-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .access-mode-badge.admin-mode {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .access-mode-badge.team-mode {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .access-mode-badge .mode-icon {
            font-size: 1rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 8px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media print {

            .access-mode-badge,
            .readonly-banner {
                display: none !important;
            }
        }

        /* Make inputs readonly in readonly mode */
        body.readonly-mode input:not([type="checkbox"]),
        body.readonly-mode textarea,
        body.readonly-mode select {
            pointer-events: none;
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
            cursor: default;
        }

        body.readonly-mode input[type="checkbox"] {
            pointer-events: none;
        }

        /* Keep view and download buttons visible */
        body.readonly-mode .view-btn,
        body.readonly-mode .print-btn,
        body.readonly-mode .full-export-btn,
        body.readonly-mode .gantt-export-controls {
            display: inline-flex !important;
        }

        .pin-submit {
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pin-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(26, 58, 92, 0.4);
        }

        .pin-footer {
            margin-top: 25px;
            color: #999;
            font-size: 0.8rem;
        }

        .content-locked {
            display: none;
        }

        .content-unlocked {
            display: block;
        }

        /* PIN Settings Button */
        .pin-settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(26, 58, 92, 0.3);
        }

        .pin-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 58, 92, 0.4);
        }

        /* PIN Change Modal */
        .pin-change-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .pin-change-modal.active {
            display: flex;
        }

        .pin-change-container {
            background: white;
            padding: 35px 45px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
        }

        .pin-change-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .pin-change-title {
            color: #1a3a5c;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pin-change-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .pin-change-close:hover {
            color: #333;
        }

        .pin-change-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pin-change-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pin-change-label {
            color: #555;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .pin-change-input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .pin-change-input {
            width: 45px;
            height: 55px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
        }

        .pin-change-input:focus {
            border-color: #2d5a87;
            box-shadow: 0 0 8px rgba(45, 90, 135, 0.3);
        }

        .pin-change-input.error {
            border-color: #dc3545;
        }

        .pin-change-input.success {
            border-color: #28a745;
        }

        .pin-change-message {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        .pin-change-message.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .pin-change-message.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .pin-change-submit {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .pin-change-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .pin-change-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pin-strength {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .pin-strength-bar {
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            transition: background 0.3s;
        }

        .pin-strength-bar.active {
            background: #28a745;
        }

        @media print {
            .pin-settings-btn {
                display: none !important;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background-color: #2d5a87;
            border-radius: 0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background-color: transparent;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-button.active {
            background-color: white;
            color: #1a3a5c;
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background-color: #1a3a5c;
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            padding: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group.full-width {
            flex: 100%;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #1a3a5c;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2d5a87;
            box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .table-container {
            overflow-x: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #1a3a5c;
            font-size: 0.85rem;
        }

        table td input,
        table td textarea,
        table td select {
            width: 100%;
            border: none;
            padding: 5px;
            font-size: 0.9rem;
            background-color: transparent;
        }

        table td input:focus,
        table td textarea:focus,
        table td select:focus {
            outline: none;
            background-color: #f0f7ff;
        }

        .subsection {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .subsection-title {
            font-weight: 600;
            color: #2d5a87;
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trl-table {
            margin-top: 15px;
        }

        .trl-table td:first-child {
            width: 180px;
            font-weight: 500;
        }

        .trl-table td:nth-child(2) {
            width: 80px;
            text-align: center;
        }

        .trl-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(26, 58, 92, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .print-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 58, 92, 0.4);
        }

        .print-button::before {
            content: "üñ®Ô∏è ";
        }

        .manual-save-button {
            position: fixed;
            bottom: 90px;
            right: 30px;
            background: linear-gradient(135deg, #155724 0%, #28a745 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(21, 87, 36, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .manual-save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(21, 87, 36, 0.4);
        }

        .manual-save-button::before {
            content: "üíæ ";
        }

        /* Button Styles */
        .btn {
            border: none;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-1px);
        }

        .view-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .view-btn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-1px);
        }

        .add-row-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .add-row-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        }

        .remove-row-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .remove-row-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }

        .add-col-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
        }

        .add-col-btn:hover {
            background: linear-gradient(135deg, #5a32a3 0%, #4e2a8e 100%);
        }

        .table-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            min-width: 180px;
            z-index: 10000;
            display: none;
            overflow: hidden;
            animation: contextMenuFadeIn 0.15s ease-out;
        }

        @keyframes contextMenuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-header {
            padding: 10px 15px;
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: #333;
        }

        .context-menu-item:hover {
            background: #f0f7ff;
        }

        .context-menu-item.danger {
            color: #dc3545;
        }

        .context-menu-item.danger:hover {
            background: #fff5f5;
        }

        .context-menu-item .icon {
            width: 18px;
            text-align: center;
        }

        .context-menu-separator {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        /* Highlight row on right-click */
        tr.context-highlight {
            background-color: #e3f2fd !important;
            outline: 2px solid #2196f3;
        }

        /* Hide context menu in readonly mode */
        body.readonly-mode .context-menu {
            display: none !important;
        }

        .upload-cell {
            text-align: center;
            min-width: 150px;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 5px;
            font-size: 0.75rem;
            color: #666;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 0;
            border-bottom: 1px dashed #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #2d5a87;
            cursor: pointer;
        }

        .file-name:hover {
            text-decoration: underline;
        }

        .file-remove {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            padding: 0 5px;
        }

        .file-remove:hover {
            color: #c82333;
        }

        .upload-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        /* Gantt Chart Styles */
        .gantt-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }

        .gantt-chart {
            min-height: 400px;
            position: relative;
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .gantt-title {
            font-weight: 600;
            color: #1a3a5c;
            font-size: 1.1rem;
        }

        .gantt-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 3px;
        }

        .gantt-table {
            width: 100%;
            min-width: 1200px;
        }

        .gantt-table th {
            background-color: #1a3a5c;
            color: white;
            padding: 8px;
            font-size: 0.8rem;
            text-align: center;
        }

        .gantt-table td {
            padding: 8px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
        }

        .gantt-bar {
            height: 25px;
            border-radius: 4px;
            position: relative;
        }

        .gantt-bar-wp1 {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .gantt-bar-wp2 {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .gantt-bar-wp3 {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .gantt-bar-wp4 {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }

        .gantt-bar-wp5 {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
        }

        .gantt-bar-wp6 {
            background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
        }

        .gantt-cell {
            position: relative;
            min-width: 30px;
        }

        .gantt-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
        }

        /* Milestone Line Styles */
        .gantt-milestone-container {
            position: relative;
            margin-top: 20px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .gantt-milestone-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .gantt-milestone-controls label {
            font-weight: 600;
            color: #1a3a5c;
            font-size: 0.9rem;
        }

        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .milestone-item input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .milestone-item input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .milestone-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
        }

        .milestone-line {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            cursor: ew-resize;
            z-index: 10;
            transition: box-shadow 0.2s;
        }

        .milestone-line:hover {
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .milestone-line.blinking {
            animation: blink 1s ease-in-out infinite;
        }

        .milestone-line.fixed {
            animation: none;
            opacity: 0.9;
        }

        .milestone-line .milestone-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            pointer-events: none;
        }

        .milestone-line .milestone-date-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            white-space: nowrap;
            pointer-events: none;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .btn-milestone {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-milestone:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-1px);
        }

        .btn-milestone-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-milestone-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #4e555b 100%);
        }

        .milestone-delete {
            background: #dc3545;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .milestone-toggle {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .milestone-toggle.fixed {
            background: #ffc107;
            color: #333;
        }

        /* Export Buttons Styles */
        .gantt-export-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 1px solid #b8d4e3;
            flex-wrap: wrap;
            align-items: center;
        }

        .gantt-export-controls label {
            font-weight: 600;
            color: #1a3a5c;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-export:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-export:active {
            transform: translateY(0);
        }

        .btn-export-png {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .btn-export-png:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-export-svg {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .btn-export-svg:hover {
            background: linear-gradient(135deg, #5a32a3 0%, #4a2885 100%);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .btn-export-pdf {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-export-pdf:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .export-loading {
            display: none;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.85rem;
        }

        .export-loading.show {
            display: flex;
        }

        .export-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-top-color: #17a2b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-export-full-pdf {
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a87 100%);
            padding: 12px 24px;
            font-size: 0.95rem;
        }

        .btn-export-full-pdf:hover {
            background: linear-gradient(135deg, #2d5a87 0%, #3d6a97 100%);
            box-shadow: 0 4px 15px rgba(26, 58, 92, 0.4);
        }

        .full-export-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 2px solid #1a3a5c;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .full-export-container label {
            font-weight: 700;
            color: #1a3a5c;
            font-size: 1rem;
        }

        .export-progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .export-progress-overlay.show {
            display: flex;
        }

        .export-progress-box {
            background: white;
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .export-progress-box h3 {
            color: #1a3a5c;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .export-progress-bar {
            width: 300px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .export-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1a3a5c, #2d5a87, #17a2b8);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .export-progress-text {
            color: #666;
            font-size: 0.9rem;
        }

        @media print {
            .gantt-export-controls {
                display: none !important;
            }

            .full-export-container {
                display: none !important;
            }
        }

        /* Required field validation styles */
        .required-field {
            position: relative;
        }

        .required-field label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .required-field input:invalid,
        .required-field textarea:invalid,
        .required-field select:invalid,
        input.invalid,
        textarea.invalid,
        select.invalid {
            border-color: #dc3545 !important;
            background-color: #fff5f5 !important;
        }

        .required-field input:valid,
        .required-field textarea:valid,
        .required-field select:valid {
            border-color: #28a745;
        }

        .validation-error {
            color: #dc3545;
            font-size: 0.75rem;
            margin-top: 3px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        /* Modified field indicator styles */
        .field-modified {
            border-color: #ffc107 !important;
            background-color: #fffbeb !important;
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3) !important;
        }

        .modified-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background-color: #ffc107;
            border-radius: 50%;
            display: none;
            z-index: 10;
        }

        .modified-indicator.show {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Validation summary panel */
        .validation-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 15px 20px;
            z-index: 999;
            max-width: 350px;
            display: none;
        }

        .validation-panel.show {
            display: block;
        }

        .validation-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .validation-panel-title {
            font-weight: 600;
            color: #1a3a5c;
            font-size: 0.95rem;
        }

        .validation-panel-close {
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
        }

        .validation-panel-close:hover {
            color: #333;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }

        .validation-item:last-child {
            border-bottom: none;
        }

        .validation-icon {
            font-size: 1rem;
        }

        .validation-icon.valid {
            color: #28a745;
        }

        .validation-icon.invalid {
            color: #dc3545;
        }

        .validation-icon.modified {
            color: #ffc107;
        }

        /* Modified fields counter */
        .modified-counter {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            z-index: 1000;
            display: none;
            cursor: pointer;
        }

        .modified-counter.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modified-counter::before {
            content: "‚úèÔ∏è";
        }

        /* Validate button */
        .validate-button {
            position: fixed;
            bottom: 30px;
            right: 250px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .validate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .validate-button::before {
            content: "‚úì ";
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .document-preview {
            width: 100%;
            min-height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .save-indicator {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
                font-size: 11pt;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .header {
                background: #1a3a5c !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border-radius: 0;
                padding: 20px;
            }

            .tabs {
                display: none;
            }

            .tab-content {
                display: block !important;
                page-break-before: always;
                border-radius: 0;
                box-shadow: none;
                padding: 15px;
            }

            .tab-content:first-of-type {
                page-break-before: avoid;
            }

            .section {
                page-break-inside: avoid;
                margin-bottom: 15px;
            }

            .section-header {
                background-color: #1a3a5c !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 8px 15px;
            }

            .print-button,
            .table-controls,
            .btn,
            .upload-btn,
            .view-btn,
            .add-row-btn,
            .remove-row-btn,
            .add-col-btn {
                display: none !important;
            }

            .file-remove {
                display: none;
            }

            .file-list {
                font-size: 8pt;
            }

            .form-group input,
            .form-group textarea,
            .form-group select,
            table td input,
            table td textarea {
                border: 1px solid #ccc !important;
                padding: 5px !important;
                background-color: #f9f9f9 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                height: auto !important;
                min-height: auto !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
                overflow: visible !important;
                text-overflow: clip !important;
            }

            /* Convert inputs to display their values as text for printing */
            input[type="text"],
            input[type="email"],
            input[type="number"],
            input[type="date"] {
                overflow: visible !important;
                text-overflow: clip !important;
            }

            textarea {
                height: auto !important;
                min-height: 60px !important;
                overflow: visible !important;
                resize: none !important;
            }

            /* Ensure form groups expand */
            .form-group {
                page-break-inside: avoid;
            }

            /* Make table cells expand to show content */
            table td {
                height: auto !important;
                white-space: normal !important;
                word-wrap: break-word !important;
            }

            table td input {
                width: 100% !important;
                box-sizing: border-box !important;
            }

            table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .gantt-container {
                page-break-inside: avoid;
            }

            .gantt-bar-wp1,
            .gantt-bar-wp2,
            .gantt-bar-wp3,
            .gantt-bar-wp4,
            .gantt-bar-wp5,
            .gantt-bar-wp6 {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>
    <!-- Read-only Mode Banner -->
    <div id="readonlyBanner" class="readonly-banner">
        üîí Mode Lecture Seule - Vous pouvez consulter, t√©l√©charger et imprimer mais pas modifier le document
    </div>

    <!-- PIN Security Overlay -->
    <div id="pinOverlay" class="pin-overlay">
        <div class="pin-container">
            <div class="pin-logo">üîí</div>
            <h2 class="pin-title">Document S√©curis√©</h2>
            <p class="pin-subtitle">PRAD A12P1 - Centre de Recherche Militaire<br>Veuillez entrer le code PIN pour
                acc√©der au document</p>

            <!-- Mode Selection Tabs -->
            <div class="access-mode-tabs">
                <button class="mode-tab active" id="teamModeTab" onclick="switchAccessMode('team')">üë• √âquipe
                    (Lecture)</button>
                <button class="mode-tab" id="adminModeTab" onclick="switchAccessMode('admin')">üîê Admin
                    (√âdition)</button>
            </div>

            <div id="teamPinSection" class="pin-section active">
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Mode lecture seule - Consultation et
                    t√©l√©chargement uniquement</p>
                <div class="pin-input-container">
                    <input type="password" class="pin-single-input" maxlength="4" id="pinInput" autocomplete="off"
                        placeholder="****" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                </div>
                <p id="pinError" class="pin-error-message">Code PIN incorrect. Veuillez r√©essayer.</p>
                <button class="pin-submit" id="pinSubmitBtn">Acc√©der en Lecture</button>
            </div>

            <div id="adminPinSection" class="pin-section">
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Mode administrateur - Modification
                    compl√®te du document</p>
                <div class="pin-input-container">
                    <input type="password" class="pin-single-input" maxlength="6" id="adminPinInputMain"
                        autocomplete="off" placeholder="******"
                        onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                </div>
                <p id="adminPinErrorMain" class="pin-error-message">Code PIN Admin incorrect. Veuillez r√©essayer.</p>
                <button class="pin-submit admin-submit" id="adminPinSubmitBtn">Acc√©der en Mode Admin</button>
            </div>

            <p class="pin-footer">Document confidentiel - Acc√®s r√©serv√© aux membres du projet</p>
        </div>
    </div>

    <!-- Row/Column Selection Modal -->
    <div id="rowColModal" class="row-col-modal">
        <div class="row-col-content">
            <div class="row-col-title">
                <span id="rowColModalTitle">S√©lectionner une ligne</span>
                <button class="row-col-close" onclick="closeRowColModal()">&times;</button>
            </div>
            <div id="rowColList" class="row-col-list"></div>
            <div id="rowColPosition" class="row-col-position" style="display:none;">
                <label>Position d'insertion :</label>
                <select id="rowColPositionSelect"></select>
            </div>
            <div class="row-col-actions">
                <button class="row-col-btn cancel" onclick="closeRowColModal()">Annuler</button>
                <button id="rowColActionBtn" class="row-col-btn delete">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="docViewerModal" class="doc-viewer-modal">
        <div class="doc-viewer-content">
            <div class="doc-viewer-header">
                <div class="doc-viewer-title">
                    <span class="file-icon" id="docViewerIcon">üìÑ</span>
                    <span id="docViewerFileName">Document</span>
                </div>
                <div class="doc-viewer-actions">
                    <button class="doc-viewer-btn" id="docDownloadBtn" onclick="downloadCurrentDoc()">
                        ‚¨áÔ∏è T√©l√©charger
                    </button>
                    <button class="doc-viewer-btn" id="docPrevBtn" onclick="viewPrevDoc()">
                        ‚óÄ Pr√©c√©dent
                    </button>
                    <button class="doc-viewer-btn" id="docNextBtn" onclick="viewNextDoc()">
                        Suivant ‚ñ∂
                    </button>
                    <button class="doc-viewer-btn close-btn" onclick="closeDocViewer()">
                        ‚úï Fermer
                    </button>
                </div>
            </div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div class="doc-viewer-body" id="docViewerBody">
                    <!-- Document content will be loaded here -->
                </div>
                <div class="doc-viewer-sidebar" id="docViewerSidebar">
                    <div class="doc-list-title">üìé Documents joints</div>
                    <div id="docListContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin PIN Modal -->
    <div id="adminPinModal" class="admin-pin-modal">
        <div class="admin-pin-content">
            <div style="font-size: 2.5rem; margin-bottom: 15px;">üîê</div>
            <h3 class="admin-pin-title">Authentification Administrateur</h3>
            <p class="admin-pin-subtitle">Entrez le code PIN Administrateur pour acc√©der aux param√®tres de s√©curit√©</p>
            <input type="password" class="admin-pin-input" id="adminPinInput" maxlength="6" placeholder="******"
                autocomplete="off">
            <p id="adminPinError" class="admin-pin-error">Code PIN Administrateur incorrect</p>
            <div class="admin-pin-actions">
                <button class="admin-pin-btn cancel" onclick="closeAdminPinModal()">Annuler</button>
                <button class="admin-pin-btn confirm" onclick="verifyAdminPIN()">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Immediate PIN verification script with dual-mode authentication
        (function () {
            var CORRECT_PIN = localStorage.getItem('prad_pin') || '0331';
            var ADMIN_PIN = localStorage.getItem('prad_admin_pin') || '085301';

            // Check if already authenticated
            var authMode = sessionStorage.getItem('prad_auth_mode');
            if (sessionStorage.getItem('prad_authenticated') === 'true' && authMode) {
                document.getElementById('pinOverlay').style.display = 'none';
                if (authMode === 'readonly') {
                    document.body.classList.add('readonly-mode');
                }
            }

            // Switch access mode tabs
            window.switchAccessMode = function (mode) {
                var teamTab = document.getElementById('teamModeTab');
                var adminTab = document.getElementById('adminModeTab');
                var teamSection = document.getElementById('teamPinSection');
                var adminSection = document.getElementById('adminPinSection');

                if (mode === 'team') {
                    teamTab.classList.add('active');
                    adminTab.classList.remove('active');
                    teamSection.classList.add('active');
                    adminSection.classList.remove('active');
                    document.getElementById('pinInput').focus();
                } else {
                    teamTab.classList.remove('active');
                    adminTab.classList.add('active');
                    teamSection.classList.remove('active');
                    adminSection.classList.add('active');
                    document.getElementById('adminPinInputMain').focus();
                }
            };

            // Team PIN verification (read-only mode)
            window.verifyPIN = function () {
                var pinInput = document.getElementById('pinInput');
                var enteredPIN = pinInput ? pinInput.value : '';

                if (enteredPIN === CORRECT_PIN) {
                    sessionStorage.setItem('prad_authenticated', 'true');
                    sessionStorage.setItem('prad_auth_mode', 'readonly');
                    document.body.classList.add('readonly-mode');
                    document.getElementById('pinOverlay').style.opacity = '0';
                    document.getElementById('pinOverlay').style.transition = 'opacity 0.5s';
                    setTimeout(function () {
                        document.getElementById('pinOverlay').style.display = 'none';
                        var mainContent = document.getElementById('mainContent');
                        if (mainContent) {
                            mainContent.classList.remove('content-locked');
                            mainContent.classList.add('content-unlocked');
                        }
                        // Show team mode badge
                        var badge = document.getElementById('accessModeBadge');
                        if (badge) {
                            badge.classList.remove('admin-mode');
                            badge.classList.add('team-mode');
                            badge.querySelector('.mode-icon').textContent = '\ud83d\udd12';
                            badge.querySelector('.mode-text').textContent = 'Mode \u00c9quipe (Lecture)';
                            badge.style.display = 'flex';
                        }
                    }, 500);
                } else {
                    document.getElementById('pinError').classList.add('show');
                    if (pinInput) {
                        pinInput.classList.add('error');
                        pinInput.value = '';
                        pinInput.focus();
                        setTimeout(function () {
                            pinInput.classList.remove('error');
                        }, 500);
                    }
                }
            };

            // Admin PIN verification (full edit mode)
            window.verifyAdminPINMain = function () {
                var pinInput = document.getElementById('adminPinInputMain');
                var enteredPIN = pinInput ? pinInput.value : '';

                if (enteredPIN === ADMIN_PIN) {
                    sessionStorage.setItem('prad_authenticated', 'true');
                    sessionStorage.setItem('prad_auth_mode', 'admin');
                    document.body.classList.remove('readonly-mode');
                    document.getElementById('pinOverlay').style.opacity = '0';
                    document.getElementById('pinOverlay').style.transition = 'opacity 0.5s';
                    setTimeout(function () {
                        document.getElementById('pinOverlay').style.display = 'none';
                        var mainContent = document.getElementById('mainContent');
                        if (mainContent) {
                            mainContent.classList.remove('content-locked');
                            mainContent.classList.add('content-unlocked');
                        }
                        // Show admin mode badge
                        var badge = document.getElementById('accessModeBadge');
                        if (badge) {
                            badge.classList.remove('team-mode');
                            badge.classList.add('admin-mode');
                            badge.querySelector('.mode-icon').textContent = '\ud83d\udd13';
                            badge.querySelector('.mode-text').textContent = 'Mode Admin';
                            badge.style.display = 'flex';
                        }
                    }, 500);
                } else {
                    document.getElementById('adminPinErrorMain').classList.add('show');
                    if (pinInput) {
                        pinInput.classList.add('error');
                        pinInput.value = '';
                        pinInput.focus();
                        setTimeout(function () {
                            pinInput.classList.remove('error');
                        }, 500);
                    }
                }
            };

            // Wait for DOM to be ready
            document.addEventListener('DOMContentLoaded', function () {
                var pinInput = document.getElementById('pinInput');
                var pinSubmitBtn = document.getElementById('pinSubmitBtn');
                var adminPinInput = document.getElementById('adminPinInputMain');
                var adminPinSubmitBtn = document.getElementById('adminPinSubmitBtn');

                // Apply readonly mode if already set and show badge
                var authMode = sessionStorage.getItem('prad_auth_mode');
                var badge = document.getElementById('accessModeBadge');
                if (authMode === 'readonly') {
                    document.body.classList.add('readonly-mode');
                    if (badge) {
                        badge.classList.remove('admin-mode');
                        badge.classList.add('team-mode');
                        badge.querySelector('.mode-icon').textContent = '\ud83d\udd12';
                        badge.querySelector('.mode-text').textContent = 'Mode \u00c9quipe (Lecture)';
                        badge.style.display = 'flex';
                    }
                } else if (authMode === 'admin') {
                    if (badge) {
                        badge.classList.remove('team-mode');
                        badge.classList.add('admin-mode');
                        badge.querySelector('.mode-icon').textContent = '\ud83d\udd13';
                        badge.querySelector('.mode-text').textContent = 'Mode Admin';
                        badge.style.display = 'flex';
                    }
                }

                // Focus on input
                if (pinInput && document.getElementById('pinOverlay').style.display !== 'none') {
                    pinInput.focus();
                }

                // Team PIN button click
                if (pinSubmitBtn) {
                    pinSubmitBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        verifyPIN();
                    });
                }

                // Admin PIN button click
                if (adminPinSubmitBtn) {
                    adminPinSubmitBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        verifyAdminPINMain();
                    });
                }

                // Team PIN input events
                if (pinInput) {
                    pinInput.addEventListener('input', function () {
                        this.classList.remove('error');
                        document.getElementById('pinError').classList.remove('show');
                        if (this.value.length === 4) {
                            verifyPIN();
                        }
                    });

                    pinInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            verifyPIN();
                        }
                    });
                }

                // Admin PIN input events
                if (adminPinInput) {
                    adminPinInput.addEventListener('input', function () {
                        this.classList.remove('error');
                        document.getElementById('adminPinErrorMain').classList.remove('show');
                        if (this.value.length === 6) {
                            verifyAdminPINMain();
                        }
                    });

                    adminPinInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            verifyAdminPINMain();
                        }
                    });
                }
            });
        })();
    </script>

    <div id="mainContent" class="content-locked">

        <!-- Access Mode Badge -->
        <div id="accessModeBadge" class="access-mode-badge admin-mode" style="display: none;">
            <span class="mode-icon">üîì</span>
            <span class="mode-text">Mode Admin</span>
            <button class="logout-btn" onclick="logoutSession()">D√©connexion</button>
        </div>

        <!-- Read-only Banner -->
        <div id="readonlyBanner" class="readonly-banner">
            üîí Mode Lecture Seule - Vous pouvez consulter, t√©l√©charger et imprimer le document, mais pas le modifier
        </div>

        <!-- PIN Settings Button -->
        <button id="pinSettingsBtn" class="pin-settings-btn" onclick="openPinSettingsSecure()">
            ‚öôÔ∏è Param√®tres PIN
        </button>

        <!-- PIN Change Modal -->
        <div id="pinChangeModal" class="pin-change-modal">
            <div class="pin-change-container">
                <div class="pin-change-header">
                    <h3 class="pin-change-title">üîê Modifier le Code PIN</h3>
                    <button class="pin-change-close" onclick="closePinChangeModal()">&times;</button>
                </div>
                <div class="pin-change-form">
                    <!-- Current PIN -->
                    <div class="pin-change-field">
                        <label class="pin-change-label">Code PIN Actuel</label>
                        <div class="pin-change-input-group">
                            <input type="password" class="pin-change-input" maxlength="1" id="currentPin1"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="currentPin2"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="currentPin3"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="currentPin4"
                                autocomplete="off">
                        </div>
                    </div>

                    <!-- New PIN -->
                    <div class="pin-change-field">
                        <label class="pin-change-label">Nouveau Code PIN</label>
                        <div class="pin-change-input-group">
                            <input type="password" class="pin-change-input" maxlength="1" id="newPin1"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="newPin2"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="newPin3"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="newPin4"
                                autocomplete="off">
                        </div>
                        <div class="pin-strength">
                            <div class="pin-strength-bar" id="strengthBar1"></div>
                            <div class="pin-strength-bar" id="strengthBar2"></div>
                            <div class="pin-strength-bar" id="strengthBar3"></div>
                            <div class="pin-strength-bar" id="strengthBar4"></div>
                        </div>
                    </div>

                    <!-- Confirm New PIN -->
                    <div class="pin-change-field">
                        <label class="pin-change-label">Confirmer le Nouveau Code PIN</label>
                        <div class="pin-change-input-group">
                            <input type="password" class="pin-change-input" maxlength="1" id="confirmPin1"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="confirmPin2"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="confirmPin3"
                                autocomplete="off">
                            <input type="password" class="pin-change-input" maxlength="1" id="confirmPin4"
                                autocomplete="off">
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="pinChangeMessage" class="pin-change-message"></div>

                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                    <!-- GitHub Token -->
                    <div class="pin-change-field">
                        <label class="pin-change-label">Configuration GitHub (Optionnel)</label>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 8px;">Entrez un Token (PAT) pour √©viter
                            les limitations de d√©bit de l'API GitHub.</p>
                        <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxx"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                            <button class="btn" onclick="saveGitHubToken()"
                                style="background: #24292e; color: white; padding: 8px 15px; font-size: 0.85rem;">Enregistrer
                                Token</button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button class="pin-change-submit" id="pinChangeSubmit" onclick="changePIN()">
                        üîí Enregistrer le Nouveau PIN
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <h1>Fiche de Description et de Suivi d'Avancement de Projet PRAD A12P1</h1>
                <p>Valorisation et recyclage des d√©chets pour la construction</p>
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'tab1')">Suivi Trimestriel</button>
                <button class="tab-button" onclick="openTab(event, 'tab2')">Suivi Personnel</button>
                <button class="tab-button" onclick="openTab(event, 'tab3')">Suivi Projet</button>
            </div>

            <!-- Tab 1: Suivi Trimestriel -->
            <div id="tab1" class="tab-content active">
                <!-- Identification du Projet -->
                <div class="section">
                    <div class="section-header">Identification du Projet</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group required-field">
                                <label>Intitul√© du Projet</label>
                                <input type="text" id="field_intitule_projet"
                                    value="Valorisation et recyclage des d√©chets pour la construction"
                                    placeholder="Titre du projet" required data-field-name="Intitul√© du Projet">
                            </div>
                            <div class="form-group required-field">
                                <label>Code du Projet</label>
                                <input type="text" id="field_code_projet" value="PRAD A12P1" placeholder="Code" required
                                    data-field-name="Code du Projet">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Appel √† Propositions</label>
                                <input type="text" value="2024-2026">
                            </div>
                            <div class="form-group required-field">
                                <label>Date de D√©marrage</label>
                                <input type="date" id="field_date_demarrage" value="2024-09-01" required
                                    data-field-name="Date de D√©marrage">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group required-field">
                                <label>Dur√©e (mois)</label>
                                <input type="number" id="field_duree" value="36" placeholder="Dur√©e en mois" required
                                    data-field-name="Dur√©e">
                            </div>
                            <div class="form-group">
                                <label>B√©n√©ficiaire</label>
                                <input type="text" value="Direction G√©n√©rale du G√©nie Militaire">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>R√©sum√© du Projet</label>
                                <textarea
                                    id="field_resume_projet">Ce projet vise √† d√©velopper des solutions innovantes pour la valorisation et le recyclage des d√©chets de construction et de d√©molition dans le secteur militaire. L'objectif est de cr√©er des mat√©riaux de construction durables √† partir de d√©chets recycl√©s, r√©duisant ainsi l'impact environnemental et les co√ªts de construction pour les infrastructures militaires.</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chef de Projet -->
                <div class="section">
                    <div class="section-header">Chef de Projet</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group required-field">
                                <label>Nom et Pr√©nom</label>
                                <input type="text" id="field_chef_nom" value="Cdt Oussama Atoui"
                                    placeholder="Nom complet" required data-field-name="Nom du Chef de Projet">
                            </div>
                            <div class="form-group">
                                <label>Sp√©cialit√©</label>
                                <input type="text" id="field_chef_specialite" value="G√©nie Civil">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Institution</label>
                                <input type="text" id="field_chef_institution" value="Acad√©mie Militaire Fondouk Jedid">
                            </div>
                            <div class="form-group">
                                <label>Fonction</label>
                                <input type="text" value="Enseignant-chercheur">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Grade Scientifique et/ou Militaire</label>
                                <input type="text"
                                    value="Commandant ‚Äì Maitre-Assistant de l'enseignement sup√©rieur Militaire">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dipl√¥me</label>
                                <input type="text" value="Docteur ‚Äì Ing√©nieur en G√©nie Civil">
                            </div>
                            <div class="form-group">
                                <label>Date d'obtention</label>
                                <input type="date" value="2023-12-23">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="text" value="93848982">
                            </div>
                            <div class="form-group required-field">
                                <label>E-mail</label>
                                <input type="email" value="oussmer@hotmail.fr" placeholder="Email" required
                                    data-field-name="E-mail">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comit√© de Pilotage -->
                <div class="section">
                    <div class="section-header">
                        <span>Comit√© Interne de Pilotage du PRAD</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('comite-table')">+ Ajouter Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('comite-table')">- Supprimer
                                Ligne</button>
                            <button class="btn add-col-btn" onclick="addColumn('comite-table')">+ Ajouter
                                Colonne</button>
                        </div>
                        <div class="table-container">
                            <table id="comite-table">
                                <thead>
                                    <tr>
                                        <th>Nom et Pr√©nom</th>
                                        <th>Grade/Qualit√©</th>
                                        <th>Etablissement/Organisme</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="Ahmed Siala"></td>
                                        <td><input type="text" value="Professeur"></td>
                                        <td><input type="text" value="Centre de Recherches Militaires"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Yadh Zahar"></td>
                                        <td><input type="text" value="Professeur"></td>
                                        <td><input type="text" value="Laboratoire VDEC ‚Äì ENAU"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Oussama Atoui"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="Acad√©mie Militaire de Fondouk Jedid"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Azer Maazoun"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="Acad√©mie Militaire de Fondouk Jedid"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Nesrine Ellouze"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="Laboratoire VDEC ‚Äì ENAU"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Colonel Major Chokri Fatnassi"></td>
                                        <td><input type="text" value="Directeur G√©n√©ral"></td>
                                        <td><input type="text" value="Direction G√©n√©rale du G√©nie Militaire"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Mohamed Guesmi"></td>
                                        <td><input type="text" value="Directeur G√©n√©ral"></td>
                                        <td><input type="text"
                                                value="Centre d'Essais et des Techniques de la Construction"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Mohamed Ben Rhouma"></td>
                                        <td><input type="text" value="Doctorant"></td>
                                        <td><input type="text" value="61 Groupement de G√©nie"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Habib Ouertatatni"></td>
                                        <td><input type="text" value="Doctorant"></td>
                                        <td><input type="text" value=""></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Diagramme de Gantt -->
                <div class="section">
                    <div class="section-header">Diagramme de Gantt - Planning du Projet</div>
                    <div class="section-content">
                        <div class="gantt-container">
                            <div class="gantt-header">
                                <div class="gantt-title">Planning des Work Packages (2024-2027)</div>
                                <div class="gantt-legend">
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp1"></div>WP1
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp2"></div>WP2
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp3"></div>WP3
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp4"></div>WP4
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp5"></div>WP5
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color gantt-bar-wp6"></div>WP6
                                    </div>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="gantt-table" id="gantt-table">
                                    <thead>
                                        <tr>
                                            <th rowspan="2" style="min-width: 200px;">Work Package</th>
                                            <th colspan="4">2024</th>
                                            <th colspan="12">2025</th>
                                            <th colspan="12">2026</th>
                                            <th colspan="9">2027</th>
                                        </tr>
                                        <tr>
                                            <th>S</th>
                                            <th>O</th>
                                            <th>N</th>
                                            <th>D</th>
                                            <th>J</th>
                                            <th>F</th>
                                            <th>M</th>
                                            <th>A</th>
                                            <th>M</th>
                                            <th>J</th>
                                            <th>J</th>
                                            <th>A</th>
                                            <th>S</th>
                                            <th>O</th>
                                            <th>N</th>
                                            <th>D</th>
                                            <th>J</th>
                                            <th>F</th>
                                            <th>M</th>
                                            <th>A</th>
                                            <th>M</th>
                                            <th>J</th>
                                            <th>J</th>
                                            <th>A</th>
                                            <th>S</th>
                                            <th>O</th>
                                            <th>N</th>
                                            <th>D</th>
                                            <th>J</th>
                                            <th>F</th>
                                            <th>M</th>
                                            <th>A</th>
                                            <th>M</th>
                                            <th>J</th>
                                            <th>J</th>
                                            <th>A</th>
                                            <th>S</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>WP1:</strong> √âtude de faisabilit√©</td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp1"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp1"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp1"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp1"></div>
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>WP2:</strong> S√©lection technologies</td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp2"></div>
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>WP3:</strong> D√©veloppement formulations</td>
                                            <td></td>
                                            <td></td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp3"></div>
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>WP4:</strong> √âvaluation impact</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp4"></div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>WP5:</strong> Validation et d√©ploiement</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp5"></div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>WP6:</strong> Suivi et √©valuation</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp6"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp6"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp6"></div>
                                            </td>
                                            <td class="gantt-cell">
                                                <div class="gantt-bar gantt-bar-wp6"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Milestone Lines Controls -->
                            <div class="gantt-milestone-container" id="milestoneContainer">
                                <div class="gantt-milestone-controls">
                                    <label>üìç Lignes de R√©union d'√âvaluation:</label>
                                    <button class="btn-milestone" onclick="addMilestone()">+ Ajouter Ligne</button>
                                </div>
                                <div class="milestone-list" id="milestoneList">
                                    <!-- Milestone items will be added here -->
                                </div>
                            </div>

                            <!-- Export Controls -->
                            <div class="gantt-export-controls">
                                <label>üì§ Exporter le Diagramme:</label>
                                <button class="btn-export btn-export-png" onclick="exportGanttAsPNG()">
                                    üñºÔ∏è Exporter PNG
                                </button>
                                <button class="btn-export btn-export-svg" onclick="exportGanttAsSVG()">
                                    üìä Exporter SVG
                                </button>
                                <button class="btn-export btn-export-pdf" onclick="exportGanttAsPDF()">
                                    üìÑ Exporter PDF
                                </button>
                                <div class="export-loading" id="exportLoading">
                                    <div class="export-spinner"></div>
                                    <span>Exportation en cours...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Work Packages / T√¢ches -->
                <div class="section">
                    <div class="section-header">
                        <span>Work Packages / T√¢ches</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('wp-table')">+ Ajouter Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('wp-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="wp-table">
                                <thead>
                                    <tr>
                                        <th>WP</th>
                                        <th>Titre</th>
                                        <th>Date D√©but</th>
                                        <th>Date Fin</th>
                                        <th>Avancement (%)</th>
                                        <th>Livrables</th>
                                        <th class="upload-cell">Documents</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="WP1"></td>
                                        <td><input type="text" value="√âtude de faisabilit√© et analyse des besoins"></td>
                                        <td><input type="date" value="2024-09-01"></td>
                                        <td><input type="date" value="2024-12-31"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text"
                                                value="Rapport de faisabilit√©, Analyse des d√©chets disponibles"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="WP2"></td>
                                        <td><input type="text" value="S√©lection des technologies de recyclage"></td>
                                        <td><input type="date" value="2024-09-01"></td>
                                        <td><input type="date" value="2025-12-31"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text" value="Rapport technique, Protocoles de traitement"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="WP3"></td>
                                        <td><input type="text" value="D√©veloppement des formulations de mat√©riaux"></td>
                                        <td><input type="date" value="2024-11-01"></td>
                                        <td><input type="date" value="2026-10-31"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text" value="Formulations optimis√©es, Fiches techniques"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="WP4"></td>
                                        <td><input type="text"
                                                value="√âvaluation de l'impact environnemental et √©conomique"></td>
                                        <td><input type="date" value="2026-05-01"></td>
                                        <td><input type="date" value="2027-09-30"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text" value="Rapport d'impact, Analyse co√ªt-b√©n√©fice"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="WP5"></td>
                                        <td><input type="text" value="Validation et d√©ploiement pilote"></td>
                                        <td><input type="date" value="2026-05-01"></td>
                                        <td><input type="date" value="2027-09-30"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text" value="Prototype valid√©, Guide de d√©ploiement"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="WP6"></td>
                                        <td><input type="text" value="Suivi, √©valuation et diss√©mination"></td>
                                        <td><input type="date" value="2027-06-01"></td>
                                        <td><input type="date" value="2027-09-30"></td>
                                        <td><input type="number" value="0" min="0" max="100">%</td>
                                        <td><input type="text" value="Rapport final, Publications scientifiques"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Budget du Projet -->
                <div class="section">
                    <div class="section-header">Budget du Projet</div>
                    <div class="section-content">
                        <div class="subsection">
                            <div class="subsection-title">R√©capitulatif Budg√©taire</div>
                            <div class="table-controls">
                                <button class="btn add-row-btn" onclick="addRow('budget-recap-table')">+ Ajouter
                                    Ligne</button>
                                <button class="btn remove-row-btn" onclick="removeRow('budget-recap-table')">- Supprimer
                                    Ligne</button>
                                <button class="btn add-col-btn" onclick="addColumn('budget-recap-table')">+ Ajouter
                                    Colonne</button>
                            </div>
                            <div class="table-container">
                                <table id="budget-recap-table">
                                    <thead>
                                        <tr>
                                            <th>Rubrique</th>
                                            <th>Ann√©e 1 (2024)</th>
                                            <th>Ann√©e 2 (2025)</th>
                                            <th>Ann√©e 3 (2026)</th>
                                            <th>Total (DT)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="text" value="√âquipements"></td>
                                            <td><input type="number" value="112000"></td>
                                            <td><input type="number" value="120000"></td>
                                            <td><input type="number" value="92200"></td>
                                            <td><input type="number" value="324200" readonly></td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Consommables"></td>
                                            <td><input type="number" value="10000"></td>
                                            <td><input type="number" value="10000"></td>
                                            <td><input type="number" value="10000"></td>
                                            <td><input type="number" value="30000" readonly></td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Missions et D√©placements"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="15000" readonly></td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Formations"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="15000" readonly></td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Contrats RH"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="5000"></td>
                                            <td><input type="number" value="15000" readonly></td>
                                        </tr>
                                        <tr style="background-color: #f0f7ff;">
                                            <td><strong>Total par Ann√©e</strong></td>
                                            <td><strong><input type="number" value="137000" readonly></strong></td>
                                            <td><strong><input type="number" value="145000" readonly></strong></td>
                                            <td><strong><input type="number" value="117200" readonly></strong></td>
                                            <td><strong><input type="number" value="399200" readonly></strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="subsection">
                            <div class="subsection-title">√âquipements - Ann√©e 1 (2024)</div>
                            <div class="table-controls">
                                <button class="btn add-row-btn" onclick="addRow('equip-2024-table')">+ Ajouter
                                    Ligne</button>
                                <button class="btn remove-row-btn" onclick="removeRow('equip-2024-table')">- Supprimer
                                    Ligne</button>
                            </div>
                            <div class="table-container">
                                <table id="equip-2024-table">
                                    <thead>
                                        <tr>
                                            <th>D√©signation</th>
                                            <th>Quantit√©</th>
                                            <th>Co√ªt (DT)</th>
                                            <th>Statuts</th>
                                            <th class="upload-cell">Justificatif</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="text"
                                                    value="√âquipements de tri et de s√©paration des d√©chets"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="20000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Broyeur de plastique"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="25000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Concasseur pour gravier"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="45000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Granulateur"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="12000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text"
                                                    value="Mati√®re premi√®re pour fabrication nouveaux mat√©riaux"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="7000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Machine de lavage et de nettoyage"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="3000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="subsection">
                            <div class="subsection-title">√âquipements - Ann√©e 2 (2025)</div>
                            <div class="table-controls">
                                <button class="btn add-row-btn" onclick="addRow('equip-2025-table')">+ Ajouter
                                    Ligne</button>
                                <button class="btn remove-row-btn" onclick="removeRow('equip-2025-table')">- Supprimer
                                    Ligne</button>
                            </div>
                            <div class="table-container">
                                <table id="equip-2025-table">
                                    <thead>
                                        <tr>
                                            <th>D√©signation</th>
                                            <th>Quantit√©</th>
                                            <th>Co√ªt (DT)</th>
                                            <th>Statuts</th>
                                            <th class="upload-cell">Justificatif</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="text"
                                                    value="Machine de compression pour essais sur b√©ton capacit√© 3000 KN">
                                            </td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="70000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="Machine d'essai de flexion 200KN"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="35000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text"
                                                    value="Presse et compacteur pour comprimer les d√©chets"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="15000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="subsection">
                            <div class="subsection-title">√âquipements - Ann√©e 3 (2026)</div>
                            <div class="table-controls">
                                <button class="btn add-row-btn" onclick="addRow('equip-2026-table')">+ Ajouter
                                    Ligne</button>
                                <button class="btn remove-row-btn" onclick="removeRow('equip-2026-table')">- Supprimer
                                    Ligne</button>
                            </div>
                            <div class="table-container">
                                <table id="equip-2026-table">
                                    <thead>
                                        <tr>
                                            <th>D√©signation</th>
                                            <th>Quantit√©</th>
                                            <th>Co√ªt (DT)</th>
                                            <th>Statuts</th>
                                            <th class="upload-cell">Justificatif</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="text"
                                                    value="Machine de flexion EN 13290-5, EN 14488-5, EN 14651"></td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="50000"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="√âquipements de laboratoire compl√©mentaires">
                                            </td>
                                            <td><input type="number" value="1"></td>
                                            <td><input type="number" value="42200"></td>
                                            <td style="text-align: center;"><input type="checkbox" title="Achet√© ?">
                                            </td>
                                            <td class="upload-cell">
                                                <div class="upload-wrapper">
                                                    <div class="btn-group">
                                                        <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                            Joindre</button>
                                                        <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                            Voir</button>
                                                    </div>
                                                    <input type="file" class="file-input" multiple
                                                        accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                        onchange="handleFileSelect(this)">
                                                    <div class="file-list"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ressources Humaines -->
                <div class="section">
                    <div class="section-header">
                        <span>Ressources Humaines</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('rh-table')">+ Ajouter Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('rh-table')">- Supprimer
                                Ligne</button>
                            <button class="btn add-col-btn" onclick="addColumn('rh-table')">+ Ajouter Colonne</button>
                        </div>
                        <div class="table-container">
                            <table id="rh-table">
                                <thead>
                                    <tr>
                                        <th>Nom et Pr√©nom</th>
                                        <th>Grade/Qualit√©</th>
                                        <th>√âtablissement</th>
                                        <th>% Temps PRAD</th>
                                        <th>R√¥le dans le Projet</th>
                                        <th class="upload-cell">CV/Documents</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="Oussama Atoui"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="Acad√©mie Militaire"></td>
                                        <td><input type="number" value="50">%</td>
                                        <td><input type="text" value="Chef de Projet"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Ahmed Siala"></td>
                                        <td><input type="text" value="Professeur"></td>
                                        <td><input type="text" value="CRM"></td>
                                        <td><input type="number" value="20">%</td>
                                        <td><input type="text" value="Coordinateur Scientifique"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Yadh Zahar"></td>
                                        <td><input type="text" value="Professeur"></td>
                                        <td><input type="text" value="ENAU - VDEC"></td>
                                        <td><input type="number" value="20">%</td>
                                        <td><input type="text" value="Expert Mat√©riaux"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Azer Maazoun"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="Acad√©mie Militaire"></td>
                                        <td><input type="number" value="30">%</td>
                                        <td><input type="text" value="Responsable Technique"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Nesrine Ellouze"></td>
                                        <td><input type="text" value="Maitre-Assistant"></td>
                                        <td><input type="text" value="ENAU - VDEC"></td>
                                        <td><input type="number" value="25">%</td>
                                        <td><input type="text" value="Chercheuse"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Mohamed Ben Rhouma"></td>
                                        <td><input type="text" value="Doctorant"></td>
                                        <td><input type="text" value="61 Groupement de G√©nie"></td>
                                        <td><input type="number" value="100">%</td>
                                        <td><input type="text" value="Doctorant PRAD"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Habib Ouertatatni"></td>
                                        <td><input type="text" value="Doctorant"></td>
                                        <td><input type="text" value=""></td>
                                        <td><input type="number" value="100">%</td>
                                        <td><input type="text" value="Doctorant PRAD"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TRL -->
                <div class="section">
                    <div class="section-header">Niveau de Maturit√© Technologique (TRL)</div>
                    <div class="section-content">
                        <div class="table-container">
                            <table class="trl-table" id="trl-table">
                                <thead>
                                    <tr>
                                        <th>Niveau TRL</th>
                                        <th>Atteint</th>
                                        <th>Description</th>
                                        <th class="upload-cell">Preuve</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>TRL 1</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Principes de base observ√©s et rapport√©s"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 2</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Concept technologique formul√©"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 3</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Preuve de concept exp√©rimentale"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 4</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Validation en laboratoire"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 5</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Validation en environnement repr√©sentatif"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 6</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="D√©monstration en environnement repr√©sentatif">
                                        </td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 7</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="D√©monstration en environnement op√©rationnel"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 8</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Syst√®me complet qualifi√©"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>TRL 9</td>
                                        <td style="text-align: center;"><input type="checkbox"></td>
                                        <td><input type="text" value="Syst√®me op√©rationnel en conditions r√©elles"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Indicateurs de Suivi -->
                <div class="section">
                    <div class="section-header">
                        <span>Indicateurs de Suivi</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('indicateurs-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('indicateurs-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="indicateurs-table">
                                <thead>
                                    <tr>
                                        <th>Indicateur</th>
                                        <th>Objectif</th>
                                        <th>R√©alis√©</th>
                                        <th>√âcart</th>
                                        <th class="upload-cell">Justificatif</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="Publications scientifiques"></td>
                                        <td><input type="number" value="3"></td>
                                        <td><input type="number" value="0"></td>
                                        <td><input type="number" value="-3"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Brevets d√©pos√©s"></td>
                                        <td><input type="number" value="1"></td>
                                        <td><input type="number" value="0"></td>
                                        <td><input type="number" value="-1"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Th√®ses de doctorat"></td>
                                        <td><input type="number" value="2"></td>
                                        <td><input type="number" value="0"></td>
                                        <td><input type="number" value="-2"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Prototypes d√©velopp√©s"></td>
                                        <td><input type="number" value="2"></td>
                                        <td><input type="number" value="0"></td>
                                        <td><input type="number" value="-2"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Risques -->
                <div class="section">
                    <div class="section-header">
                        <span>Risques et Points d'Attention</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('risques-table')">+ Ajouter Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('risques-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="risques-table">
                                <thead>
                                    <tr>
                                        <th>Risque / Point d'Attention</th>
                                        <th>Impact</th>
                                        <th>Probabilit√©</th>
                                        <th>Action de Mitigation</th>
                                        <th>Responsable</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="Fluctuation prix mati√®res premi√®res"></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen" selected>Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen" selected>Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><input type="text" value="Surveillance constante des march√©s"></td>
                                        <td><input type="text" value="Cdt Oussama Atoui"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Qualit√© variable des d√©chets collect√©s"></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen" selected>Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen" selected>Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><input type="text" value="Proc√©dures de tri et contr√¥le qualit√©"></td>
                                        <td><input type="text" value="√âquipe technique"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" value="Conformit√© r√©glementaire"></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen">Moyen</option>
                                                <option value="√âlev√©" selected>√âlev√©</option>
                                            </select></td>
                                        <td><select>
                                                <option value="Faible" selected>Faible</option>
                                                <option value="Moyen">Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><input type="text" value="Veille r√©glementaire continue"></td>
                                        <td><input type="text" value="Prof. Ahmed Siala"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Suivi Personnel -->
            <div id="tab2" class="tab-content">
                <div class="section">
                    <div class="section-header">Fiche de Suivi Personnel - PRAD A12P1</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom et Pr√©nom</label>
                                <input type="text" placeholder="Nom du membre de l'√©quipe">
                            </div>
                            <div class="form-group">
                                <label>P√©riode de Suivi</label>
                                <input type="text" placeholder="Ex: 01/01/2025 - 15/01/2025">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fonction dans le Projet</label>
                                <input type="text" placeholder="R√¥le dans le projet">
                            </div>
                            <div class="form-group">
                                <label>Work Package Assign√©</label>
                                <select>
                                    <option value="">S√©lectionner...</option>
                                    <option value="WP1">WP1 - √âtude de faisabilit√©</option>
                                    <option value="WP2">WP2 - S√©lection technologies</option>
                                    <option value="WP3">WP3 - D√©veloppement formulations</option>
                                    <option value="WP4">WP4 - √âvaluation impact</option>
                                    <option value="WP5">WP5 - Validation et d√©ploiement</option>
                                    <option value="WP6">WP6 - Suivi et √©valuation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>T√¢ches Ex√©cut√©es (2 Semaines Pr√©c√©dentes)</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('taches-personnel-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('taches-personnel-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="taches-personnel-table">
                                <thead>
                                    <tr>
                                        <th>T√¢che</th>
                                        <th>Date D√©but</th>
                                        <th>Date Fin</th>
                                        <th>Statut</th>
                                        <th>Commentaires</th>
                                        <th class="upload-cell">Preuves</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="En cours">En cours</option>
                                                <option value="Termin√©">Termin√©</option>
                                                <option value="En attente">En attente</option>
                                                <option value="Bloqu√©">Bloqu√©</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Commentaires"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="En cours">En cours</option>
                                                <option value="Termin√©">Termin√©</option>
                                                <option value="En attente">En attente</option>
                                                <option value="Bloqu√©">Bloqu√©</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Commentaires"></td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>T√¢ches Pr√©vues (2 Semaines Suivantes)</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('taches-prevues-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('taches-prevues-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="taches-prevues-table">
                                <thead>
                                    <tr>
                                        <th>T√¢che</th>
                                        <th>Date D√©but Pr√©vue</th>
                                        <th>Date Fin Pr√©vue</th>
                                        <th>Priorit√©</th>
                                        <th>Ressources N√©cessaires</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="Haute">Haute</option>
                                                <option value="Moyenne">Moyenne</option>
                                                <option value="Basse">Basse</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Ressources n√©cessaires"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="Haute">Haute</option>
                                                <option value="Moyenne">Moyenne</option>
                                                <option value="Basse">Basse</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Ressources n√©cessaires"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">Difficult√©s Rencontr√©es et Besoins</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Difficult√©s Rencontr√©es</label>
                                <textarea rows="4"
                                    placeholder="D√©crire les difficult√©s rencontr√©es durant cette p√©riode"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Besoins / Demandes</label>
                                <textarea rows="4"
                                    placeholder="Lister les besoins ou demandes pour la suite du projet"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Suivi Projet -->
            <div id="tab3" class="tab-content">
                <div class="section">
                    <div class="section-header">Fiche de Suivi Projet (Bimensuel) - PRAD A12P1</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>P√©riode de Suivi</label>
                                <input type="text" placeholder="Ex: 01/01/2025 - 15/01/2025">
                            </div>
                            <div class="form-group">
                                <label>Num√©ro du Rapport</label>
                                <input type="number" placeholder="N¬∞ du rapport">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Avancement Global (%)</label>
                                <input type="number" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="form-group">
                                <label>Statut Global</label>
                                <select>
                                    <option value="En bonne voie">En bonne voie</option>
                                    <option value="Retard mineur">Retard mineur</option>
                                    <option value="Retard majeur">Retard majeur</option>
                                    <option value="Bloqu√©">Bloqu√©</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>R√©sum√© des Activit√©s (2 Semaines)</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('activites-projet-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('activites-projet-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="activites-projet-table">
                                <thead>
                                    <tr>
                                        <th>WP</th>
                                        <th>Activit√© / T√¢che</th>
                                        <th>Responsable</th>
                                        <th>Statut</th>
                                        <th>% Avancement</th>
                                        <th class="upload-cell">Livrables</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><select>
                                                <option value="WP1">WP1</option>
                                                <option value="WP2">WP2</option>
                                                <option value="WP3">WP3</option>
                                                <option value="WP4">WP4</option>
                                                <option value="WP5">WP5</option>
                                                <option value="WP6">WP6</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Description de l'activit√©"></td>
                                        <td><input type="text" placeholder="Nom du responsable"></td>
                                        <td><select>
                                                <option value="En cours">En cours</option>
                                                <option value="Termin√©">Termin√©</option>
                                                <option value="En attente">En attente</option>
                                                <option value="Bloqu√©">Bloqu√©</option>
                                            </select></td>
                                        <td><input type="number" min="0" max="100" placeholder="0-100">%</td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><select>
                                                <option value="WP1">WP1</option>
                                                <option value="WP2">WP2</option>
                                                <option value="WP3">WP3</option>
                                                <option value="WP4">WP4</option>
                                                <option value="WP5">WP5</option>
                                                <option value="WP6">WP6</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Description de l'activit√©"></td>
                                        <td><input type="text" placeholder="Nom du responsable"></td>
                                        <td><select>
                                                <option value="En cours">En cours</option>
                                                <option value="Termin√©">Termin√©</option>
                                                <option value="En attente">En attente</option>
                                                <option value="Bloqu√©">Bloqu√©</option>
                                            </select></td>
                                        <td><input type="number" min="0" max="100" placeholder="0-100">%</td>
                                        <td class="upload-cell">
                                            <div class="upload-wrapper">
                                                <div class="btn-group">
                                                    <button class="btn upload-btn" onclick="triggerUpload(this)">üìé
                                                        Joindre</button>
                                                    <button class="btn view-btn" onclick="viewFiles(this)">üëÅ
                                                        Voir</button>
                                                </div>
                                                <input type="file" class="file-input" multiple
                                                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.png,.jpg,.jpeg"
                                                    onchange="handleFileSelect(this)">
                                                <div class="file-list"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>Planning des 2 Semaines Suivantes</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('planning-projet-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('planning-projet-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="planning-projet-table">
                                <thead>
                                    <tr>
                                        <th>WP</th>
                                        <th>T√¢che Pr√©vue</th>
                                        <th>Responsable</th>
                                        <th>Date D√©but</th>
                                        <th>Date Fin</th>
                                        <th>Priorit√©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><select>
                                                <option value="WP1">WP1</option>
                                                <option value="WP2">WP2</option>
                                                <option value="WP3">WP3</option>
                                                <option value="WP4">WP4</option>
                                                <option value="WP5">WP5</option>
                                                <option value="WP6">WP6</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="text" placeholder="Nom du responsable"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="Haute">Haute</option>
                                                <option value="Moyenne">Moyenne</option>
                                                <option value="Basse">Basse</option>
                                            </select></td>
                                    </tr>
                                    <tr>
                                        <td><select>
                                                <option value="WP1">WP1</option>
                                                <option value="WP2">WP2</option>
                                                <option value="WP3">WP3</option>
                                                <option value="WP4">WP4</option>
                                                <option value="WP5">WP5</option>
                                                <option value="WP6">WP6</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Description de la t√¢che"></td>
                                        <td><input type="text" placeholder="Nom du responsable"></td>
                                        <td><input type="date"></td>
                                        <td><input type="date"></td>
                                        <td><select>
                                                <option value="Haute">Haute</option>
                                                <option value="Moyenne">Moyenne</option>
                                                <option value="Basse">Basse</option>
                                            </select></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>Risques et Points d'Attention</span>
                    </div>
                    <div class="section-content">
                        <div class="table-controls">
                            <button class="btn add-row-btn" onclick="addRow('risques-projet-table')">+ Ajouter
                                Ligne</button>
                            <button class="btn remove-row-btn" onclick="removeRow('risques-projet-table')">- Supprimer
                                Ligne</button>
                        </div>
                        <div class="table-container">
                            <table id="risques-projet-table">
                                <thead>
                                    <tr>
                                        <th>Risque / Point d'Attention</th>
                                        <th>Impact</th>
                                        <th>Probabilit√©</th>
                                        <th>Action de Mitigation</th>
                                        <th>Responsable</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" placeholder="Description du risque"></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen">Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><select>
                                                <option value="Faible">Faible</option>
                                                <option value="Moyen">Moyen</option>
                                                <option value="√âlev√©">√âlev√©</option>
                                            </select></td>
                                        <td><input type="text" placeholder="Action de mitigation"></td>
                                        <td><input type="text" placeholder="Responsable"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">D√©cisions et Actions Requises</div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>D√©cisions Prises</label>
                                <textarea rows="4"
                                    placeholder="Lister les d√©cisions prises lors de cette p√©riode"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Actions Requises de la Direction</label>
                                <textarea rows="4"
                                    placeholder="Lister les actions n√©cessitant une intervention de la direction"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="manual-save-button" onclick="saveFormData()">Enregistrer le Progr√®s</button>
        <button class="print-button" onclick="printDocument()">Imprimer le Document</button>
        <button class="validate-button" onclick="validateForm()">Valider les Champs</button>

        <!-- Full Page Export Container -->
        <div class="full-export-container">
            <label>üìÅ Exporter le Document Complet:</label>
            <button class="btn-export btn-export-full-pdf" onclick="exportFullPageAsPDF()">
                üìë Exporter Tout en PDF
            </button>
        </div>

        <!-- File Storage Export Section -->
        <div class="file-export-section" id="fileExportSection">
            <h4>üíæ Sauvegarde des Documents Joints</h4>
            <p style="margin-bottom: 15px; color: #555;">Exportez tous les documents joints et les donn√©es du formulaire
                dans un fichier unique que vous pouvez partager avec les membres de l'√©quipe.</p>

            <button class="export-doc-btn" onclick="exportAllWithFiles()">
                üì¶ Exporter Tout (Donn√©es + Documents)
            </button>
            <button class="export-doc-btn import" onclick="document.getElementById('importFileInput').click()">
                üì• Importer un Fichier de Sauvegarde
            </button>
            <input type="file" id="importFileInput" accept=".prad,.json" style="display: none;"
                onchange="importAllWithFiles(this)">

            <button class="export-doc-btn github" onclick="openGitHubFilesModal()"
                style="background: linear-gradient(135deg, #24292e 0%, #40484f 100%); margin-top: 10px;">
                üìÇ Parcourir les Documents GitHub
            </button>

            <div class="file-stats" id="fileStats">
                <div class="file-stats-item">
                    <span>üìé Documents joints:</span>
                    <span id="attachedFilesCount">0</span>
                </div>
                <div class="file-stats-item">
                    <span>üìä Taille totale:</span>
                    <span id="totalFilesSize">0 KB</span>
                </div>
                <div class="file-stats-item">
                    <span>üìÖ Derni√®re sauvegarde:</span>
                    <span id="lastSaveDate">Jamais</span>
                </div>
            </div>
        </div>

        <!-- Export Progress Overlay -->
        <div class="export-progress-overlay" id="exportProgressOverlay">
            <div class="export-progress-box">
                <h3>üìÑ Exportation du Document PDF</h3>
                <div class="export-progress-bar">
                    <div class="export-progress-fill" id="exportProgressFill"></div>
                </div>
                <div class="export-progress-text" id="exportProgressText">Pr√©paration...</div>
            </div>
        </div>

        <div class="modified-counter" id="modifiedCounter" onclick="showModifiedFields()">
            <span id="modifiedCount">0</span> champ(s) modifi√©(s)
        </div>

        <!-- Validation Panel -->
        <div class="validation-panel" id="validationPanel">
            <div class="validation-panel-header">
                <span class="validation-panel-title">√âtat de Validation</span>
                <span class="validation-panel-close" onclick="closeValidationPanel()">&times;</span>
            </div>
            <div id="validationContent"></div>
        </div>

        <div class="save-indicator" id="saveIndicator">‚úì Donn√©es sauvegard√©es</div>

        <!-- Modal for viewing files -->
        <div id="fileViewerModal" class="modal">
            <div class="modal-content" style="max-width: 95vw; width: 1200px; max-height: 95vh;">
                <div class="modal-header">
                    <h3 id="modalTitle">Documents Joints</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="downloadCurrentBtn" class="btn"
                            style="display: none; background: #28a745; color: white;" onclick="downloadCurrentFile()">‚¨áÔ∏è
                            T√©l√©charger</button>
                        <button id="prevFileBtn" class="btn" style="display: none;" onclick="navigateFile(-1)">‚óÄ
                            Pr√©c√©dent</button>
                        <button id="nextFileBtn" class="btn" style="display: none;" onclick="navigateFile(1)">Suivant
                            ‚ñ∂</button>
                        <span class="modal-close" onclick="closeModal()">&times;</span>
                    </div>
                </div>
                <div style="display: flex; height: calc(95vh - 100px);">
                    <div id="modalBody" style="flex: 1; overflow: auto; padding: 20px; background: #e0e0e0;">
                        <p>Aucun document joint.</p>
                    </div>
                    <div id="fileListSidebar"
                        style="width: 280px; border-left: 1px solid #ddd; overflow-y: auto; background: #f8f9fa; padding: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #1a3a5c;">üìé Documents joints</h4>
                        <div id="fileListContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Tab functionality
            function openTab(evt, tabName) {
                var i, tabcontent, tabbuttons;

                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].classList.remove("active");
                }

                tabbuttons = document.getElementsByClassName("tab-button");
                for (i = 0; i < tabbuttons.length; i++) {
                    tabbuttons[i].classList.remove("active");
                }

                document.getElementById(tabName).classList.add("active");
                evt.currentTarget.classList.add("active");
            }

            // File upload functionality
            function triggerUpload(button) {
                const wrapper = button.closest('.upload-wrapper');
                const fileInput = wrapper.querySelector('.file-input');
                fileInput.click();
            }

            // Store files for viewing
            const fileStorage = new Map();

            function handleFileSelect(input) {
                const wrapper = input.closest('.upload-wrapper');
                const fileList = wrapper.querySelector('.file-list');
                const files = input.files;

                // Get or create storage key for this input
                const storageKey = input.id || 'file_' + Math.random().toString(36).substr(2, 9);
                input.id = storageKey;

                if (!fileStorage.has(storageKey)) {
                    fileStorage.set(storageKey, []);
                }

                const storedFiles = fileStorage.get(storageKey);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    storedFiles.push(file);

                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                    <span class="file-name" title="${file.name}" onclick="previewFile('${storageKey}', ${storedFiles.length - 1})">${file.name}</span>
                    <span class="file-remove" onclick="removeFile(this, '${storageKey}', ${storedFiles.length - 1})">√ó</span>
                `;
                    fileList.appendChild(fileItem);
                }
            }

            function removeFile(element, storageKey, index) {
                const storedFiles = fileStorage.get(storageKey);
                if (storedFiles) {
                    storedFiles[index] = null;
                }
                element.parentElement.remove();
            }

            // Global variables for file navigation
            let currentStorageKey = null;
            let currentFileIndex = 0;
            let currentFiles = [];

            function viewFiles(button) {
                const wrapper = button.closest('.upload-wrapper');
                const fileInput = wrapper.querySelector('.file-input');
                const storageKey = fileInput.id;
                const storedFiles = fileStorage.get(storageKey);

                currentStorageKey = storageKey;
                currentFiles = storedFiles ? storedFiles.filter(f => f !== null) : [];
                currentFileIndex = 0;

                const modal = document.getElementById('fileViewerModal');
                const modalBody = document.getElementById('modalBody');
                const fileListContent = document.getElementById('fileListContent');

                // Hide navigation buttons initially
                document.getElementById('downloadCurrentBtn').style.display = 'none';
                document.getElementById('prevFileBtn').style.display = 'none';
                document.getElementById('nextFileBtn').style.display = 'none';

                if (!currentFiles || currentFiles.length === 0) {
                    modalBody.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;"><p>Aucun document joint. Utilisez le bouton "Joindre" pour ajouter des fichiers.</p></div>';
                    fileListContent.innerHTML = '<p style="color: #666; font-size: 0.9rem;">Aucun fichier</p>';
                } else {
                    // Build file list sidebar
                    let listHtml = '';
                    currentFiles.forEach((file, index) => {
                        if (file) {
                            const icon = getFileIcon(file.name);
                            listHtml += `
                            <div id="fileItem_${index}" style="display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 8px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid ${index === 0 ? '#2196f3' : 'transparent'};" onclick="showFileInModal(${index})">
                                <span style="font-size: 1.5rem;">${icon}</span>
                                <div style="overflow: hidden;">
                                    <div style="font-weight: 600; color: #1a3a5c; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                                    <div style="font-size: 0.75rem; color: #666;">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                        `;
                        }
                    });
                    fileListContent.innerHTML = listHtml;

                    // Show first file
                    showFileInModal(0);

                    // Show navigation buttons if multiple files
                    if (currentFiles.length > 1) {
                        document.getElementById('prevFileBtn').style.display = 'inline-block';
                        document.getElementById('nextFileBtn').style.display = 'inline-block';
                    }
                }

                modal.style.display = 'block';
            }

            function showFileInModal(index) {
                if (!currentFiles || index < 0 || index >= currentFiles.length) return;

                currentFileIndex = index;
                const file = currentFiles[index];
                const modalBody = document.getElementById('modalBody');

                // Update sidebar selection
                document.querySelectorAll('[id^="fileItem_"]').forEach((item, i) => {
                    item.style.border = i === index ? '2px solid #2196f3' : '2px solid transparent';
                });

                // Update modal title
                document.getElementById('modalTitle').textContent = file.name;
                document.getElementById('downloadCurrentBtn').style.display = 'inline-block';

                // Get file URL
                let url;
                let fileType = file.type || '';

                if (file instanceof File || file instanceof Blob) {
                    url = URL.createObjectURL(file);
                } else if (file.data && file.data.startsWith('data:')) {
                    url = file.data;
                    if (!fileType) {
                        const match = file.data.match(/^data:([^;]+);/);
                        if (match) fileType = match[1];
                    }
                } else {
                    modalBody.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;"><p>Impossible de charger ce fichier.</p></div>';
                    return;
                }

                // Determine file type from extension if not available
                if (!fileType && file.name) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const mimeTypes = {
                        'pdf': 'application/pdf',
                        'png': 'image/png',
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'gif': 'image/gif'
                    };
                    fileType = mimeTypes[ext] || '';
                }

                // Display content based on file type
                if (fileType.startsWith('image/')) {
                    modalBody.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;"></div>`;
                } else if (fileType === 'application/pdf') {
                    modalBody.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                } else {
                    // For other files, show download option
                    const icon = getFileIcon(file.name);
                    modalBody.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; gap: 20px;">
                        <span style="font-size: 5rem;">${icon}</span>
                        <p style="color: #666; font-size: 1.1rem;">${file.name}</p>
                        <p style="color: #999;">${formatFileSize(file.size)}</p>
                        <p style="color: #666;">Ce type de fichier ne peut pas √™tre pr√©visualis√© dans le navigateur.</p>
                        <button class="btn" style="background: #28a745; color: white; padding: 12px 24px;" onclick="downloadCurrentFile()">‚¨áÔ∏è T√©l√©charger le fichier</button>
                    </div>
                `;
                }
            }

            function navigateFile(direction) {
                const newIndex = currentFileIndex + direction;
                if (newIndex >= 0 && newIndex < currentFiles.length) {
                    showFileInModal(newIndex);
                }
            }

            function downloadCurrentFile() {
                if (!currentFiles || currentFileIndex < 0 || currentFileIndex >= currentFiles.length) return;

                const file = currentFiles[currentFileIndex];
                let url;

                if (file instanceof File || file instanceof Blob) {
                    url = URL.createObjectURL(file);
                } else if (file.data && file.data.startsWith('data:')) {
                    url = file.data;
                } else {
                    alert('Impossible de t√©l√©charger ce fichier.');
                    return;
                }

                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            function previewFile(storageKey, index) {
                const storedFiles = fileStorage.get(storageKey);
                if (storedFiles && storedFiles[index]) {
                    const file = storedFiles[index];
                    let url;
                    let fileType = file.type || '';
                    let fileName = file.name || 'document';

                    // Check if file is a native File/Blob object or a Base64 stored object
                    if (file instanceof File || file instanceof Blob) {
                        url = URL.createObjectURL(file);
                    } else if (file.data && file.data.startsWith('data:')) {
                        // File was restored from localStorage (Base64 format)
                        url = file.data;
                        // Extract type from data URL if not available
                        if (!fileType) {
                            const match = file.data.match(/^data:([^;]+);/);
                            if (match) fileType = match[1];
                        }
                    } else {
                        console.error('Unknown file format:', file);
                        alert('Impossible d\'ouvrir ce fichier. Format non reconnu.');
                        return;
                    }

                    // Determine file type from extension if not available
                    if (!fileType && fileName) {
                        const ext = fileName.split('.').pop().toLowerCase();
                        const mimeTypes = {
                            'pdf': 'application/pdf',
                            'png': 'image/png',
                            'jpg': 'image/jpeg',
                            'jpeg': 'image/jpeg',
                            'gif': 'image/gif',
                            'doc': 'application/msword',
                            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                            'ppt': 'application/vnd.ms-powerpoint',
                            'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                            'xls': 'application/vnd.ms-excel',
                            'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        };
                        fileType = mimeTypes[ext] || 'application/octet-stream';
                    }

                    // Open in new window for preview
                    const newWindow = window.open('', '_blank');

                    if (!newWindow) {
                        alert('Le navigateur a bloqu√© l\'ouverture de la fen√™tre. Veuillez autoriser les popups pour ce site.');
                        return;
                    }

                    if (fileType.startsWith('image/')) {
                        newWindow.document.write(`
                        <html>
                        <head><title>${fileName}</title></head>
                        <body style="margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #333;">
                            <img src="${url}" style="max-width: 100%; max-height: 100vh;">
                        </body>
                        </html>
                    `);
                    } else if (fileType === 'application/pdf') {
                        // For PDFs, create an embed or iframe
                        newWindow.document.write(`
                        <html>
                        <head><title>${fileName}</title></head>
                        <body style="margin: 0; height: 100vh;">
                            <embed src="${url}" type="application/pdf" width="100%" height="100%" style="border: none;">
                        </body>
                        </html>
                    `);
                    } else {
                        // For other files, trigger download
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        newWindow.close();
                    }
                }
            }

            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'üìÑ',
                    'doc': 'üìù',
                    'docx': 'üìù',
                    'ppt': 'üìä',
                    'pptx': 'üìä',
                    'xls': 'üìà',
                    'xlsx': 'üìà',
                    'png': 'üñºÔ∏è',
                    'jpg': 'üñºÔ∏è',
                    'jpeg': 'üñºÔ∏è',
                    'gif': 'üñºÔ∏è'
                };
                return icons[ext] || 'üìÅ';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function closeModal() {
                document.getElementById('fileViewerModal').style.display = 'none';
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById('fileViewerModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }

            // Add row to table
            function addRow(tableId) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const lastRow = tbody.querySelector('tr:last-child');

                if (lastRow) {
                    const newRow = lastRow.cloneNode(true);
                    // Clear input values
                    newRow.querySelectorAll('input').forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else if (input.type !== 'file') {
                            input.value = '';
                        }
                    });
                    newRow.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });
                    newRow.querySelectorAll('.file-list').forEach(list => {
                        list.innerHTML = '';
                    });
                    // Generate new ID for file input
                    newRow.querySelectorAll('.file-input').forEach(input => {
                        input.id = 'file_' + Math.random().toString(36).substr(2, 9);
                    });
                    tbody.appendChild(newRow);
                }
            }

            // Remove last row from table
            function removeRow(tableId) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');

                if (rows.length > 1) {
                    rows[rows.length - 1].remove();
                } else {
                    alert('Impossible de supprimer la derni√®re ligne.');
                }
            }

            // Add column to table
            function addColumn(tableId) {
                const table = document.getElementById(tableId);
                const headerRow = table.querySelector('thead tr');
                const bodyRows = table.querySelectorAll('tbody tr');

                // Prompt for column name
                const columnName = prompt('Nom de la nouvelle colonne:');
                if (columnName) {
                    // Add header
                    const th = document.createElement('th');
                    th.textContent = columnName;
                    headerRow.appendChild(th);

                    // Add cells to each row
                    bodyRows.forEach(row => {
                        const td = document.createElement('td');
                        td.innerHTML = '<input type="text" placeholder="">';
                        row.appendChild(td);
                    });
                }
            }

            // Auto-save functionality - uses stable IDs for reliable data persistence
            function saveFormData() {
                const inputs = document.querySelectorAll('input, textarea, select');
                const formData = {};

                // Assign stable IDs to inputs that don't have one
                inputs.forEach((input, index) => {
                    if (!input.id && input.type !== 'file') {
                        // Create a stable ID based on position and parent context
                        const parent = input.closest('section, .form-section, table, .card');
                        const parentId = parent ? (parent.id || parent.className.split(' ')[0]) : 'root';
                        const siblingIndex = Array.from(input.parentElement.children).indexOf(input);
                        input.id = `auto_${parentId}_${index}_${siblingIndex}`;
                    }
                });

                inputs.forEach((input, index) => {
                    // Use ID if available, otherwise use index as fallback
                    const key = input.id || `idx_${index}`;
                    if (input.type === 'checkbox') {
                        formData[key] = input.checked;
                    } else if (input.type !== 'file') {
                        formData[key] = input.value;
                    }
                });

                localStorage.setItem('ficheProjetPRAD_v3', JSON.stringify(formData));

                // Also save to v2 for backward compatibility
                const formDataV2 = {};
                inputs.forEach((input, index) => {
                    if (input.type === 'checkbox') {
                        formDataV2[index] = input.checked;
                    } else if (input.type !== 'file') {
                        formDataV2[index] = input.value;
                    }
                });
                localStorage.setItem('ficheProjetPRAD_v2', JSON.stringify(formDataV2));

                // Save GitHub file associations if they exist
                if (typeof githubFileAssociations !== 'undefined') {
                    const associationsObj = {};
                    githubFileAssociations.forEach((value, key) => {
                        associationsObj[key] = value;
                    });
                    localStorage.setItem('githubFileAssociations', JSON.stringify(associationsObj));
                }

                // Show save indicator
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            // Load saved data - tries v3 (ID-based) first, then falls back to v2 (index-based)
            function loadFormData() {
                const inputs = document.querySelectorAll('input, textarea, select');

                // First, assign stable IDs to inputs (same logic as saveFormData)
                inputs.forEach((input, index) => {
                    if (!input.id && input.type !== 'file') {
                        const parent = input.closest('section, .form-section, table, .card');
                        const parentId = parent ? (parent.id || parent.className.split(' ')[0]) : 'root';
                        const siblingIndex = Array.from(input.parentElement.children).indexOf(input);
                        input.id = `auto_${parentId}_${index}_${siblingIndex}`;
                    }
                });

                // Try to load v3 format first (ID-based)
                const savedDataV3 = localStorage.getItem('ficheProjetPRAD_v3');
                if (savedDataV3) {
                    const formData = JSON.parse(savedDataV3);
                    let loadedCount = 0;

                    inputs.forEach((input, index) => {
                        const key = input.id || `idx_${index}`;
                        if (formData[key] !== undefined) {
                            if (input.type === 'checkbox') {
                                input.checked = formData[key];
                            } else if (input.type !== 'file') {
                                input.value = formData[key];
                            }
                            loadedCount++;
                        }
                    });

                    if (loadedCount > 0) {
                        console.log('Loaded ' + loadedCount + ' fields from v3 format');
                        return;
                    }
                }

                // Fall back to v2 format (index-based)
                const savedDataV2 = localStorage.getItem('ficheProjetPRAD_v2');
                if (savedDataV2) {
                    const formData = JSON.parse(savedDataV2);

                    inputs.forEach((input, index) => {
                        if (formData[index] !== undefined) {
                            if (input.type === 'checkbox') {
                                input.checked = formData[index];
                            } else if (input.type !== 'file') {
                                input.value = formData[index];
                            }
                        }
                    });
                    console.log('Loaded data from v2 format (legacy)');
                }
            }

            // Auto-save every 30 seconds
            setInterval(saveFormData, 30000);

            // Save on input change
            document.addEventListener('input', function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    clearTimeout(window.saveTimeout);
                    window.saveTimeout = setTimeout(saveFormData, 1000);
                }
            });

            // Initialize file inputs with unique IDs
            document.querySelectorAll('.file-input').forEach(input => {
                if (!input.id) {
                    input.id = 'file_' + Math.random().toString(36).substr(2, 9);
                }
            });

            // ========== VALIDATION AND MODIFIED FIELDS SYSTEM ==========

            // Store for tracking original values (after last save)
            let savedFieldValues = new Map();
            let modifiedFields = new Set();

            // Initialize saved values on page load
            function initializeSavedValues() {
                const inputs = document.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea, select');
                inputs.forEach((input, index) => {
                    const key = getFieldKey(input, index);
                    savedFieldValues.set(key, input.value);
                });

                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    const key = 'cb_' + index;
                    savedFieldValues.set(key, cb.checked);
                });
            }

            // Get unique key for a field
            function getFieldKey(input, index) {
                return input.dataset.fieldName || input.name || 'field_' + index;
            }

            // Track field modifications
            function trackFieldModification(input) {
                const inputs = document.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea, select');
                const index = Array.from(inputs).indexOf(input);
                const key = getFieldKey(input, index);
                const savedValue = savedFieldValues.get(key);

                if (input.value !== savedValue) {
                    input.classList.add('field-modified');
                    modifiedFields.add(key);
                } else {
                    input.classList.remove('field-modified');
                    modifiedFields.delete(key);
                }

                updateModifiedCounter();
            }

            // Track checkbox modifications
            function trackCheckboxModification(checkbox) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const index = Array.from(checkboxes).indexOf(checkbox);
                const key = 'cb_' + index;
                const savedValue = savedFieldValues.get(key);

                if (checkbox.checked !== savedValue) {
                    checkbox.parentElement.classList.add('field-modified');
                    modifiedFields.add(key);
                } else {
                    checkbox.parentElement.classList.remove('field-modified');
                    modifiedFields.delete(key);
                }

                updateModifiedCounter();
            }

            // Update modified fields counter
            function updateModifiedCounter() {
                const counter = document.getElementById('modifiedCounter');
                const countSpan = document.getElementById('modifiedCount');

                if (modifiedFields.size > 0) {
                    countSpan.textContent = modifiedFields.size;
                    counter.classList.add('show');
                } else {
                    counter.classList.remove('show');
                }
            }

            // Show modified fields in panel
            function showModifiedFields() {
                const panel = document.getElementById('validationPanel');
                const content = document.getElementById('validationContent');

                if (modifiedFields.size === 0) {
                    content.innerHTML = '<div class="validation-item"><span class="validation-icon valid">‚úì</span> Aucun champ modifi√©</div>';
                } else {
                    let html = '<div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Champs modifi√©s depuis la derni√®re sauvegarde:</div>';
                    modifiedFields.forEach(key => {
                        const fieldName = key.startsWith('cb_') ? 'Case √† cocher ' + key.replace('cb_', '') : key;
                        html += `<div class="validation-item"><span class="validation-icon modified">‚óè</span> ${fieldName}</div>`;
                    });
                    html += '<button class="btn upload-btn" style="margin-top: 15px; width: 100%;" onclick="saveAndClearModified()">Sauvegarder maintenant</button>';
                    content.innerHTML = html;
                }

                panel.classList.add('show');
            }

            // Save and clear modified indicators
            function saveAndClearModified() {
                saveFormData();

                // Update saved values
                const inputs = document.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea, select');
                inputs.forEach((input, index) => {
                    const key = getFieldKey(input, index);
                    savedFieldValues.set(key, input.value);
                    input.classList.remove('field-modified');
                });

                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    const key = 'cb_' + index;
                    savedFieldValues.set(key, cb.checked);
                    cb.parentElement.classList.remove('field-modified');
                });

                modifiedFields.clear();
                updateModifiedCounter();
                closeValidationPanel();
            }

            // Validate form
            function validateForm() {
                const panel = document.getElementById('validationPanel');
                const content = document.getElementById('validationContent');

                const requiredFields = document.querySelectorAll('[required]');
                let invalidFields = [];
                let validFields = [];

                requiredFields.forEach(field => {
                    const fieldName = field.dataset.fieldName || 'Champ';
                    if (!field.value || field.value.trim() === '') {
                        field.classList.add('invalid');
                        invalidFields.push(fieldName);
                    } else {
                        field.classList.remove('invalid');
                        validFields.push(fieldName);
                    }
                });

                let html = '';

                if (invalidFields.length === 0) {
                    html = '<div style="text-align: center; padding: 20px;"><span style="font-size: 3rem;">‚úÖ</span><p style="margin-top: 10px; font-weight: 600; color: #28a745;">Tous les champs obligatoires sont remplis!</p></div>';
                } else {
                    html = '<div style="font-size: 0.85rem; color: #dc3545; margin-bottom: 10px; font-weight: 600;">' + invalidFields.length + ' champ(s) obligatoire(s) non rempli(s):</div>';
                    invalidFields.forEach(name => {
                        html += `<div class="validation-item"><span class="validation-icon invalid">‚úó</span> ${name}</div>`;
                    });

                    if (validFields.length > 0) {
                        html += '<div style="font-size: 0.85rem; color: #28a745; margin: 15px 0 10px 0; font-weight: 600;">' + validFields.length + ' champ(s) valide(s):</div>';
                        validFields.forEach(name => {
                            html += `<div class="validation-item"><span class="validation-icon valid">‚úì</span> ${name}</div>`;
                        });
                    }
                }

                // Add modified fields info
                if (modifiedFields.size > 0) {
                    html += '<div style="font-size: 0.85rem; color: #ffc107; margin: 15px 0 10px 0; font-weight: 600;">' + modifiedFields.size + ' champ(s) modifi√©(s) non sauvegard√©(s)</div>';
                }

                content.innerHTML = html;
                panel.classList.add('show');
            }

            // Close validation panel
            function closeValidationPanel() {
                document.getElementById('validationPanel').classList.remove('show');
            }

            // Add event listeners for field modification tracking
            document.addEventListener('input', function (e) {
                if (e.target.tagName === 'INPUT' && e.target.type !== 'file' && e.target.type !== 'checkbox') {
                    trackFieldModification(e.target);
                } else if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    trackFieldModification(e.target);
                }
            });

            document.addEventListener('change', function (e) {
                if (e.target.type === 'checkbox') {
                    trackCheckboxModification(e.target);
                }
            });

            // Initialize saved values after page load
            window.addEventListener('load', function () {
                setTimeout(initializeSavedValues, 500);
            });

            // Update saved values after auto-save
            const originalSaveFormData = saveFormData;
            saveFormData = function () {
                originalSaveFormData();

                // Clear modified indicators after save
                const inputs = document.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea, select');
                inputs.forEach((input, index) => {
                    const key = getFieldKey(input, index);
                    savedFieldValues.set(key, input.value);
                    input.classList.remove('field-modified');
                });

                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach((cb, index) => {
                    const key = 'cb_' + index;
                    savedFieldValues.set(key, cb.checked);
                    cb.parentElement.classList.remove('field-modified');
                });

                modifiedFields.clear();
                updateModifiedCounter();
            };

            // ========== MILESTONE LINES SYSTEM ==========

            let milestones = [];
            let milestoneIdCounter = 0;
            let draggingMilestone = null;

            // Month mapping for Gantt chart
            const ganttMonths = [
                { year: 2024, month: 9, label: 'S' },
                { year: 2024, month: 10, label: 'O' },
                { year: 2024, month: 11, label: 'N' },
                { year: 2024, month: 12, label: 'D' },
                { year: 2025, month: 1, label: 'J' },
                { year: 2025, month: 2, label: 'F' },
                { year: 2025, month: 3, label: 'M' },
                { year: 2025, month: 4, label: 'A' },
                { year: 2025, month: 5, label: 'M' },
                { year: 2025, month: 6, label: 'J' },
                { year: 2025, month: 7, label: 'J' },
                { year: 2025, month: 8, label: 'A' },
                { year: 2025, month: 9, label: 'S' },
                { year: 2025, month: 10, label: 'O' },
                { year: 2025, month: 11, label: 'N' },
                { year: 2025, month: 12, label: 'D' },
                { year: 2026, month: 1, label: 'J' },
                { year: 2026, month: 2, label: 'F' },
                { year: 2026, month: 3, label: 'M' },
                { year: 2026, month: 4, label: 'A' },
                { year: 2026, month: 5, label: 'M' },
                { year: 2026, month: 6, label: 'J' },
                { year: 2026, month: 7, label: 'J' },
                { year: 2026, month: 8, label: 'A' },
                { year: 2026, month: 9, label: 'S' },
                { year: 2026, month: 10, label: 'O' },
                { year: 2026, month: 11, label: 'N' },
                { year: 2026, month: 12, label: 'D' },
                { year: 2027, month: 1, label: 'J' },
                { year: 2027, month: 2, label: 'F' },
                { year: 2027, month: 3, label: 'M' },
                { year: 2027, month: 4, label: 'A' },
                { year: 2027, month: 5, label: 'M' },
                { year: 2027, month: 6, label: 'J' },
                { year: 2027, month: 7, label: 'J' },
                { year: 2027, month: 8, label: 'A' },
                { year: 2027, month: 9, label: 'S' }
            ];

            function addMilestone() {
                const id = ++milestoneIdCounter;
                const today = new Date();
                const defaultDate = today.toISOString().split('T')[0];

                const milestone = {
                    id: id,
                    name: 'R√©union d\'√âvaluation ' + id,
                    date: defaultDate,
                    color: '#ff6b6b',
                    fixed: false
                };

                milestones.push(milestone);
                renderMilestoneList();
                renderMilestoneLines();
            }

            function removeMilestone(id) {
                milestones = milestones.filter(m => m.id !== id);
                renderMilestoneList();
                renderMilestoneLines();
            }

            function updateMilestone(id, field, value) {
                const milestone = milestones.find(m => m.id === id);
                if (milestone) {
                    milestone[field] = value;
                    renderMilestoneLines();
                }
            }

            function toggleMilestoneFixed(id) {
                const milestone = milestones.find(m => m.id === id);
                if (milestone) {
                    milestone.fixed = !milestone.fixed;
                    renderMilestoneList();
                    renderMilestoneLines();
                }
            }

            function renderMilestoneList() {
                const list = document.getElementById('milestoneList');
                list.innerHTML = '';

                milestones.forEach(m => {
                    const item = document.createElement('div');
                    item.className = 'milestone-item';
                    item.innerHTML = `
                    <input type="color" class="milestone-color" value="${m.color}" 
                           onchange="updateMilestone(${m.id}, 'color', this.value)" title="Couleur">
                    <input type="text" value="${m.name}" 
                           onchange="updateMilestone(${m.id}, 'name', this.value)" placeholder="Nom de la r√©union">
                    <input type="date" value="${m.date}" 
                           onchange="updateMilestone(${m.id}, 'date', this.value)">
                    <button class="milestone-toggle ${m.fixed ? 'fixed' : ''}" 
                            onclick="toggleMilestoneFixed(${m.id})">
                        ${m.fixed ? 'üîí Fix√©e' : 'üîì Mobile'}
                    </button>
                    <button class="milestone-delete" onclick="removeMilestone(${m.id})" title="Supprimer">√ó</button>
                `;
                    list.appendChild(item);
                });
            }

            function renderMilestoneLines() {
                // Remove existing lines
                document.querySelectorAll('.milestone-line').forEach(el => el.remove());

                const ganttTable = document.getElementById('gantt-table');
                if (!ganttTable) return;

                const tableContainer = ganttTable.closest('.table-container');
                if (!tableContainer) return;

                // Make container relative for absolute positioning
                tableContainer.style.position = 'relative';

                const headerCells = ganttTable.querySelectorAll('thead tr:last-child th');
                if (headerCells.length < 2) return;

                // Get the first data cell position (skip the Work Package column)
                const firstDataCell = headerCells[1];
                const tableRect = ganttTable.getBoundingClientRect();
                const containerRect = tableContainer.getBoundingClientRect();

                milestones.forEach(m => {
                    const date = new Date(m.date);
                    const monthIndex = getMonthIndex(date);

                    if (monthIndex >= 0 && monthIndex < ganttMonths.length) {
                        // Calculate position based on month index
                        const cells = ganttTable.querySelectorAll('thead tr:last-child th');
                        if (cells.length > monthIndex + 1) {
                            const targetCell = cells[monthIndex + 1]; // +1 to skip WP column
                            const cellRect = targetCell.getBoundingClientRect();

                            // Calculate day offset within month
                            const dayOfMonth = date.getDate();
                            const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                            const dayOffset = (dayOfMonth / daysInMonth) * cellRect.width;

                            const leftPos = cellRect.left - containerRect.left + tableContainer.scrollLeft + dayOffset;

                            const line = document.createElement('div');
                            line.className = 'milestone-line ' + (m.fixed ? 'fixed' : 'blinking');
                            line.style.left = leftPos + 'px';
                            line.style.backgroundColor = m.color;
                            line.style.height = (ganttTable.offsetHeight) + 'px';
                            line.dataset.milestoneId = m.id;

                            line.innerHTML = `
                            <div class="milestone-label" style="background: ${m.color}">${m.name}</div>
                            <div class="milestone-date-label" style="background: ${m.color}">${formatDate(date)}</div>
                        `;

                            // Add drag functionality if not fixed
                            if (!m.fixed) {
                                line.addEventListener('mousedown', startDrag);
                            }

                            tableContainer.appendChild(line);
                        }
                    }
                });
            }

            function getMonthIndex(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // JavaScript months are 0-indexed

                for (let i = 0; i < ganttMonths.length; i++) {
                    if (ganttMonths[i].year === year && ganttMonths[i].month === month) {
                        return i;
                    }
                }
                return -1;
            }

            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            function startDrag(e) {
                const line = e.target.closest('.milestone-line');
                if (!line) return;

                const milestoneId = parseInt(line.dataset.milestoneId);
                const milestone = milestones.find(m => m.id === milestoneId);

                if (milestone && !milestone.fixed) {
                    draggingMilestone = {
                        id: milestoneId,
                        line: line,
                        startX: e.clientX
                    };

                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                    e.preventDefault();
                }
            }

            function onDrag(e) {
                if (!draggingMilestone) return;

                const ganttTable = document.getElementById('gantt-table');
                const tableContainer = ganttTable.closest('.table-container');
                const containerRect = tableContainer.getBoundingClientRect();

                let newLeft = e.clientX - containerRect.left + tableContainer.scrollLeft;

                // Constrain to table bounds
                const cells = ganttTable.querySelectorAll('thead tr:last-child th');
                if (cells.length > 1) {
                    const firstCell = cells[1];
                    const lastCell = cells[cells.length - 1];
                    const minLeft = firstCell.getBoundingClientRect().left - containerRect.left + tableContainer.scrollLeft;
                    const maxLeft = lastCell.getBoundingClientRect().right - containerRect.left + tableContainer.scrollLeft;

                    newLeft = Math.max(minLeft, Math.min(maxLeft, newLeft));
                }

                draggingMilestone.line.style.left = newLeft + 'px';

                // Update date based on position
                const newDate = getDateFromPosition(newLeft, ganttTable, tableContainer);
                if (newDate) {
                    const milestone = milestones.find(m => m.id === draggingMilestone.id);
                    if (milestone) {
                        milestone.date = newDate.toISOString().split('T')[0];

                        // Update labels
                        const label = draggingMilestone.line.querySelector('.milestone-date-label');
                        if (label) {
                            label.textContent = formatDate(newDate);
                        }
                    }
                }
            }

            function stopDrag() {
                if (draggingMilestone) {
                    renderMilestoneList();
                    draggingMilestone = null;
                }
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
            }

            function getDateFromPosition(leftPos, ganttTable, tableContainer) {
                const containerRect = tableContainer.getBoundingClientRect();
                const cells = ganttTable.querySelectorAll('thead tr:last-child th');

                for (let i = 1; i < cells.length; i++) {
                    const cell = cells[i];
                    const cellRect = cell.getBoundingClientRect();
                    const cellLeft = cellRect.left - containerRect.left + tableContainer.scrollLeft;
                    const cellRight = cellLeft + cellRect.width;

                    if (leftPos >= cellLeft && leftPos <= cellRight) {
                        const monthData = ganttMonths[i - 1];
                        if (monthData) {
                            // Calculate day based on position within cell
                            const posInCell = leftPos - cellLeft;
                            const cellWidth = cellRect.width;
                            const daysInMonth = new Date(monthData.year, monthData.month, 0).getDate();
                            const day = Math.max(1, Math.min(daysInMonth, Math.round((posInCell / cellWidth) * daysInMonth)));

                            return new Date(monthData.year, monthData.month - 1, day);
                        }
                    }
                }
                return null;
            }

            // Initialize with one default milestone
            window.addEventListener('load', function () {
                // Add a default evaluation meeting line
                setTimeout(() => {
                    addMilestone();
                    // Set default date to January 2025
                    if (milestones.length > 0) {
                        milestones[0].name = 'R√©union d\'√âvaluation Trimestrielle';
                        milestones[0].date = '2025-01-15';
                        renderMilestoneList();
                        renderMilestoneLines();
                    }
                }, 100);
            });

            // Re-render lines on scroll
            document.querySelector('.table-container')?.addEventListener('scroll', renderMilestoneLines);

            // Re-render on window resize
            window.addEventListener('resize', renderMilestoneLines);

            // ========== GANTT CHART EXPORT FUNCTIONS ==========

            function showExportLoading(show) {
                const loading = document.getElementById('exportLoading');
                if (show) {
                    loading.classList.add('show');
                } else {
                    loading.classList.remove('show');
                }
            }

            function getGanttElement() {
                // Get the Gantt section including the table and legend
                const ganttSection = document.querySelector('#tab1 .section:has(#gantt-table)');
                if (!ganttSection) {
                    // Fallback: get just the table container
                    return document.getElementById('gantt-table')?.closest('.table-container');
                }
                return ganttSection;
            }

            async function exportGanttAsPNG() {
                showExportLoading(true);

                try {
                    const ganttElement = getGanttElement();
                    if (!ganttElement) {
                        alert('Diagramme de Gantt non trouv√©.');
                        showExportLoading(false);
                        return;
                    }

                    // Temporarily hide export controls and milestone controls for clean export
                    const exportControls = document.querySelector('.gantt-export-controls');
                    const milestoneContainer = document.getElementById('milestoneContainer');
                    const originalExportDisplay = exportControls ? exportControls.style.display : '';
                    const originalMilestoneDisplay = milestoneContainer ? milestoneContainer.style.display : '';

                    if (exportControls) exportControls.style.display = 'none';
                    if (milestoneContainer) milestoneContainer.style.display = 'none';

                    // Use html2canvas to capture the element
                    const canvas = await html2canvas(ganttElement, {
                        backgroundColor: '#ffffff',
                        scale: 2, // Higher resolution
                        useCORS: true,
                        logging: false,
                        windowWidth: ganttElement.scrollWidth,
                        windowHeight: ganttElement.scrollHeight
                    });

                    // Restore visibility
                    if (exportControls) exportControls.style.display = originalExportDisplay;
                    if (milestoneContainer) milestoneContainer.style.display = originalMilestoneDisplay;

                    // Create download link
                    const link = document.createElement('a');
                    link.download = 'Gantt_PRAD_A12P1_' + new Date().toISOString().split('T')[0] + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    showExportLoading(false);
                } catch (error) {
                    console.error('Erreur lors de l\'export PNG:', error);
                    alert('Erreur lors de l\'export PNG. Veuillez r√©essayer.');
                    showExportLoading(false);
                }
            }

            async function exportGanttAsSVG() {
                showExportLoading(true);

                try {
                    const ganttTable = document.getElementById('gantt-table');
                    if (!ganttTable) {
                        alert('Diagramme de Gantt non trouv√©.');
                        showExportLoading(false);
                        return;
                    }

                    // Create SVG from the table
                    const svg = createSVGFromGantt(ganttTable);

                    // Create download link
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'Gantt_PRAD_A12P1_' + new Date().toISOString().split('T')[0] + '.svg';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);

                    showExportLoading(false);
                } catch (error) {
                    console.error('Erreur lors de l\'export SVG:', error);
                    alert('Erreur lors de l\'export SVG. Veuillez r√©essayer.');
                    showExportLoading(false);
                }
            }

            function createSVGFromGantt(table) {
                const rows = table.querySelectorAll('tbody tr');
                const headerCells = table.querySelectorAll('thead tr:last-child th');

                const cellWidth = 30;
                const cellHeight = 40;
                const wpColumnWidth = 200;
                const headerHeight = 60;
                const padding = 20;

                const totalWidth = wpColumnWidth + (headerCells.length - 1) * cellWidth + padding * 2;
                const totalHeight = headerHeight + rows.length * cellHeight + padding * 2 + 50;

                const wpColors = {
                    'wp1': '#4CAF50',
                    'wp2': '#2196F3',
                    'wp3': '#FF9800',
                    'wp4': '#9C27B0',
                    'wp5': '#F44336',
                    'wp6': '#00BCD4'
                };

                let svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${totalWidth}" height="${totalHeight}" viewBox="0 0 ${totalWidth} ${totalHeight}">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #1a3a5c; }
      .header { font-family: Arial, sans-serif; font-size: 10px; fill: #ffffff; font-weight: bold; }
      .wp-label { font-family: Arial, sans-serif; font-size: 11px; fill: #333; }
      .legend { font-family: Arial, sans-serif; font-size: 10px; fill: #333; }
    </style>
  </defs>
  
  <!-- Background -->
  <rect width="${totalWidth}" height="${totalHeight}" fill="#ffffff"/>
  
  <!-- Title -->
  <text x="${totalWidth / 2}" y="25" text-anchor="middle" class="title">Planning des Work Packages - PRAD A12P1 (2024-2027)</text>
  
  <!-- Header background -->
  <rect x="${padding}" y="40" width="${totalWidth - padding * 2}" height="${headerHeight}" fill="#1a3a5c"/>
  
  <!-- Header cells -->
  <text x="${padding + 10}" y="75" class="header">Work Package</text>
`;

                // Add month headers
                const years = ['2024', '2025', '2026', '2027'];
                const months = ['S', 'O', 'N', 'D', 'J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
                let xPos = padding + wpColumnWidth;

                for (let i = 1; i < headerCells.length && i <= ganttMonths.length; i++) {
                    const monthData = ganttMonths[i - 1];
                    if (monthData) {
                        svg += `  <text x="${xPos + cellWidth / 2}" y="75" text-anchor="middle" class="header">${monthData.label}</text>\n`;
                    }
                    xPos += cellWidth;
                }

                // Add rows
                let yPos = 40 + headerHeight;
                rows.forEach((row, rowIndex) => {
                    const wpCell = row.querySelector('td:first-child');
                    const wpText = wpCell ? wpCell.textContent.trim() : '';

                    // Row background
                    svg += `  <rect x="${padding}" y="${yPos}" width="${totalWidth - padding * 2}" height="${cellHeight}" fill="${rowIndex % 2 === 0 ? '#f8f9fa' : '#ffffff'}" stroke="#ddd" stroke-width="0.5"/>\n`;

                    // WP label
                    svg += `  <text x="${padding + 10}" y="${yPos + cellHeight / 2 + 4}" class="wp-label">${wpText}</text>\n`;

                    // Gantt bars
                    const cells = row.querySelectorAll('td.gantt-cell');
                    let barXPos = padding + wpColumnWidth;
                    cells.forEach((cell, cellIndex) => {
                        const bar = cell.querySelector('.gantt-bar');
                        if (bar) {
                            const wpClass = Array.from(bar.classList).find(c => c.startsWith('gantt-bar-wp'));
                            if (wpClass) {
                                const wpNum = wpClass.replace('gantt-bar-', '');
                                const color = wpColors[wpNum] || '#999';
                                svg += `  <rect x="${barXPos + 2}" y="${yPos + 8}" width="${cellWidth - 4}" height="${cellHeight - 16}" rx="4" fill="${color}"/>\n`;
                            }
                        }
                        barXPos += cellWidth;
                    });

                    yPos += cellHeight;
                });

                // Add legend
                const legendY = yPos + 20;
                let legendX = padding;
                Object.entries(wpColors).forEach(([wp, color], index) => {
                    svg += `  <rect x="${legendX}" y="${legendY}" width="15" height="15" rx="3" fill="${color}"/>\n`;
                    svg += `  <text x="${legendX + 20}" y="${legendY + 12}" class="legend">${wp.toUpperCase()}</text>\n`;
                    legendX += 70;
                });

                // Add milestone lines if any
                milestones.forEach(m => {
                    const monthIndex = getMonthIndex(new Date(m.date));
                    if (monthIndex >= 0) {
                        const lineX = padding + wpColumnWidth + (monthIndex * cellWidth) + cellWidth / 2;
                        svg += `  <line x1="${lineX}" y1="40" x2="${lineX}" y2="${yPos}" stroke="${m.color}" stroke-width="2" stroke-dasharray="5,3"/>\n`;
                        svg += `  <text x="${lineX}" y="${yPos + 35}" text-anchor="middle" class="legend" fill="${m.color}">${m.name}</text>\n`;
                    }
                });

                svg += '</svg>';
                return svg;
            }

            async function exportGanttAsPDF() {
                showExportLoading(true);

                try {
                    const ganttElement = getGanttElement();
                    if (!ganttElement) {
                        alert('Diagramme de Gantt non trouv√©.');
                        showExportLoading(false);
                        return;
                    }

                    // Temporarily hide export controls and milestone controls for clean export
                    const exportControls = document.querySelector('.gantt-export-controls');
                    const milestoneContainer = document.getElementById('milestoneContainer');
                    const originalExportDisplay = exportControls ? exportControls.style.display : '';
                    const originalMilestoneDisplay = milestoneContainer ? milestoneContainer.style.display : '';

                    if (exportControls) exportControls.style.display = 'none';
                    if (milestoneContainer) milestoneContainer.style.display = 'none';

                    // Use html2canvas to capture the element
                    const canvas = await html2canvas(ganttElement, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: ganttElement.scrollWidth,
                        windowHeight: ganttElement.scrollHeight
                    });

                    // Restore visibility
                    if (exportControls) exportControls.style.display = originalExportDisplay;
                    if (milestoneContainer) milestoneContainer.style.display = originalMilestoneDisplay;

                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');

                    // Calculate dimensions for landscape A4
                    const pdfWidth = 297; // A4 landscape width in mm
                    const pdfHeight = 210; // A4 landscape height in mm
                    const margin = 10;

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min((pdfWidth - margin * 2) / imgWidth, (pdfHeight - margin * 2) / imgHeight);

                    const scaledWidth = imgWidth * ratio;
                    const scaledHeight = imgHeight * ratio;
                    const xOffset = (pdfWidth - scaledWidth) / 2;
                    const yOffset = margin;

                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // Add title
                    pdf.setFontSize(14);
                    pdf.setTextColor(26, 58, 92);
                    pdf.text('Diagramme de Gantt - PRAD A12P1', pdfWidth / 2, 15, { align: 'center' });

                    // Add date
                    pdf.setFontSize(10);
                    pdf.setTextColor(100);
                    pdf.text('Export√© le: ' + new Date().toLocaleDateString('fr-FR'), pdfWidth - margin, 15, { align: 'right' });

                    // Add image
                    pdf.addImage(imgData, 'PNG', xOffset, yOffset + 10, scaledWidth, scaledHeight);

                    // Save PDF
                    pdf.save('Gantt_PRAD_A12P1_' + new Date().toISOString().split('T')[0] + '.pdf');

                    showExportLoading(false);
                } catch (error) {
                    console.error('Erreur lors de l\'export PDF:', error);
                    alert('Erreur lors de l\'export PDF. Veuillez r√©essayer.');
                    showExportLoading(false);
                }
            }

            // ========== FULL PAGE PDF EXPORT FUNCTION ==========

            function updateExportProgress(percent, text) {
                const fill = document.getElementById('exportProgressFill');
                const textEl = document.getElementById('exportProgressText');
                if (fill) fill.style.width = percent + '%';
                if (textEl) textEl.textContent = text;
            }

            function showExportProgress(show) {
                const overlay = document.getElementById('exportProgressOverlay');
                if (show) {
                    overlay.classList.add('show');
                    updateExportProgress(0, 'Pr√©paration...');
                } else {
                    overlay.classList.remove('show');
                }
            }

            // Function to prepare inputs for PDF export by showing full content
            function prepareInputsForExport() {
                const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
                const originalStyles = [];

                inputs.forEach((input, index) => {
                    originalStyles[index] = {
                        height: input.style.height,
                        minHeight: input.style.minHeight,
                        overflow: input.style.overflow,
                        whiteSpace: input.style.whiteSpace
                    };

                    // For textareas, expand to show all content
                    if (input.tagName === 'TEXTAREA') {
                        input.style.height = 'auto';
                        input.style.minHeight = (input.scrollHeight + 10) + 'px';
                        input.style.overflow = 'visible';
                    }

                    // For text inputs with long content, we'll need to handle differently
                    if (input.tagName === 'INPUT' && input.value.length > 50) {
                        input.style.overflow = 'visible';
                        input.style.textOverflow = 'clip';
                    }
                });

                return { inputs, originalStyles };
            }

            function restoreInputsAfterExport(data) {
                data.inputs.forEach((input, index) => {
                    const orig = data.originalStyles[index];
                    input.style.height = orig.height;
                    input.style.minHeight = orig.minHeight;
                    input.style.overflow = orig.overflow;
                    input.style.whiteSpace = orig.whiteSpace;
                });
            }

            async function exportFullPageAsPDF() {
                showExportProgress(true);

                try {
                    // Prepare inputs to show full content
                    const inputData = prepareInputsForExport();

                    // Convert all inputs to display their values as visible text
                    const allInputs = document.querySelectorAll('input, textarea, select');
                    const inputBackups = [];
                    allInputs.forEach((input, idx) => {
                        inputBackups[idx] = {
                            element: input,
                            display: input.style.display,
                            background: input.style.background,
                            border: input.style.border,
                            padding: input.style.padding,
                            height: input.style.height,
                            minHeight: input.style.minHeight,
                            overflow: input.style.overflow
                        };
                        // Make inputs look like plain text for PDF
                        input.style.background = '#f8f9fa';
                        input.style.border = '1px solid #dee2e6';
                        input.style.padding = '8px';
                        if (input.tagName === 'TEXTAREA') {
                            input.style.height = 'auto';
                            input.style.minHeight = (input.scrollHeight + 10) + 'px';
                            input.style.overflow = 'visible';
                        }
                    });

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 10;
                    const contentWidth = pageWidth - (margin * 2);
                    let currentY = margin;

                    // Helper function to add page header
                    function addPageHeader(pageNum) {
                        pdf.setFillColor(26, 58, 92);
                        pdf.rect(0, 0, pageWidth, 20, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('Fiche de Description et de Suivi d\'Avancement de Projet PRAD A12P1', pageWidth / 2, 13, { align: 'center' });
                        pdf.setFontSize(8);
                        pdf.text('Page ' + pageNum, pageWidth - margin, 13, { align: 'right' });
                        return 25;
                    }

                    // Helper function to add page footer
                    function addPageFooter() {
                        pdf.setFillColor(240, 240, 240);
                        pdf.rect(0, pageHeight - 10, pageWidth, 10, 'F');
                        pdf.setTextColor(100);
                        pdf.setFontSize(8);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text('Export√© le: ' + new Date().toLocaleDateString('fr-FR') + ' √† ' + new Date().toLocaleTimeString('fr-FR'), margin, pageHeight - 4);
                        pdf.text('Centre de Recherche Militaire', pageWidth - margin, pageHeight - 4, { align: 'right' });
                    }

                    // Get all tabs content
                    const tabs = [
                        { id: 'tab1', name: 'Suivi Trimestriel' },
                        { id: 'tab2', name: 'Suivi Personnel' },
                        { id: 'tab3', name: 'Suivi Projet' }
                    ];

                    let pageNum = 1;
                    let totalSections = 0;
                    let processedSections = 0;

                    // Count total sections
                    tabs.forEach(tab => {
                        const tabEl = document.getElementById(tab.id);
                        if (tabEl) {
                            totalSections += tabEl.querySelectorAll('.section').length;
                        }
                    });
                    totalSections = Math.max(totalSections, 1);

                    // Hide elements that shouldn't be in PDF
                    const elementsToHide = document.querySelectorAll('.table-controls, .gantt-export-controls, .gantt-milestone-controls, .milestone-list, .upload-btn, .view-btn, .no-print, .full-export-container, .print-button, .validate-button, .modified-counter, .save-indicator');
                    const originalDisplays = [];
                    elementsToHide.forEach((el, i) => {
                        originalDisplays[i] = el.style.display;
                        el.style.display = 'none';
                    });

                    // Make all tabs visible temporarily
                    const allTabs = document.querySelectorAll('.tab-content');
                    const originalTabDisplays = [];
                    allTabs.forEach((tab, i) => {
                        originalTabDisplays[i] = tab.style.display;
                        tab.style.display = 'block';
                    });

                    for (let tabIndex = 0; tabIndex < tabs.length; tabIndex++) {
                        const tab = tabs[tabIndex];
                        const tabEl = document.getElementById(tab.id);
                        if (!tabEl) continue;

                        updateExportProgress(Math.round((tabIndex / tabs.length) * 100), `Traitement: ${tab.name}...`);

                        // Add new page for each tab (except first)
                        if (tabIndex > 0) {
                            pdf.addPage();
                            pageNum++;
                        }

                        currentY = addPageHeader(pageNum);

                        // Add tab title
                        pdf.setFillColor(45, 90, 135);
                        pdf.rect(margin, currentY, contentWidth, 10, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(tab.name, pageWidth / 2, currentY + 7, { align: 'center' });
                        currentY += 15;

                        // Get sections in this tab
                        const sections = tabEl.querySelectorAll('.section');

                        for (let secIndex = 0; secIndex < sections.length; secIndex++) {
                            const section = sections[secIndex];
                            processedSections++;
                            updateExportProgress(
                                Math.round((processedSections / totalSections) * 100),
                                `Traitement section ${processedSections}/${totalSections}...`
                            );

                            // Check if we need a new page
                            if (currentY > pageHeight - 60) {
                                addPageFooter();
                                pdf.addPage();
                                pageNum++;
                                currentY = addPageHeader(pageNum);
                            }

                            // Capture section as image
                            try {
                                const canvas = await html2canvas(section, {
                                    backgroundColor: '#ffffff',
                                    scale: 1.5,
                                    useCORS: true,
                                    logging: false,
                                    windowWidth: section.scrollWidth + 40,
                                    windowHeight: section.scrollHeight + 40
                                });

                                const imgData = canvas.toDataURL('image/png');
                                const imgWidth = canvas.width;
                                const imgHeight = canvas.height;

                                // Calculate scaled dimensions
                                const ratio = contentWidth / imgWidth;
                                const scaledHeight = imgHeight * ratio;

                                // Check if image fits on current page
                                if (currentY + scaledHeight > pageHeight - 15) {
                                    // If image is too tall for one page, scale it down or split
                                    if (scaledHeight > pageHeight - 40) {
                                        // Scale down to fit
                                        const maxHeight = pageHeight - currentY - 15;
                                        const newRatio = maxHeight / scaledHeight;
                                        const newWidth = contentWidth * newRatio;
                                        const newHeight = maxHeight;
                                        const xOffset = margin + (contentWidth - newWidth) / 2;
                                        pdf.addImage(imgData, 'PNG', xOffset, currentY, newWidth, newHeight);
                                        currentY += newHeight + 5;
                                    } else {
                                        // Move to next page
                                        addPageFooter();
                                        pdf.addPage();
                                        pageNum++;
                                        currentY = addPageHeader(pageNum);
                                        pdf.addImage(imgData, 'PNG', margin, currentY, contentWidth, scaledHeight);
                                        currentY += scaledHeight + 5;
                                    }
                                } else {
                                    pdf.addImage(imgData, 'PNG', margin, currentY, contentWidth, scaledHeight);
                                    currentY += scaledHeight + 5;
                                }
                            } catch (err) {
                                console.error('Error capturing section:', err);
                            }

                            // Small delay to prevent browser freeze
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }

                        addPageFooter();
                    }

                    // Restore hidden elements
                    elementsToHide.forEach((el, i) => {
                        el.style.display = originalDisplays[i];
                    });

                    // Restore tab visibility
                    allTabs.forEach((tab, i) => {
                        tab.style.display = originalTabDisplays[i];
                    });

                    // Restore input styles
                    restoreInputsAfterExport(inputData);

                    // Restore all input original styles
                    inputBackups.forEach((backup) => {
                        backup.element.style.display = backup.display;
                        backup.element.style.background = backup.background;
                        backup.element.style.border = backup.border;
                        backup.element.style.padding = backup.padding;
                        backup.element.style.height = backup.height;
                        backup.element.style.minHeight = backup.minHeight;
                        backup.element.style.overflow = backup.overflow;
                    });

                    updateExportProgress(100, 'Finalisation...');

                    // Save PDF
                    const fileName = 'Fiche_PRAD_A12P1_Complete_' + new Date().toISOString().split('T')[0] + '.pdf';
                    pdf.save(fileName);

                    setTimeout(() => {
                        showExportProgress(false);
                    }, 500);

                } catch (error) {
                    console.error('Erreur lors de l\'export PDF complet:', error);
                    alert('Erreur lors de l\'export PDF. Veuillez r√©essayer.');
                    // Try to restore inputs even on error
                    try {
                        restoreInputsAfterExport(inputData);
                        if (typeof inputBackups !== 'undefined') {
                            inputBackups.forEach((backup) => {
                                backup.element.style.display = backup.display;
                                backup.element.style.background = backup.background;
                                backup.element.style.border = backup.border;
                                backup.element.style.padding = backup.padding;
                                backup.element.style.height = backup.height;
                                backup.element.style.minHeight = backup.minHeight;
                                backup.element.style.overflow = backup.overflow;
                            });
                        }
                    } catch (e) { }
                    showExportProgress(false);
                }
            }
        </script>
    </div> <!-- Close mainContent -->

    <script>
        // PIN Verification System
        // Get PIN from localStorage or use default
        let CORRECT_PIN = localStorage.getItem('prad_pin') || '0331';

        // Check if already authenticated in this session
        if (sessionStorage.getItem('prad_authenticated') === 'true') {
            document.getElementById('pinOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.remove('content-locked');
            document.getElementById('mainContent').classList.add('content-unlocked');
        }

        // Auto-focus PIN input
        document.addEventListener('DOMContentLoaded', function () {
            const pinInput = document.getElementById('pinInput');
            if (pinInput && document.getElementById('pinOverlay').style.display !== 'none') {
                pinInput.focus();
            }
        });

        // Handle single PIN input
        const pinInput = document.getElementById('pinInput');
        if (pinInput) {
            pinInput.addEventListener('input', function (e) {
                // Remove error state
                this.classList.remove('error');
                document.getElementById('pinError').classList.remove('show');

                // Auto-submit when 4 digits entered
                if (this.value.length === 4) {
                    verifyPIN();
                }
            });

            pinInput.addEventListener('keydown', function (e) {
                // Handle Enter
                if (e.key === 'Enter') {
                    verifyPIN();
                }
            });
        }

        // Note: verifyPIN is now defined in the immediate script above with dual-mode support
        // This function is kept for backward compatibility but delegates to the main verifyPIN
        // The main verifyPIN function handles both team (readonly) and admin (full edit) modes

        // ==================== PIN CHANGE FUNCTIONS ====================

        // Open PIN change modal
        function openPinChangeModal() {
            const modal = document.getElementById('pinChangeModal');
            if (modal) {
                modal.classList.add('active');

                // Add admin PIN change section if not exists
                let adminSection = document.getElementById('adminPinChangeSection');
                if (!adminSection) {
                    const container = modal.querySelector('.pin-change-form');
                    if (container) {
                        adminSection = document.createElement('div');
                        adminSection.id = 'adminPinChangeSection';
                        adminSection.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;';
                        adminSection.innerHTML = `
                            <h4 style="color: #1a3a5c; margin-bottom: 15px;">üîê Modifier le PIN Administrateur</h4>
                            <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Le PIN Admin est requis pour acc√©der aux param√®tres de s√©curit√©.</p>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nouveau PIN Admin (6 chiffres):</label>
                                <input type="password" id="newAdminPinInput" maxlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1.2rem; letter-spacing: 5px; text-align: center;" placeholder="******">
                            </div>
                            <button onclick="changeAdminPIN()" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üîê Changer le PIN Admin</button>
                        `;
                        container.appendChild(adminSection);
                    }
                }

                const firstInput = document.getElementById('currentPin1');
                if (firstInput) firstInput.focus();
                clearPinChangeInputs();
            }
        }

        // Close PIN change modal
        function closePinChangeModal() {
            document.getElementById('pinChangeModal').classList.remove('active');
            clearPinChangeInputs();
        }

        // Clear all PIN change inputs
        function clearPinChangeInputs() {
            ['currentPin', 'newPin', 'confirmPin'].forEach(prefix => {
                for (let i = 1; i <= 4; i++) {
                    const input = document.getElementById(prefix + i);
                    if (input) {
                        input.value = '';
                        input.classList.remove('error', 'success');
                    }
                }
            });
            // Reset strength bars
            for (let i = 1; i <= 4; i++) {
                document.getElementById('strengthBar' + i).classList.remove('active');
            }
            // Hide message
            const msg = document.getElementById('pinChangeMessage');
            msg.classList.remove('error', 'success');
            msg.textContent = '';
        }

        // Setup PIN change input navigation
        function setupPinChangeInputs() {
            const groups = [
                { prefix: 'currentPin', next: 'newPin' },
                { prefix: 'newPin', next: 'confirmPin' },
                { prefix: 'confirmPin', next: null }
            ];

            groups.forEach(group => {
                for (let i = 1; i <= 4; i++) {
                    const input = document.getElementById(group.prefix + i);
                    if (!input) continue;

                    input.addEventListener('input', function (e) {
                        this.classList.remove('error');

                        // Update strength indicator for new PIN
                        if (group.prefix === 'newPin') {
                            updatePinStrength();
                        }

                        // Move to next input
                        if (this.value.length === 1) {
                            if (i < 4) {
                                document.getElementById(group.prefix + (i + 1)).focus();
                            } else if (group.next) {
                                document.getElementById(group.next + '1').focus();
                            }
                        }
                    });

                    input.addEventListener('keydown', function (e) {
                        if (e.key === 'Backspace' && this.value.length === 0) {
                            if (i > 1) {
                                document.getElementById(group.prefix + (i - 1)).focus();
                            }
                        }
                        if (e.key === 'Enter') {
                            changePIN();
                        }
                    });
                }
            });
        }

        // Update PIN strength indicator
        function updatePinStrength() {
            let newPin = '';
            for (let i = 1; i <= 4; i++) {
                newPin += document.getElementById('newPin' + i).value;
            }

            // Update strength bars based on filled digits
            for (let i = 1; i <= 4; i++) {
                const bar = document.getElementById('strengthBar' + i);
                if (i <= newPin.length) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            }
        }

        // Get PIN from inputs
        function getPinFromInputs(prefix) {
            let pin = '';
            for (let i = 1; i <= 4; i++) {
                pin += document.getElementById(prefix + i).value;
            }
            return pin;
        }

        // Change PIN function
        function changePIN() {
            const currentPin = getPinFromInputs('currentPin');
            const newPin = getPinFromInputs('newPin');
            const confirmPin = getPinFromInputs('confirmPin');
            const msgEl = document.getElementById('pinChangeMessage');

            // Reset message
            msgEl.classList.remove('error', 'success');
            msgEl.textContent = '';

            // Validate current PIN
            if (currentPin !== CORRECT_PIN) {
                msgEl.classList.add('error');
                msgEl.textContent = '‚ùå Le code PIN actuel est incorrect.';
                ['currentPin1', 'currentPin2', 'currentPin3', 'currentPin4'].forEach(id => {
                    document.getElementById(id).classList.add('error');
                });
                return;
            }

            // Validate new PIN length
            if (newPin.length !== 4) {
                msgEl.classList.add('error');
                msgEl.textContent = '‚ùå Le nouveau code PIN doit contenir 4 chiffres.';
                return;
            }

            // Validate new PIN is numeric
            if (!/^\d{4}$/.test(newPin)) {
                msgEl.classList.add('error');
                msgEl.textContent = '‚ùå Le code PIN doit contenir uniquement des chiffres.';
                return;
            }

            // Validate confirmation matches
            if (newPin !== confirmPin) {
                msgEl.classList.add('error');
                msgEl.textContent = '‚ùå Les codes PIN ne correspondent pas.';
                ['confirmPin1', 'confirmPin2', 'confirmPin3', 'confirmPin4'].forEach(id => {
                    document.getElementById(id).classList.add('error');
                });
                return;
            }

            // Validate new PIN is different from current
            if (newPin === currentPin) {
                msgEl.classList.add('error');
                msgEl.textContent = '‚ùå Le nouveau code PIN doit √™tre diff√©rent de l\'actuel.';
                return;
            }

            // Save new PIN
            CORRECT_PIN = newPin;
            localStorage.setItem('prad_pin', newPin);

            // Show success message
            msgEl.classList.add('success');
            msgEl.textContent = '‚úÖ Code PIN modifi√© avec succ√®s ! Le nouveau code est : ' + newPin;

            // Mark inputs as success
            ['newPin1', 'newPin2', 'newPin3', 'newPin4', 'confirmPin1', 'confirmPin2', 'confirmPin3', 'confirmPin4'].forEach(id => {
                document.getElementById(id).classList.add('success');
            });

            // Close modal after delay
            setTimeout(() => {
                closePinChangeModal();
            }, 3000);
        }

        // Close modal when clicking outside
        document.getElementById('pinChangeModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closePinChangeModal();
            }
        });

        // Initialize PIN change inputs
        setupPinChangeInputs();

        // verifyPIN is already defined globally in the immediate script above
        // No need to override it here
    </script>

    <script>
        // ========== FILE STORAGE AND EXPORT SYSTEM ==========

        // Persistent file storage using Base64 encoding
        const persistentFileStorage = new Map();

        // Convert file to Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: reader.result
                });
                reader.onerror = error => reject(error);
            });
        }

        // Convert Base64 back to File
        function base64ToFile(fileData) {
            const arr = fileData.data.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], fileData.name, { type: mime });
        }

        // Maximum file size for localStorage (2 MB per file recommended)
        const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2 MB

        // Override the original handleFileSelect to also store in persistent storage
        const originalHandleFileSelect = handleFileSelect;
        handleFileSelect = async function (input) {
            const wrapper = input.closest('.upload-wrapper');
            const fileList = wrapper.querySelector('.file-list');
            const files = input.files;

            const storageKey = input.id || 'file_' + Math.random().toString(36).substr(2, 9);
            input.id = storageKey;

            if (!fileStorage.has(storageKey)) {
                fileStorage.set(storageKey, []);
            }
            if (!persistentFileStorage.has(storageKey)) {
                persistentFileStorage.set(storageKey, []);
            }

            const storedFiles = fileStorage.get(storageKey);
            const persistentFiles = persistentFileStorage.get(storageKey);

            let skippedFiles = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    skippedFiles.push(file.name + ' (' + formatFileSize(file.size) + ')');
                    continue; // Skip this file
                }

                storedFiles.push(file);

                // Also store as Base64 for persistence
                try {
                    const base64Data = await fileToBase64(file);
                    persistentFiles.push(base64Data);
                } catch (e) {
                    console.error('Error converting file to Base64:', e);
                }

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name" title="${file.name}" onclick="previewFile('${storageKey}', ${storedFiles.length - 1})">${file.name}</span>
                    <span class="file-remove" onclick="removeFilePersistent(this, '${storageKey}', ${storedFiles.length - 1})">√ó</span>
                `;
                fileList.appendChild(fileItem);
            }

            // Show warning for skipped files
            if (skippedFiles.length > 0) {
                showFileSizeWarning(skippedFiles);
            }

            updateFileStats();
            savePersistentFiles();
        };

        // Show file size warning
        function showFileSizeWarning(skippedFiles) {
            const message = '‚ö†Ô∏è Les fichiers suivants sont trop volumineux (max 2 MB) et n\'ont pas √©t√© ajout√©s:\n\n' +
                skippedFiles.join('\n') +
                '\n\nPour les gros fichiers, utilisez le bouton "üì¶ Exporter Tout" pour cr√©er une sauvegarde compl√®te.';
            alert(message);
        }

        // Remove file from persistent storage
        function removeFilePersistent(element, storageKey, index) {
            const storedFiles = fileStorage.get(storageKey);
            const persistentFiles = persistentFileStorage.get(storageKey);

            if (storedFiles) {
                storedFiles[index] = null;
            }
            if (persistentFiles) {
                persistentFiles[index] = null;
            }

            element.parentElement.remove();
            updateFileStats();
            savePersistentFiles();
        }

        // Update file statistics display
        function updateFileStats() {
            let totalFiles = 0;
            let totalSize = 0;

            persistentFileStorage.forEach((files, key) => {
                files.forEach(file => {
                    if (file) {
                        totalFiles++;
                        totalSize += file.size || 0;
                    }
                });
            });

            document.getElementById('attachedFilesCount').textContent = totalFiles;
            document.getElementById('totalFilesSize').textContent = formatFileSize(totalSize);
        }

        // Save persistent files to localStorage
        function savePersistentFiles() {
            const data = {};
            persistentFileStorage.forEach((files, key) => {
                data[key] = files.filter(f => f !== null);
            });

            try {
                const jsonData = JSON.stringify(data);
                const sizeInMB = (jsonData.length / (1024 * 1024)).toFixed(2);

                // Check if size is approaching localStorage limit (usually 5-10 MB)
                if (jsonData.length > 4 * 1024 * 1024) { // 4 MB warning threshold
                    console.warn('Warning: File storage is approaching localStorage limit (' + sizeInMB + ' MB)');
                    showStorageWarning(sizeInMB);
                }

                localStorage.setItem('prad_files', jsonData);
                document.getElementById('lastSaveDate').textContent = new Date().toLocaleString('fr-FR');

                // Update storage indicator
                updateStorageIndicator(sizeInMB);
            } catch (e) {
                console.error('Error saving files to localStorage:', e);
                if (e.name === 'QuotaExceededError') {
                    showStorageFullError();
                }
            }
        }

        // Show storage warning notification
        function showStorageWarning(sizeInMB) {
            const notification = document.createElement('div');
            notification.className = 'storage-warning-notification';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è Attention</strong><br>
                L'espace de stockage local est presque plein (${sizeInMB} MB).<br>
                Pensez √† exporter vos donn√©es avec le bouton "üì¶ Exporter Tout".
            `;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffc107;
                border-radius: 8px;
                padding: 15px 20px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 350px;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 8000);
        }

        // Show storage full error
        function showStorageFullError() {
            alert('‚ùå Erreur: L\'espace de stockage local est plein!\n\nVos fichiers n\'ont pas pu √™tre sauvegard√©s.\nVeuillez exporter vos donn√©es avec le bouton "üì¶ Exporter Tout" pour cr√©er une sauvegarde externe.');
        }

        // Update storage indicator in the UI
        function updateStorageIndicator(sizeInMB) {
            let indicator = document.getElementById('storageIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'storageIndicator';
                indicator.style.cssText = `
                    font-size: 0.85em;
                    color: #666;
                    margin-top: 5px;
                `;
                const fileStats = document.getElementById('fileStats');
                if (fileStats) {
                    fileStats.appendChild(indicator);
                }
            }

            const percentage = Math.min(100, (parseFloat(sizeInMB) / 5) * 100);
            let color = '#28a745'; // Green
            if (percentage > 60) color = '#ffc107'; // Yellow
            if (percentage > 80) color = '#dc3545'; // Red

            indicator.innerHTML = `
                <span>üíæ Stockage local:</span>
                <span style="color: ${color}; font-weight: bold;">${sizeInMB} MB / 5 MB</span>
            `;
        }

        // Load persistent files from localStorage
        function loadPersistentFiles() {
            try {
                const data = JSON.parse(localStorage.getItem('prad_files') || '{}');

                Object.keys(data).forEach(key => {
                    const files = data[key];
                    if (files && files.length > 0) {
                        persistentFileStorage.set(key, files);

                        // Also restore to fileStorage as File objects
                        const fileObjects = files.map(f => f ? base64ToFile(f) : null);
                        fileStorage.set(key, fileObjects);

                        // Update UI
                        const input = document.getElementById(key);
                        if (input) {
                            const wrapper = input.closest('.upload-wrapper');
                            const fileList = wrapper.querySelector('.file-list');

                            files.forEach((file, index) => {
                                if (file) {
                                    const fileItem = document.createElement('div');
                                    fileItem.className = 'file-item';
                                    fileItem.innerHTML = `
                                        <span class="file-name" title="${file.name}" onclick="previewFile('${key}', ${index})">${file.name}</span>
                                        <span class="file-remove" onclick="removeFilePersistent(this, '${key}', ${index})">√ó</span>
                                    `;
                                    fileList.appendChild(fileItem);
                                }
                            });
                        }
                    }
                });

                updateFileStats();

                // Update storage indicator
                const savedData = localStorage.getItem('prad_files');
                if (savedData) {
                    const sizeInMB = (savedData.length / (1024 * 1024)).toFixed(2);
                    updateStorageIndicator(sizeInMB);
                }
            } catch (e) {
                console.error('Error loading persistent files:', e);
            }
        }

        // Export all data and files as a single JSON file
        async function exportAllWithFiles() {
            showExportProgress(true);
            updateExportProgress(10, 'Collecte des donn√©es du formulaire...');

            try {
                // Collect form data
                const formData = {};
                const inputs = document.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea, select');
                inputs.forEach((input, index) => {
                    const key = input.id || input.name || 'field_' + index;
                    formData[key] = input.value;
                });

                // Collect checkbox states
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const checkboxData = {};
                checkboxes.forEach((cb, index) => {
                    const key = cb.id || cb.name || 'checkbox_' + index;
                    checkboxData[key] = cb.checked;
                });

                updateExportProgress(30, 'Pr√©paration des documents joints...');

                // Collect files as Base64
                const filesData = {};
                persistentFileStorage.forEach((files, key) => {
                    filesData[key] = files.filter(f => f !== null);
                });

                updateExportProgress(60, 'Cr√©ation du fichier de sauvegarde...');

                // Create export object
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    projectCode: 'PRAD_A12P1',
                    formData: formData,
                    checkboxData: checkboxData,
                    filesData: filesData,
                    milestones: milestones,
                    pin: localStorage.getItem('prad_pin') || '0331'
                };

                updateExportProgress(80, 'G√©n√©ration du fichier...');

                // Convert to JSON and create download
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'PRAD_A12P1_Backup_' + new Date().toISOString().split('T')[0] + '.prad';
                a.click();

                URL.revokeObjectURL(url);

                updateExportProgress(100, 'Export termin√©!');

                // Update last save date
                document.getElementById('lastSaveDate').textContent = new Date().toLocaleString('fr-FR');

                setTimeout(() => {
                    showExportProgress(false);
                    alert('‚úÖ Export r√©ussi!\n\nLe fichier .prad contient toutes les donn√©es et documents joints.\nPartagez ce fichier avec les membres de l\'√©quipe qui ont le code PIN.');
                }, 500);

            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Erreur lors de l\'export: ' + error.message);
                showExportProgress(false);
            }
        }

        // Import data and files from a backup file
        async function importAllWithFiles(input) {
            const file = input.files[0];
            if (!file) return;

            showExportProgress(true);
            updateExportProgress(10, 'Lecture du fichier de sauvegarde...');

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                updateExportProgress(30, 'V√©rification des donn√©es...');

                // Verify it's a valid backup
                if (!importData.version || !importData.projectCode) {
                    throw new Error('Fichier de sauvegarde invalide');
                }

                updateExportProgress(50, 'Restauration des donn√©es du formulaire...');

                // Restore form data
                if (importData.formData) {
                    Object.keys(importData.formData).forEach(key => {
                        const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = importData.formData[key];
                        }
                    });
                }

                // Restore checkbox states
                if (importData.checkboxData) {
                    Object.keys(importData.checkboxData).forEach(key => {
                        const cb = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                        if (cb) {
                            cb.checked = importData.checkboxData[key];
                        }
                    });
                }

                updateExportProgress(70, 'Restauration des documents joints...');

                // Restore files
                if (importData.filesData) {
                    // Clear existing files
                    persistentFileStorage.clear();
                    fileStorage.clear();
                    document.querySelectorAll('.file-list').forEach(list => list.innerHTML = '');

                    Object.keys(importData.filesData).forEach(key => {
                        const files = importData.filesData[key];
                        if (files && files.length > 0) {
                            persistentFileStorage.set(key, files);

                            // Restore to fileStorage as File objects
                            const fileObjects = files.map(f => f ? base64ToFile(f) : null);
                            fileStorage.set(key, fileObjects);

                            // Update UI
                            const fileInput = document.getElementById(key);
                            if (fileInput) {
                                const wrapper = fileInput.closest('.upload-wrapper');
                                const fileList = wrapper.querySelector('.file-list');

                                files.forEach((fileData, index) => {
                                    if (fileData) {
                                        const fileItem = document.createElement('div');
                                        fileItem.className = 'file-item';
                                        fileItem.innerHTML = `
                                            <span class="file-name" title="${fileData.name}" onclick="previewFile('${key}', ${index})">${fileData.name}</span>
                                            <span class="file-remove" onclick="removeFilePersistent(this, '${key}', ${index})">√ó</span>
                                        `;
                                        fileList.appendChild(fileItem);
                                    }
                                });
                            }
                        }
                    });
                }

                // Restore milestones
                if (importData.milestones) {
                    milestones = importData.milestones;
                    milestoneIdCounter = Math.max(...milestones.map(m => m.id), 0);
                    renderMilestoneList();
                    renderMilestoneLines();
                }

                updateExportProgress(90, 'Finalisation...');

                // Save to localStorage
                savePersistentFiles();
                saveFormData();

                updateFileStats();

                updateExportProgress(100, 'Import termin√©!');

                setTimeout(() => {
                    showExportProgress(false);
                    alert('‚úÖ Import r√©ussi!\n\nToutes les donn√©es et documents ont √©t√© restaur√©s.\nDate de la sauvegarde: ' + new Date(importData.exportDate).toLocaleString('fr-FR'));
                }, 500);

            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Erreur lors de l\'import: ' + error.message);
                showExportProgress(false);
            }

            // Reset file input
            input.value = '';
        }

        // Load persistent files on page load
        window.addEventListener('load', function () {
            setTimeout(loadPersistentFiles, 1000);
        });

        // ==========================================
        // ROW/COLUMN SELECTION FUNCTIONS
        // ==========================================

        let currentRowColTable = null;
        let currentRowColMode = 'delete'; // 'delete' or 'add'
        let currentRowColType = 'row'; // 'row' or 'column'
        let selectedRowColIndex = -1;

        function openRowColModal(table, type, mode) {
            currentRowColTable = table;
            currentRowColType = type;
            currentRowColMode = mode;
            selectedRowColIndex = -1;

            const modal = document.getElementById('rowColModal');
            const title = document.getElementById('rowColModalTitle');
            const list = document.getElementById('rowColList');
            const actionBtn = document.getElementById('rowColActionBtn');
            const positionDiv = document.getElementById('rowColPosition');
            const positionSelect = document.getElementById('rowColPositionSelect');

            // Set title
            if (mode === 'delete') {
                title.textContent = type === 'row' ? 'üóëÔ∏è Supprimer une ligne' : 'üóëÔ∏è Supprimer une colonne';
                actionBtn.textContent = 'Supprimer';
                actionBtn.className = 'row-col-btn delete';
                positionDiv.style.display = 'none';
            } else {
                title.textContent = type === 'row' ? '‚ûï Ajouter une ligne' : '‚ûï Ajouter une colonne';
                actionBtn.textContent = 'Ajouter';
                actionBtn.className = 'row-col-btn add';
                positionDiv.style.display = 'block';
            }

            // Populate list
            list.innerHTML = '';

            if (type === 'row') {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    let preview = '';
                    cells.forEach((cell, i) => {
                        if (i < 3) {
                            const input = cell.querySelector('input, textarea, select');
                            if (input) {
                                preview += (input.value || '...').substring(0, 20) + ' | ';
                            } else {
                                preview += (cell.textContent || '...').substring(0, 20) + ' | ';
                            }
                        }
                    });

                    const item = document.createElement('div');
                    item.className = 'row-col-item';
                    item.innerHTML = `
                        <span class="row-col-item-index">${index + 1}</span>
                        <span class="row-col-item-text">${preview.slice(0, -3) || 'Ligne ' + (index + 1)}</span>
                    `;
                    item.onclick = () => selectRowColItem(item, index);
                    list.appendChild(item);
                });

                // Populate position select for add mode
                if (mode === 'add') {
                    positionSelect.innerHTML = '<option value="-1">Au d√©but</option>';
                    rows.forEach((row, index) => {
                        positionSelect.innerHTML += `<option value="${index}">Apr√®s la ligne ${index + 1}</option>`;
                    });
                    positionSelect.value = rows.length - 1;
                }
            } else {
                const headerRow = table.querySelector('thead tr') || table.querySelector('tr');
                const headers = headerRow.querySelectorAll('th, td');
                headers.forEach((header, index) => {
                    if (index === 0) return; // Skip first column usually

                    const item = document.createElement('div');
                    item.className = 'row-col-item';
                    item.innerHTML = `
                        <span class="row-col-item-index">${index}</span>
                        <span class="row-col-item-text">${header.textContent || 'Colonne ' + index}</span>
                    `;
                    item.onclick = () => selectRowColItem(item, index);
                    list.appendChild(item);
                });

                // Populate position select for add mode
                if (mode === 'add') {
                    positionSelect.innerHTML = '';
                    headers.forEach((header, index) => {
                        if (index === 0) return;
                        positionSelect.innerHTML += `<option value="${index}">Apr√®s "${header.textContent || 'Colonne ' + index}"</option>`;
                    });
                }
            }

            // Set action button handler
            actionBtn.onclick = () => executeRowColAction();

            modal.classList.add('show');
        }

        function selectRowColItem(item, index) {
            document.querySelectorAll('.row-col-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedRowColIndex = index;
        }

        function closeRowColModal() {
            document.getElementById('rowColModal').classList.remove('show');
            currentRowColTable = null;
            selectedRowColIndex = -1;
        }

        function executeRowColAction() {
            if (currentRowColMode === 'delete') {
                if (selectedRowColIndex === -1) {
                    alert('Veuillez s√©lectionner un √©l√©ment √† supprimer');
                    return;
                }

                if (currentRowColType === 'row') {
                    const rows = currentRowColTable.querySelectorAll('tbody tr');
                    if (rows.length <= 1) {
                        alert('Impossible de supprimer la derni√®re ligne');
                        return;
                    }
                    if (rows[selectedRowColIndex]) {
                        rows[selectedRowColIndex].remove();
                    }
                } else {
                    const allRows = currentRowColTable.querySelectorAll('tr');
                    allRows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        if (cells[selectedRowColIndex]) {
                            cells[selectedRowColIndex].remove();
                        }
                    });
                }
            } else {
                const position = parseInt(document.getElementById('rowColPositionSelect').value);

                if (currentRowColType === 'row') {
                    const tbody = currentRowColTable.querySelector('tbody');
                    const templateRow = tbody.querySelector('tr');
                    const newRow = templateRow.cloneNode(true);

                    // Clear values in new row
                    newRow.querySelectorAll('input, textarea').forEach(input => {
                        input.value = '';
                    });
                    newRow.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });

                    const rows = tbody.querySelectorAll('tr');
                    if (position === -1) {
                        tbody.insertBefore(newRow, rows[0]);
                    } else if (rows[position]) {
                        rows[position].after(newRow);
                    } else {
                        tbody.appendChild(newRow);
                    }
                } else {
                    const colName = prompt('Nom de la nouvelle colonne:');
                    if (!colName) return;

                    const allRows = currentRowColTable.querySelectorAll('tr');
                    allRows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('th, td');
                        const newCell = document.createElement(rowIndex === 0 ? 'th' : 'td');

                        if (rowIndex === 0) {
                            newCell.textContent = colName;
                        } else {
                            newCell.innerHTML = '<input type="text" style="width:100%">';
                        }

                        if (cells[position]) {
                            cells[position].after(newCell);
                        } else {
                            row.appendChild(newCell);
                        }
                    });
                }
            }

            closeRowColModal();
            saveFormData();
        }

        // Update existing add/remove buttons to use the new modal
        function updateTableButtons() {
            document.querySelectorAll('.table-controls').forEach(controls => {
                const table = controls.nextElementSibling;
                if (!table || table.tagName !== 'TABLE') return;

                const buttons = controls.querySelectorAll('button');
                buttons.forEach(btn => {
                    const text = btn.textContent.toLowerCase();
                    if (text.includes('ajouter ligne')) {
                        btn.onclick = (e) => { e.preventDefault(); openRowColModal(table, 'row', 'add'); };
                    } else if (text.includes('supprimer ligne')) {
                        btn.onclick = (e) => { e.preventDefault(); openRowColModal(table, 'row', 'delete'); };
                    } else if (text.includes('ajouter colonne')) {
                        btn.onclick = (e) => { e.preventDefault(); openRowColModal(table, 'column', 'add'); };
                    } else if (text.includes('supprimer colonne')) {
                        btn.onclick = (e) => { e.preventDefault(); openRowColModal(table, 'column', 'delete'); };
                    }
                });
            });
        }

        // ==========================================
        // DOCUMENT VIEWER FUNCTIONS
        // ==========================================

        let currentViewerFiles = [];
        let currentViewerIndex = 0;
        let currentViewerKey = '';

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìÑ',
                'doc': 'üìù', 'docx': 'üìù',
                'ppt': 'üìä', 'pptx': 'üìä',
                'xls': 'üìà', 'xlsx': 'üìà',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'webp': 'üñºÔ∏è',
                'mp4': 'üé¨', 'avi': 'üé¨', 'mov': 'üé¨',
                'mp3': 'üéµ', 'wav': 'üéµ',
                'zip': 'üì¶', 'rar': 'üì¶',
                'txt': 'üìÉ'
            };
            return icons[ext] || 'üìé';
        }

        function openDocViewer(storageKey) {
            currentViewerKey = storageKey;
            const files = persistentFileStorage.get(storageKey) || [];
            currentViewerFiles = files.filter(f => f !== null);

            if (currentViewerFiles.length === 0) {
                alert('Aucun document joint √† afficher');
                return;
            }

            currentViewerIndex = 0;

            // Populate sidebar
            const container = document.getElementById('docListContainer');
            container.innerHTML = '';

            currentViewerFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'doc-list-item' + (index === 0 ? ' active' : '');
                item.innerHTML = `
                    <div class="doc-list-item-name">${getFileIcon(file.name)} ${file.name}</div>
                    <div class="doc-list-item-size">${formatFileSize(file.data.length * 0.75)}</div>
                `;
                item.onclick = () => viewDocAtIndex(index);
                container.appendChild(item);
            });

            // Show first document
            displayDocument(currentViewerFiles[0]);

            document.getElementById('docViewerModal').classList.add('show');
        }

        function viewDocAtIndex(index) {
            currentViewerIndex = index;

            // Update sidebar selection
            document.querySelectorAll('.doc-list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            displayDocument(currentViewerFiles[index]);
        }

        function viewPrevDoc() {
            if (currentViewerIndex > 0) {
                viewDocAtIndex(currentViewerIndex - 1);
            }
        }

        function viewNextDoc() {
            if (currentViewerIndex < currentViewerFiles.length - 1) {
                viewDocAtIndex(currentViewerIndex + 1);
            }
        }

        function displayDocument(fileData) {
            const viewer = document.getElementById('docViewerBody');
            const titleEl = document.getElementById('docViewerFileName');
            const iconEl = document.getElementById('docViewerIcon');

            titleEl.textContent = fileData.name;
            iconEl.textContent = getFileIcon(fileData.name);

            const ext = fileData.name.split('.').pop().toLowerCase();
            const dataUrl = `data:${fileData.type};base64,${fileData.data}`;

            // Clear previous content
            viewer.innerHTML = '';

            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) {
                // Image viewer
                viewer.innerHTML = `<img src="${dataUrl}" alt="${fileData.name}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
            } else if (ext === 'pdf') {
                // PDF viewer
                viewer.innerHTML = `<iframe src="${dataUrl}" style="width:100%; height:100%; border:none;"></iframe>`;
            } else if (['ppt', 'pptx', 'doc', 'docx', 'xls', 'xlsx'].includes(ext)) {
                // Office documents - use Google Docs Viewer or show download option
                // Since we have base64, we need to provide a download option with preview message
                viewer.innerHTML = `
                    <div class="no-preview">
                        <div class="icon">${getFileIcon(fileData.name)}</div>
                        <h3>${fileData.name}</h3>
                        <p style="color:#666; margin: 20px 0;">Aper√ßu non disponible pour ce type de fichier.</p>
                        <p style="color:#666; margin-bottom: 20px;">T√©l√©chargez le fichier pour le visualiser dans l'application appropri√©e.</p>
                        <button onclick="downloadCurrentDoc()" style="padding: 15px 30px; background: #1a3a5c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            ‚¨áÔ∏è T√©l√©charger ${fileData.name}
                        </button>
                    </div>
                `;
            } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                // Video viewer
                viewer.innerHTML = `<video controls style="max-width:100%; max-height:100%;"><source src="${dataUrl}" type="${fileData.type}"></video>`;
            } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                // Audio viewer
                viewer.innerHTML = `
                    <div class="no-preview">
                        <div class="icon">üéµ</div>
                        <h3>${fileData.name}</h3>
                        <audio controls style="margin-top: 20px;"><source src="${dataUrl}" type="${fileData.type}"></audio>
                    </div>
                `;
            } else if (ext === 'txt') {
                // Text viewer
                try {
                    const text = atob(fileData.data);
                    viewer.innerHTML = `<pre style="padding: 20px; text-align: left; overflow: auto; width: 100%; height: 100%; background: white;">${text}</pre>`;
                } catch (e) {
                    viewer.innerHTML = `<div class="no-preview"><div class="icon">üìÉ</div><p>Impossible d'afficher le contenu</p></div>`;
                }
            } else {
                // Unknown format
                viewer.innerHTML = `
                    <div class="no-preview">
                        <div class="icon">${getFileIcon(fileData.name)}</div>
                        <h3>${fileData.name}</h3>
                        <p style="color:#666; margin: 20px 0;">Aper√ßu non disponible pour ce type de fichier.</p>
                        <button onclick="downloadCurrentDoc()" style="padding: 15px 30px; background: #1a3a5c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            ‚¨áÔ∏è T√©l√©charger
                        </button>
                    </div>
                `;
            }

            // Update navigation buttons
            document.getElementById('docPrevBtn').disabled = currentViewerIndex === 0;
            document.getElementById('docNextBtn').disabled = currentViewerIndex === currentViewerFiles.length - 1;
        }

        function downloadCurrentDoc() {
            const fileData = currentViewerFiles[currentViewerIndex];
            if (!fileData) return;

            const dataUrl = `data:${fileData.type};base64,${fileData.data}`;
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = fileData.name;
            a.click();
        }

        function closeDocViewer() {
            document.getElementById('docViewerModal').classList.remove('show');
            currentViewerFiles = [];
            currentViewerIndex = 0;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Update View buttons to use the new document viewer
        function updateViewButtons() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                const wrapper = btn.closest('.upload-wrapper');
                if (wrapper) {
                    const fileInput = wrapper.querySelector('input[type="file"]');
                    if (fileInput) {
                        btn.onclick = (e) => {
                            e.preventDefault();
                            openDocViewer(fileInput.id);
                        };
                    }
                }
            });
        }

        // ==========================================
        // ADMIN PIN SECURITY FUNCTIONS
        // ==========================================

        // Default Admin PIN (should be changed by the project manager)
        const DEFAULT_ADMIN_PIN = '085301';
        let adminPinCallback = null;

        function getAdminPIN() {
            return localStorage.getItem('prad_admin_pin') || DEFAULT_ADMIN_PIN;
        }

        function openAdminPinModal(callback) {
            adminPinCallback = callback;
            document.getElementById('adminPinInput').value = '';
            document.getElementById('adminPinError').classList.remove('show');
            document.getElementById('adminPinModal').classList.add('show');
            document.getElementById('adminPinInput').focus();
        }

        function closeAdminPinModal() {
            document.getElementById('adminPinModal').classList.remove('show');
            adminPinCallback = null;
        }

        function verifyAdminPIN() {
            const enteredPIN = document.getElementById('adminPinInput').value;
            const correctPIN = getAdminPIN();

            if (enteredPIN === correctPIN) {
                closeAdminPinModal();
                // Directly open the PIN change modal
                const modal = document.getElementById('pinChangeModal');
                if (modal) {
                    modal.classList.add('active');

                    // Add admin PIN change section if not exists
                    let adminSection = document.getElementById('adminPinChangeSection');
                    if (!adminSection) {
                        const container = modal.querySelector('.pin-change-form');
                        if (container) {
                            adminSection = document.createElement('div');
                            adminSection.id = 'adminPinChangeSection';
                            adminSection.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;';
                            adminSection.innerHTML = `
                                <h4 style="color: #1a3a5c; margin-bottom: 15px;">üîê Modifier le PIN Administrateur</h4>
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Le PIN Admin est requis pour acc√©der aux param√®tres de s√©curit√©.</p>
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nouveau PIN Admin (6 chiffres):</label>
                                    <input type="password" id="newAdminPinInput" maxlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1.2rem; letter-spacing: 5px; text-align: center;" placeholder="******">
                                </div>
                                <button onclick="changeAdminPIN()" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üîê Changer le PIN Admin</button>
                            `;
                            container.appendChild(adminSection);
                        }
                    }

                    const firstInput = document.getElementById('currentPin1');
                    if (firstInput) firstInput.focus();
                }

                if (adminPinCallback) {
                    adminPinCallback();
                }
            } else {
                document.getElementById('adminPinError').classList.add('show');
                document.getElementById('adminPinInput').value = '';
                document.getElementById('adminPinInput').focus();
            }
        }

        // Override the PIN settings button to require admin authentication
        function openPinSettingsSecure() {
            openAdminPinModal(() => {
                // Show the PIN change modal after admin authentication
                openPinChangeModal();
            });
        }

        // Note: openPinChangeModal is defined earlier in the file

        function changeAdminPIN() {
            const newPIN = document.getElementById('newAdminPinInput').value;

            if (!/^\d{6}$/.test(newPIN)) {
                alert('Le PIN Admin doit contenir exactement 6 chiffres');
                return;
            }

            localStorage.setItem('prad_admin_pin', newPIN);
            alert('‚úÖ PIN Administrateur modifi√© avec succ√®s!\n\nNouveau PIN Admin: ' + newPIN + '\n\n‚ö†Ô∏è IMPORTANT: Notez ce PIN en lieu s√ªr. Il est requis pour acc√©der aux param√®tres de s√©curit√©.');
            document.getElementById('newAdminPinInput').value = '';
        }

        // Logout function - clears session and returns to PIN screen
        function logoutSession() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter?')) {
                sessionStorage.removeItem('prad_authenticated');
                sessionStorage.removeItem('prad_auth_mode');
                location.reload();
            }
        }

        // Initialize on page load
        window.addEventListener('load', function () {
            // Update table buttons
            setTimeout(updateTableButtons, 500);

            // Update view buttons
            setTimeout(updateViewButtons, 500);

            // Update PIN settings button to require admin authentication
            const pinSettingsBtn = document.getElementById('pinSettingsBtn');
            if (pinSettingsBtn) {
                pinSettingsBtn.onclick = (e) => {
                    e.preventDefault();
                    openPinSettingsSecure();
                };
            }
        });

        // Handle Enter key in admin PIN input
        document.addEventListener('DOMContentLoaded', function () {
            const adminPinInput = document.getElementById('adminPinInput');
            if (adminPinInput) {
                adminPinInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        verifyAdminPIN();
                    }
                });
            }
        });
    </script>

    <!-- Context Menu for Table Rows -->
    <div id="tableContextMenu" class="context-menu">
        <div class="context-menu-header">üìã Options de Ligne</div>
        <div class="context-menu-item" onclick="contextMenuInsertAbove()">
            <span class="icon">‚¨ÜÔ∏è</span>
            <span>Ins√©rer une ligne au-dessus</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuInsertBelow()">
            <span class="icon">‚¨áÔ∏è</span>
            <span>Ins√©rer une ligne en-dessous</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="contextMenuDuplicateRow()">
            <span class="icon">üìÑ</span>
            <span>Dupliquer cette ligne</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" onclick="contextMenuDeleteRow()">
            <span class="icon">üóëÔ∏è</span>
            <span>Supprimer cette ligne</span>
        </div>
    </div>

    <script>
        // ========== CONTEXT MENU FUNCTIONALITY ==========
        (function () {
            let contextMenuTarget = null; // The row that was right-clicked
            let contextMenuTable = null;  // The table containing the row

            const contextMenu = document.getElementById('tableContextMenu');

            // Hide context menu when clicking elsewhere
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // Hide context menu on scroll
            document.addEventListener('scroll', hideContextMenu);

            // Hide context menu on Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

            function hideContextMenu() {
                if (contextMenu) {
                    contextMenu.classList.remove('show');
                }
                // Remove highlight from all rows
                document.querySelectorAll('tr.context-highlight').forEach(row => {
                    row.classList.remove('context-highlight');
                });
                contextMenuTarget = null;
                contextMenuTable = null;
            }

            function showContextMenu(e, row, table) {
                // Don't show context menu in readonly mode
                if (document.body.classList.contains('readonly-mode')) {
                    return;
                }

                e.preventDefault();

                // Hide any existing context menu
                hideContextMenu();

                // Store references
                contextMenuTarget = row;
                contextMenuTable = table;

                // Highlight the row
                row.classList.add('context-highlight');

                // Position the menu
                const menuWidth = 200;
                const menuHeight = 220;
                let x = e.clientX;
                let y = e.clientY;

                // Adjust if menu would go off screen
                if (x + menuWidth > window.innerWidth) {
                    x = window.innerWidth - menuWidth - 10;
                }
                if (y + menuHeight > window.innerHeight) {
                    y = window.innerHeight - menuHeight - 10;
                }

                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.classList.add('show');
            }

            // Attach context menu to all table body rows
            function attachContextMenuToTables() {
                document.querySelectorAll('table tbody tr').forEach(row => {
                    // Skip if already has context menu attached
                    if (row.dataset.contextMenuAttached) return;

                    row.addEventListener('contextmenu', function (e) {
                        const table = this.closest('table');
                        if (table) {
                            showContextMenu(e, this, table);
                        }
                    });

                    row.dataset.contextMenuAttached = 'true';
                });
            }

            // Initial attachment
            document.addEventListener('DOMContentLoaded', attachContextMenuToTables);

            // Re-attach when rows are added (using MutationObserver)
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        attachContextMenuToTables();
                    }
                });
            });

            // Observe all table bodies for changes
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('table tbody').forEach(tbody => {
                    observer.observe(tbody, { childList: true });
                });
            });

            // Context Menu Actions
            window.contextMenuInsertAbove = function () {
                if (!contextMenuTarget || !contextMenuTable) return;

                const tbody = contextMenuTable.querySelector('tbody');
                const newRow = contextMenuTarget.cloneNode(true);

                // Clear input values in the new row
                clearRowInputs(newRow);

                // Insert before the target row
                tbody.insertBefore(newRow, contextMenuTarget);

                // Re-attach context menu and other handlers
                attachContextMenuToTables();
                reattachRowHandlers(newRow);

                hideContextMenu();
                showNotification('Ligne ins√©r√©e au-dessus', 'success');
                triggerAutoSave();
            };

            window.contextMenuInsertBelow = function () {
                if (!contextMenuTarget || !contextMenuTable) return;

                const tbody = contextMenuTable.querySelector('tbody');
                const newRow = contextMenuTarget.cloneNode(true);

                // Clear input values in the new row
                clearRowInputs(newRow);

                // Insert after the target row
                if (contextMenuTarget.nextSibling) {
                    tbody.insertBefore(newRow, contextMenuTarget.nextSibling);
                } else {
                    tbody.appendChild(newRow);
                }

                // Re-attach context menu and other handlers
                attachContextMenuToTables();
                reattachRowHandlers(newRow);

                hideContextMenu();
                showNotification('Ligne ins√©r√©e en-dessous', 'success');
                triggerAutoSave();
            };

            window.contextMenuDuplicateRow = function () {
                if (!contextMenuTarget || !contextMenuTable) return;

                const tbody = contextMenuTable.querySelector('tbody');
                const newRow = contextMenuTarget.cloneNode(true);

                // Keep the values (it's a duplicate)
                // But we need to handle file inputs specially
                newRow.querySelectorAll('.file-list').forEach(list => {
                    list.innerHTML = '';
                });

                // Insert after the target row
                if (contextMenuTarget.nextSibling) {
                    tbody.insertBefore(newRow, contextMenuTarget.nextSibling);
                } else {
                    tbody.appendChild(newRow);
                }

                // Re-attach context menu and other handlers
                attachContextMenuToTables();
                reattachRowHandlers(newRow);

                hideContextMenu();
                showNotification('Ligne dupliqu√©e', 'success');
                triggerAutoSave();
            };

            window.contextMenuDeleteRow = function () {
                if (!contextMenuTarget || !contextMenuTable) return;

                const tbody = contextMenuTable.querySelector('tbody');
                const rowCount = tbody.querySelectorAll('tr').length;

                // Don't delete if it's the last row
                if (rowCount <= 1) {
                    hideContextMenu();
                    showNotification('Impossible de supprimer la derni√®re ligne', 'error');
                    return;
                }

                // Confirm deletion
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ligne ?')) {
                    contextMenuTarget.remove();
                    hideContextMenu();
                    showNotification('Ligne supprim√©e', 'success');
                    triggerAutoSave();
                } else {
                    hideContextMenu();
                }
            };

            // Helper function to clear inputs in a row
            function clearRowInputs(row) {
                row.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.type === 'file') {
                        // Can't clear file inputs, they'll be empty anyway
                    } else {
                        input.value = '';
                    }
                });
                // Clear file lists
                row.querySelectorAll('.file-list').forEach(list => {
                    list.innerHTML = '';
                });
                // Remove context menu attached flag so it gets reattached
                row.removeAttribute('data-context-menu-attached');
            }

            // Helper function to reattach handlers to a new row
            function reattachRowHandlers(row) {
                // Reattach file upload handlers
                row.querySelectorAll('.upload-btn').forEach(btn => {
                    const fileInput = btn.closest('.upload-wrapper')?.querySelector('.file-input');
                    if (fileInput) {
                        btn.onclick = function () {
                            fileInput.click();
                        };
                    }
                });

                // Reattach view button handlers
                row.querySelectorAll('.view-btn').forEach(btn => {
                    btn.onclick = function () {
                        const fileList = this.closest('.upload-wrapper')?.querySelector('.file-list');
                        if (fileList && fileList.children.length > 0) {
                            // Trigger click on first file
                            const firstFile = fileList.querySelector('.file-name');
                            if (firstFile) firstFile.click();
                        } else {
                            showNotification('Aucun fichier joint', 'info');
                        }
                    };
                });
            }

            // Helper function to show notification
            function showNotification(message, type) {
                // Use existing notification system if available
                if (typeof showToast === 'function') {
                    showToast(message, type);
                } else {
                    // Create a simple notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10001;
                    animation: slideIn 0.3s ease-out;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                `;
                    notification.textContent = message;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                }
            }

            // Helper function to trigger auto-save
            function triggerAutoSave() {
                if (typeof saveFormData === 'function') {
                    saveFormData();
                }
            }
        })();
    </script>

    <!-- GitHub Integration Script -->
    <script>
        // GitHub Repository Configuration
        const GITHUB_CONFIG = {
            owner: 'ouss-AGC',
            repo: 'prad-documents',
            branch: 'main',
            baseUrl: 'https://raw.githubusercontent.com/ouss-AGC/prad-documents/main/'
        };

        // List of files - now dynamically updated
        let GITHUB_FILES = [];

        async function syncGitHubFiles() {
            const listElement = document.getElementById('githubFilesList');
            const selectorList = document.getElementById('githubFileSelectorList');
            const countElements = document.querySelectorAll('.github-files-count');
            const refreshButtons = document.querySelectorAll('.github-refresh-btn');

            // Show loading state
            if (listElement) listElement.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;"><span class="github-spinner"></span> Synchronisation en cours...</div>';
            if (selectorList) selectorList.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;"><span class="github-spinner"></span> Chargement...</div>';

            refreshButtons.forEach(btn => btn.classList.add('syncing'));

            try {
                const token = localStorage.getItem('prad_github_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/`, { headers });

                if (!response.ok) {
                    throw new Error(`Erreur GitHub: ${response.status}`);
                }

                const data = await response.json();

                // Filter and map files
                GITHUB_FILES = data
                    .filter(item => item.type === 'file')
                    .map(item => ({
                        name: item.name,
                        size: formatFileSize(item.size),
                        type: item.name.split('.').pop().toLowerCase(),
                        download_url: item.download_url
                    }));

                // Update UI
                updateGitHubUI();

                countElements.forEach(el => el.textContent = `${GITHUB_FILES.length} fichiers synchronis√©s`);
                showNotification('GitHub synchronis√© avec succ√®s', 'success');
            } catch (error) {
                console.error('GitHub Sync Error:', error);
                if (listElement) listElement.innerHTML = `<div style="padding: 40px; text-align: center; color: #dc3545;">‚ùå Erreur: ${error.message}</div>`;
                showNotification('√âchec de la synchronisation GitHub', 'error');
            } finally {
                refreshButtons.forEach(btn => btn.classList.remove('syncing'));
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateGitHubUI() {
            const listElement = document.getElementById('githubFilesList');
            const selectorList = document.getElementById('githubFileSelectorList');

            const fileItemsHtml = GITHUB_FILES.map((file, index) => `
            <div class="github-file-item">
                <div class="github-file-icon">${getFileIcon(file.type)}</div>
                <div class="github-file-info">
                    <div class="github-file-name" title="${file.name}">${file.name}</div>
                    <div class="github-file-size">${file.size}</div>
                </div>
                <div class="github-file-actions">
                    <button class="github-btn-view" onclick="viewGitHubFile('${escapeFileName(file.name)}')" title="Voir">üëÅ Voir</button>
                    <button class="github-btn-download" onclick="downloadGitHubFile('${escapeFileName(file.name)}')" title="T√©l√©charger">‚¨áÔ∏è T√©l√©charger</button>
                </div>
            </div>
        `).join('');

            const selectorItemsHtml = GITHUB_FILES.map((file, index) => `
            <div class="github-file-item github-file-selectable" data-filename="${escapeFileName(file.name)}" onclick="selectGitHubFile('${escapeFileName(file.name)}')">
                <div class="github-file-icon">${getFileIcon(file.type)}</div>
                <div class="github-file-info">
                    <div class="github-file-name">${file.name}</div>
                    <div class="github-file-size">${file.size}</div>
                </div>
                <div class="github-file-select-btn">
                    <button class="github-btn-select">‚úì S√©lectionner</button>
                </div>
            </div>
        `).join('');

            if (listElement) listElement.innerHTML = fileItemsHtml || '<div style="padding: 40px; text-align: center; color: #666;">Aucun fichier trouv√©</div>';
            if (selectorList) selectorList.innerHTML = selectorItemsHtml || '<div style="padding: 40px; text-align: center; color: #666;">Aucun fichier trouv√©</div>';
        }

        function getGitHubFileUrl(filename) {
            return GITHUB_CONFIG.baseUrl + encodeURIComponent(filename);
        }

        function downloadGitHubFile(filename) {
            const url = getGitHubFileUrl(filename);
            window.open(url, '_blank');
        }

        function getFileIcon(type) {
            const icons = { 'pdf': 'üìÑ', 'xlsx': 'üìä', 'xls': 'üìä', 'pptx': 'üìΩÔ∏è', 'ppt': 'üìΩÔ∏è', 'docx': 'üìù', 'doc': 'üìù', 'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è' };
            return icons[type] || 'üìÅ';
        }

        function escapeFileName(filename) {
            return filename.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function createGitHubFilesBrowser() {
            const modal = document.createElement('div');
            modal.id = 'githubFilesModal';
            modal.className = 'github-modal';
            modal.innerHTML = `
            <div class="github-modal-content">
                <div class="github-modal-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3>üìÅ Documents du Projet PRAD (GitHub)</h3>
                        <button class="github-refresh-btn" onclick="syncGitHubFiles()" title="Synchroniser avec GitHub">üîÑ Sync</button>
                    </div>
                    <button class="github-modal-close" onclick="closeGitHubFilesModal()">&times;</button>
                </div>
                <div class="github-modal-body">
                    <div class="github-files-list" id="githubFilesList">
                        ${GITHUB_FILES.map((file, index) => `
                            <div class="github-file-item" data-index="${index}">
                                <div class="github-file-icon">${getFileIcon(file.type)}</div>
                                <div class="github-file-info">
                                    <div class="github-file-name">${file.name}</div>
                                    <div class="github-file-size">${file.size}</div>
                                </div>
                                <div class="github-file-actions">
                                    <button class="github-btn-view" onclick="viewGitHubFile('${escapeFileName(file.name)}')" title="Voir">üëÅ Voir</button>
                                    <button class="github-btn-download" onclick="downloadGitHubFile('${escapeFileName(file.name)}')" title="T√©l√©charger">‚¨áÔ∏è T√©l√©charger</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="github-modal-footer">
                    <span class="github-files-count">${GITHUB_FILES.length} fichiers disponibles</span>
                    <a href="https://github.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}" target="_blank" class="github-repo-link">Voir sur GitHub ‚Üó</a>
                </div>
            </div>
        `;
            document.body.appendChild(modal);
        }

        function openGitHubFilesModal() {
            const modal = document.getElementById('githubFilesModal');
            if (modal) {
                modal.classList.add('show');
                syncGitHubFiles(); // Auto-sync when opening
            }
        }

        function closeGitHubFilesModal() {
            const modal = document.getElementById('githubFilesModal');
            if (modal) modal.classList.remove('show');
        }

        function viewGitHubFile(filename) {
            const url = getGitHubFileUrl(filename);
            // Open all files directly in a new tab for better compatibility
            window.open(url, '_blank');
        }

        function showGitHubPdfViewer(filename, url) {
            let viewer = document.getElementById('githubPdfViewer');
            if (!viewer) {
                viewer = document.createElement('div');
                viewer.id = 'githubPdfViewer';
                viewer.className = 'github-pdf-viewer';
                viewer.innerHTML = `
                <div class="github-pdf-header">
                    <span class="github-pdf-title"></span>
                    <div class="github-pdf-controls">
                        <button onclick="window.open(document.getElementById('githubPdfFrame').src, '_blank')" title="Ouvrir dans un nouvel onglet">üîó Nouvel onglet</button>
                        <button onclick="closeGitHubPdfViewer()" title="Fermer">‚úï Fermer</button>
                    </div>
                </div>
                <iframe id="githubPdfFrame" class="github-pdf-frame"></iframe>
            `;
                document.body.appendChild(viewer);
            }
            viewer.querySelector('.github-pdf-title').textContent = filename;
            document.getElementById('githubPdfFrame').src = url;
            viewer.classList.add('show');
        }

        function closeGitHubPdfViewer() {
            const viewer = document.getElementById('githubPdfViewer');
            if (viewer) {
                viewer.classList.remove('show');
                document.getElementById('githubPdfFrame').src = '';
            }
        }

        // Add GitHub styles
        const githubStyles = document.createElement('style');
        githubStyles.textContent = `
        .github-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .github-modal.show { display: flex; }
        .github-modal-content { background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .github-modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #24292e 0%, #40484f 100%); color: white; border-radius: 12px 12px 0 0; }
        .github-modal-header h3 { margin: 0; font-size: 1.2rem; }
        .github-modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px 10px; border-radius: 5px; }
        .github-modal-close:hover { background: rgba(255,255,255,0.2); }
        .github-modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .github-files-list { display: flex; flex-direction: column; }
        .github-file-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .github-file-item:hover { background: #f5f9ff; }
        .github-file-icon { font-size: 1.5rem; margin-right: 15px; }
        .github-file-info { flex: 1; }
        .github-file-name { font-weight: 500; color: #333; word-break: break-word; }
        .github-file-size { font-size: 0.85rem; color: #666; margin-top: 3px; }
        .github-file-actions { display: flex; gap: 8px; }
        .github-file-actions button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .github-btn-view { background: #e3f2fd; color: #1976d2; }
        .github-btn-view:hover { background: #bbdefb; }
        .github-btn-download { background: #e8f5e9; color: #388e3c; }
        .github-btn-download:hover { background: #c8e6c9; }
        .github-modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; border-radius: 0 0 12px 12px; }
        .github-files-count { color: #666; font-size: 0.9rem; }
        .github-repo-link { color: #1976d2; text-decoration: none; font-size: 0.9rem; }
        .github-repo-link:hover { text-decoration: underline; }
        .github-pdf-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; z-index: 10001; }
        .github-pdf-viewer.show { display: flex; }
        .github-pdf-header { padding: 15px 20px; background: #24292e; color: white; display: flex; justify-content: space-between; align-items: center; }
        .github-pdf-title { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
        .github-pdf-controls { display: flex; gap: 10px; }
        .github-pdf-controls button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        .github-pdf-controls button:hover { background: rgba(255,255,255,0.3); }
        .github-pdf-frame { flex: 1; border: none; background: white; }
    `;
        document.head.appendChild(githubStyles);

        // Storage for GitHub file associations (field ID -> GitHub filename)
        const githubFileAssociations = new Map();

        // Load saved GitHub file associations from localStorage
        const savedAssociations = localStorage.getItem('githubFileAssociations');
        if (savedAssociations) {
            try {
                const associationsObj = JSON.parse(savedAssociations);
                Object.keys(associationsObj).forEach(key => {
                    githubFileAssociations.set(key, associationsObj[key]);
                });
            } catch (e) {
                console.error('Failed to load GitHub file associations:', e);
            }
        }

        // Helper function to save GitHub associations to localStorage
        function saveGitHubAssociations() {
            const associationsObj = {};
            githubFileAssociations.forEach((value, key) => {
                associationsObj[key] = value;
            });
            localStorage.setItem('githubFileAssociations', JSON.stringify(associationsObj));
        }

        // Helper to escape filenames for use in HTML attributes
        function escapeFileName(filename) {
            return filename.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // Restore GitHub file associations UI on page load
        function loadGitHubAssociations() {
            githubFileAssociations.forEach((filenames, storageKey) => {
                const fileInput = document.getElementById(storageKey);
                if (!fileInput) return;

                const fileList = fileInput.closest('.upload-wrapper')?.querySelector('.file-list');
                if (!fileList) return;

                // Rebuild the file list UI for each associated file
                filenames.forEach(filename => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item github-linked-file';
                    fileItem.innerHTML = `
                        <span class="file-name github-file-link" title="${filename}" onclick="viewGitHubFile('${escapeFileName(filename)}')">
                            <span style="color: #28a745;">üìÅ</span> ${filename}
                        </span>
                        <span class="file-remove" onclick="removeGitHubFileAssociation(this, '${storageKey}', '${escapeFileName(filename)}')">√ó</span>
                    `;
                    fileList.appendChild(fileItem);
                });
            });
        }

        let currentSelectionTarget = null; // The upload-wrapper being targeted for file selection

        // Create GitHub file selector modal (for selecting files to attach)
        function createGitHubFileSelector() {
            const modal = document.createElement('div');
            modal.id = 'githubFileSelectorModal';
            modal.className = 'github-modal';
            modal.innerHTML = `
            <div class="github-modal-content">
                <div class="github-modal-header" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3>üìé S√©lectionner un Document GitHub</h3>
                        <button class="github-refresh-btn" onclick="syncGitHubFiles()" title="Synchroniser avec GitHub">üîÑ Sync</button>
                    </div>
                    <button class="github-modal-close" onclick="closeGitHubFileSelector()">&times;</button>
                </div>
                <div class="github-modal-body">
                    <div class="github-files-list" id="githubFileSelectorList">
                        ${GITHUB_FILES.map((file, index) => `
                            <div class="github-file-item github-file-selectable" data-filename="${escapeFileName(file.name)}" onclick="selectGitHubFile('${escapeFileName(file.name)}')">
                                <div class="github-file-icon">${getFileIcon(file.type)}</div>
                                <div class="github-file-info">
                                    <div class="github-file-name">${file.name}</div>
                                    <div class="github-file-size">${file.size}</div>
                                </div>
                                <div class="github-file-select-btn">
                                    <button class="github-btn-select">‚úì S√©lectionner</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="github-modal-footer">
                    <span class="github-files-count">${GITHUB_FILES.length} fichiers disponibles</span>
                    <button onclick="closeGitHubFileSelector()" style="background: #6c757d; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer;">Annuler</button>
                </div>
            </div>
        `;
            document.body.appendChild(modal);
        }

        // Open file selector for a specific upload wrapper
        function openGitHubFileSelector(button) {
            currentSelectionTarget = button.closest('.upload-wrapper');
            const modal = document.getElementById('githubFileSelectorModal');
            if (modal) {
                modal.classList.add('show');
                syncGitHubFiles(); // Auto-sync when opening
            }
        }

        function closeGitHubFileSelector() {
            const modal = document.getElementById('githubFileSelectorModal');
            if (modal) modal.classList.remove('show');
            currentSelectionTarget = null;
        }

        // Select a GitHub file and associate it with the current field
        function selectGitHubFile(filename) {
            if (!currentSelectionTarget) return;

            const fileInput = currentSelectionTarget.querySelector('.file-input');
            const fileList = currentSelectionTarget.querySelector('.file-list');
            const storageKey = fileInput.id || 'github_' + Math.random().toString(36).substr(2, 9);
            fileInput.id = storageKey;

            // Store the association
            if (!githubFileAssociations.has(storageKey)) {
                githubFileAssociations.set(storageKey, []);
            }
            const associations = githubFileAssociations.get(storageKey);

            // Check if file is already associated
            if (!associations.includes(filename)) {
                associations.push(filename);

                // Add file item to the list
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item github-linked-file';
                fileItem.innerHTML = `
                <span class="file-name github-file-link" title="${filename}" onclick="viewGitHubFile('${escapeFileName(filename)}')">
                    <span style="color: #28a745;">üìÅ</span> ${filename}
                </span>
                <span class="file-remove" onclick="removeGitHubFileAssociation(this, '${storageKey}', '${escapeFileName(filename)}')">√ó</span>
            `;
                fileList.appendChild(fileItem);

                // Save associations to localStorage
                saveGitHubAssociations();

                showNotification('Document GitHub li√©: ' + filename, 'success');
            } else {
                showNotification('Ce document est d√©j√† li√©', 'info');
            }

            closeGitHubFileSelector();
        }

        // Remove a GitHub file association
        function removeGitHubFileAssociation(element, storageKey, filename) {
            const associations = githubFileAssociations.get(storageKey);
            if (associations) {
                const index = associations.indexOf(filename);
                if (index > -1) {
                    associations.splice(index, 1);
                }
            }
            element.parentElement.remove();
            saveGitHubAssociations();
            showNotification('Lien supprim√©', 'info');
        }

        // View files associated with a field (opens GitHub files)
        function viewGitHubLinkedFiles(button) {
            const wrapper = button.closest('.upload-wrapper');
            const fileInput = wrapper.querySelector('.file-input');
            const storageKey = fileInput.id;
            const associations = githubFileAssociations.get(storageKey) || [];

            if (associations.length === 0) {
                showNotification('Aucun document GitHub li√©. Utilisez "Joindre" pour lier un document.', 'info');
                return;
            }

            if (associations.length === 1) {
                // Open single file directly
                viewGitHubFile(associations[0]);
            } else {
                // Show list of associated files
                showGitHubLinkedFilesModal(associations);
            }
        }

        // Show modal with list of linked files
        function showGitHubLinkedFilesModal(files) {
            let modal = document.getElementById('githubLinkedFilesModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'githubLinkedFilesModal';
                modal.className = 'github-modal';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
            <div class="github-modal-content" style="max-width: 600px;">
                <div class="github-modal-header">
                    <h3>üìé Documents Li√©s</h3>
                    <button class="github-modal-close" onclick="document.getElementById('githubLinkedFilesModal').classList.remove('show')">&times;</button>
                </div>
                <div class="github-modal-body">
                    <div class="github-files-list">
                        ${files.map(filename => {
                const file = GITHUB_FILES.find(f => f.name === filename) || { type: 'pdf', size: '' };
                return `
                                <div class="github-file-item">
                                    <div class="github-file-icon">${getFileIcon(file.type)}</div>
                                    <div class="github-file-info">
                                        <div class="github-file-name" title="${filename}">${filename}</div>
                                        <div class="github-file-size">${file.size}</div>
                                    </div>
                                    <div class="github-file-actions">
                                        <button class="github-btn-view" onclick="viewGitHubFile('${escapeFileName(filename)}')">üëÅ Voir</button>
                                        <button class="github-btn-download" onclick="downloadGitHubFile('${escapeFileName(filename)}')">‚¨áÔ∏è T√©l√©charger</button>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            </div>
        `;
            modal.classList.add('show');
        }

        // Save GitHub associations to localStorage
        function saveGitHubAssociations() {
            const data = {};
            githubFileAssociations.forEach((files, key) => {
                if (files.length > 0) {
                    data[key] = files;
                }
            });
            localStorage.setItem('prad_github_associations', JSON.stringify(data));
        }

        // Load GitHub associations from localStorage
        function loadGitHubAssociations() {
            try {
                const data = JSON.parse(localStorage.getItem('prad_github_associations') || '{}');
                Object.entries(data).forEach(([key, files]) => {
                    githubFileAssociations.set(key, files);

                    // Update UI
                    const fileInput = document.getElementById(key);
                    if (fileInput) {
                        const wrapper = fileInput.closest('.upload-wrapper');
                        const fileList = wrapper?.querySelector('.file-list');
                        if (fileList) {
                            files.forEach(filename => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item github-linked-file';
                                fileItem.innerHTML = `
                                <span class="file-name github-file-link" title="${filename}" onclick="viewGitHubFile('${escapeFileName(filename)}')">
                                    <span style="color: #28a745;">üìÅ</span> ${filename}
                                </span>
                                <span class="file-remove" onclick="removeGitHubFileAssociation(this, '${key}', '${escapeFileName(filename)}')">√ó</span>
                            `;
                                fileList.appendChild(fileItem);
                            });
                        }
                    }
                });
            } catch (e) {
                console.error('Error loading GitHub associations:', e);
            }
        }

        // Override triggerUpload to open GitHub file selector instead
        const originalTriggerUpload = window.triggerUpload;
        window.triggerUpload = function (button) {
            openGitHubFileSelector(button);
        };

        // Override viewFiles to support both local and GitHub documents
        const originalViewFiles = window.viewFiles;
        window.viewFiles = function (button) {
            const wrapper = button.closest('.upload-wrapper');
            const fileInput = wrapper.querySelector('.file-input');
            const storageKey = fileInput.id;

            // Priority 1: GitHub Linked Files
            const associations = githubFileAssociations.get(storageKey) || [];
            if (associations.length > 0) {
                viewGitHubLinkedFiles(button);
                return;
            }

            // Priority 2: Local Storage Files
            const storedFiles = typeof fileStorage !== 'undefined' ? fileStorage.get(storageKey) : null;
            if (storedFiles && storedFiles.length > 0) {
                if (typeof originalViewFiles === 'function') {
                    originalViewFiles(button);
                }
                return;
            }

            // If neither exists
            showNotification('Aucun document joint √† visualiser.', 'info');
        };

        // Add styles for GitHub file selection
        const githubSelectorStyles = document.createElement('style');
        githubSelectorStyles.textContent = `
        .github-file-selectable { cursor: pointer; }
        .github-file-selectable:hover { background: #e8f5e9 !important; }
        .github-btn-select { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .github-btn-select:hover { background: #218838; }
        .github-linked-file .file-name { color: #28a745 !important; cursor: pointer; }
        .github-linked-file .file-name:hover { text-decoration: underline; }
        .github-file-link { display: flex; align-items: center; gap: 5px; }
        
        .github-refresh-btn { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.3); 
            color: white; 
            padding: 5px 12px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        .github-refresh-btn:hover { background: rgba(255,255,255,0.2); }
        .github-refresh-btn.syncing { animation: github-spin 1s linear infinite; }
        
        .github-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #24292e;
            animation: github-spin 1s linear infinite;
        }
        
        @keyframes github-spin {
            to { transform: rotate(360deg); }
        }
    `;
        document.head.appendChild(githubSelectorStyles);

        // Initialize GitHub integration on page load
        document.addEventListener('DOMContentLoaded', function () {
            createGitHubFilesBrowser();
            createGitHubFileSelector();
            setTimeout(loadGitHubAssociations, 500); // Load after other initializations
        });
        if (document.readyState !== 'loading') {
            createGitHubFilesBrowser();
            createGitHubFileSelector();
            setTimeout(loadGitHubAssociations, 500);
        }
    </script>
</body>

</html>